define("readium_shared_js/globals",["jquery","eventEmitter"],function(e,t){var n={version:function(){return"0.8.0"},Views:{ORIENTATION_LANDSCAPE:"orientation_landscape",ORIENTATION_PORTRAIT:"orientation_portrait"},Events:{READER_INITIALIZED:"ReaderInitialized",PAGINATION_CHANGED:"PaginationChanged",SETTINGS_APPLIED:"SettingsApplied",FXL_VIEW_RESIZED:"FXLViewResized",READER_VIEW_CREATED:"ReaderViewCreated",READER_VIEW_DESTROYED:"ReaderViewDestroyed",CONTENT_DOCUMENT_LOAD_START:"ContentDocumentLoadStart",CONTENT_DOCUMENT_LOADED:"ContentDocumentLoaded",CONTENT_DOCUMENT_UNLOADED:"ContentDocumentUnloaded",MEDIA_OVERLAY_STATUS_CHANGED:"MediaOverlayStatusChanged",MEDIA_OVERLAY_TTS_SPEAK:"MediaOverlayTTSSpeak",MEDIA_OVERLAY_TTS_STOP:"MediaOverlayTTSStop",PLUGINS_LOADED:"PluginsLoaded"},InternalEvents:{CURRENT_VIEW_PAGINATION_CHANGED:"CurrentViewPaginationChanged"},logEvent:function(e,t,n){}};return e.extend(n,new t),n}),navigator.epubReadingSystem={name:"",version:"0.0.0",layoutStyle:"paginated",hasFeature:function(e,t){return(!t||"1.0"===t)&&("dom-manipulation"===e||("layout-changes"===e||"touch-events"!==e&&("mouse-events"===e||("keyboard-events"===e||"spine-scripting"===e))))}},function(e,t){"function"==typeof define&&define.amd?define("es6-shim",t):"object"==typeof exports?module.exports=t():e.returnExports=t()}(this,function(){"use strict";var e,t=Function.call.bind(Function.apply),n=Function.call.bind(Function.call),r=Array.isArray,i=Object.keys,o=function(e){try{return e(),!1}catch(e){return!0}},a=function(e){try{return e()}catch(e){return!1}},s=function(e){return function(){return!t(e,this,arguments)}}(o),l=!!Object.defineProperty&&function(){return!o(function(){return Object.defineProperty({},"x",{get:function(){}})})}(),u="foo"===function(){}.name,c=Function.call.bind(Array.prototype.forEach),f=Function.call.bind(Array.prototype.reduce),d=Function.call.bind(Array.prototype.filter),h=Function.call.bind(Array.prototype.some),p=function(e,t,n,r){!r&&t in e||(l?Object.defineProperty(e,t,{configurable:!0,enumerable:!1,writable:!0,value:n}):e[t]=n)},g=function(e,t,n){c(i(t),function(r){var i=t[r];p(e,r,i,!!n)})},m=Function.call.bind(Object.prototype.toString),v="function"==typeof/abc/?function(e){return"function"==typeof e&&"[object Function]"===m(e)}:function(e){return"function"==typeof e},y={getter:function(e,t,n){if(!l)throw new TypeError("getters require true ES5 support");Object.defineProperty(e,t,{configurable:!0,enumerable:!1,get:n})},proxy:function(e,t,n){if(!l)throw new TypeError("getters require true ES5 support");var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,{configurable:r.configurable,enumerable:r.enumerable,get:function(){return e[t]},set:function(n){e[t]=n}})},redefine:function(e,t,n){if(l){var r=Object.getOwnPropertyDescriptor(e,t);r.value=n,Object.defineProperty(e,t,r)}else e[t]=n},defineByDescriptor:function(e,t,n){l?Object.defineProperty(e,t,n):"value"in n&&(e[t]=n.value)},preserveToString:function(e,t){t&&v(t.toString)&&p(e,"toString",t.toString.bind(t),!0)}},E=Object.create||function(e,t){var n=function(){};n.prototype=e;var r=new n;return void 0!==t&&i(t).forEach(function(e){y.defineByDescriptor(r,e,t[e])}),r},b=function(e,t){return!!Object.setPrototypeOf&&a(function(){var n=function t(n){var r=new e(n);return Object.setPrototypeOf(r,t.prototype),r};return Object.setPrototypeOf(n,e),n.prototype=E(e.prototype,{constructor:{value:n}}),t(n)})},I=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}(),T=I.isFinite,w=Function.call.bind(String.prototype.indexOf),S=Function.apply.bind(Array.prototype.indexOf),_=Function.call.bind(Array.prototype.concat),C=Function.call.bind(String.prototype.slice),O=Function.call.bind(Array.prototype.push),P=Function.apply.bind(Array.prototype.push),N=Function.call.bind(Array.prototype.join),R=Function.call.bind(Array.prototype.shift),D=Math.max,x=Math.min,A=Math.floor,M=Math.abs,F=Math.exp,L=Math.log,j=Math.sqrt,k=Function.call.bind(Object.prototype.hasOwnProperty),V=function(){},U=I.Map,B=U&&U.prototype.delete,G=U&&U.prototype.get,W=U&&U.prototype.has,H=U&&U.prototype.set,z=I.Symbol||{},q=z.species||"@@species",J=Number.isNaN||function(e){return e!==e},X=Number.isFinite||function(e){return"number"==typeof e&&T(e)},Y=v(Math.sign)?Math.sign:function(e){var t=Number(e);return 0===t?t:J(t)?t:t<0?-1:1},K=function(e){var t=Number(e);return t<-1||J(t)?NaN:0===t||t===1/0?t:-1===t?-1/0:1+t-1==0?t:t*(L(1+t)/(1+t-1))},$=function(e){return"[object Arguments]"===m(e)},Z=function(e){return null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==m(e)&&"[object Function]"===m(e.callee)},Q=$(arguments)?$:Z,ee={primitive:function(e){return null===e||"function"!=typeof e&&"object"!=typeof e},string:function(e){return"[object String]"===m(e)},regex:function(e){return"[object RegExp]"===m(e)},symbol:function(e){return"function"==typeof I.Symbol&&"symbol"==typeof e}},te=function(e,t,n){var r=e[t];p(e,t,n,!0),y.preserveToString(e[t],r)},ne="function"==typeof z&&"function"==typeof z.for&&ee.symbol(z()),re=ee.symbol(z.iterator)?z.iterator:"_es6-shim iterator_";I.Set&&"function"==typeof(new I.Set)["@@iterator"]&&(re="@@iterator"),I.Reflect||p(I,"Reflect",{},!0);var ie=I.Reflect,oe=String,ae="undefined"!=typeof document&&document?document.all:null,se=null==ae?function(e){return null==e}:function(e){return null==e&&e!==ae},le={Call:function(e,n){var r=arguments.length>2?arguments[2]:[];if(!le.IsCallable(e))throw new TypeError(e+" is not a function");return t(e,n,r)},RequireObjectCoercible:function(e,t){if(se(e))throw new TypeError(t||"Cannot call method on "+e);return e},TypeIsObject:function(e){return void 0!==e&&null!==e&&!0!==e&&!1!==e&&("function"==typeof e||"object"==typeof e||e===ae)},ToObject:function(e,t){return Object(le.RequireObjectCoercible(e,t))},IsCallable:v,IsConstructor:function(e){return le.IsCallable(e)},ToInt32:function(e){return le.ToNumber(e)>>0},ToUint32:function(e){return le.ToNumber(e)>>>0},ToNumber:function(e){if(ne&&"[object Symbol]"===m(e))throw new TypeError("Cannot convert a Symbol value to a number");return+e},ToInteger:function(e){var t=le.ToNumber(e);return J(t)?0:0!==t&&X(t)?(t>0?1:-1)*A(M(t)):t},ToLength:function(e){var t=le.ToInteger(e);return t<=0?0:t>Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:t},SameValue:function(e,t){return e===t?0!==e||1/e==1/t:J(e)&&J(t)},SameValueZero:function(e,t){return e===t||J(e)&&J(t)},IsIterable:function(e){return le.TypeIsObject(e)&&(void 0!==e[re]||Q(e))},GetIterator:function(t){if(Q(t))return new e(t,"value");var n=le.GetMethod(t,re);if(!le.IsCallable(n))throw new TypeError("value is not an iterable");var r=le.Call(n,t);if(!le.TypeIsObject(r))throw new TypeError("bad iterator");return r},GetMethod:function(e,t){var n=le.ToObject(e)[t];if(!se(n)){if(!le.IsCallable(n))throw new TypeError("Method not callable: "+t);return n}},IteratorComplete:function(e){return!!e.done},IteratorClose:function(e,t){var n=le.GetMethod(e,"return");if(void 0!==n){var r,i;try{r=le.Call(n,e)}catch(e){i=e}if(!t){if(i)throw i;if(!le.TypeIsObject(r))throw new TypeError("Iterator's return method returned a non-object.")}}},IteratorNext:function(e){var t=arguments.length>1?e.next(arguments[1]):e.next();if(!le.TypeIsObject(t))throw new TypeError("bad iterator");return t},IteratorStep:function(e){var t=le.IteratorNext(e);return!le.IteratorComplete(t)&&t},Construct:function(e,t,n,r){var i=void 0===n?e:n;if(!r&&ie.construct)return ie.construct(e,t,i);var o=i.prototype;le.TypeIsObject(o)||(o=Object.prototype);var a=E(o),s=le.Call(e,a,t);return le.TypeIsObject(s)?s:a},SpeciesConstructor:function(e,t){var n=e.constructor;if(void 0===n)return t;if(!le.TypeIsObject(n))throw new TypeError("Bad constructor");var r=n[q];if(se(r))return t;if(!le.IsConstructor(r))throw new TypeError("Bad @@species");return r},CreateHTML:function(e,t,n,r){var i=le.ToString(e),o="<"+t;if(""!==n){o+=" "+n+'="'+le.ToString(r).replace(/"/g,"&quot;")+'"'}return o+">"+i+"</"+t+">"},IsRegExp:function(e){if(!le.TypeIsObject(e))return!1;var t=e[z.match];return void 0!==t?!!t:ee.regex(e)},ToString:function(e){if(ne&&"[object Symbol]"===m(e))throw new TypeError("Cannot convert a Symbol value to a number");return oe(e)}};if(l&&ne){var ue=function(e){if(ee.symbol(z[e]))return z[e];var t=z.for("Symbol."+e);return Object.defineProperty(z,e,{configurable:!1,enumerable:!1,writable:!1,value:t}),t};if(!ee.symbol(z.search)){var ce=ue("search"),fe=String.prototype.search;p(RegExp.prototype,ce,function(e){return le.Call(fe,e,[this])});var de=function(e){var t=le.RequireObjectCoercible(this);if(!se(e)){var n=le.GetMethod(e,ce);if(void 0!==n)return le.Call(n,e,[t])}return le.Call(fe,t,[le.ToString(e)])};te(String.prototype,"search",de)}if(!ee.symbol(z.replace)){var he=ue("replace"),pe=String.prototype.replace;p(RegExp.prototype,he,function(e,t){return le.Call(pe,e,[this,t])});var ge=function(e,t){var n=le.RequireObjectCoercible(this);if(!se(e)){var r=le.GetMethod(e,he);if(void 0!==r)return le.Call(r,e,[n,t])}return le.Call(pe,n,[le.ToString(e),t])};te(String.prototype,"replace",ge)}if(!ee.symbol(z.split)){var me=ue("split"),ve=String.prototype.split;p(RegExp.prototype,me,function(e,t){return le.Call(ve,e,[this,t])});var ye=function(e,t){var n=le.RequireObjectCoercible(this);if(!se(e)){var r=le.GetMethod(e,me);if(void 0!==r)return le.Call(r,e,[n,t])}return le.Call(ve,n,[le.ToString(e),t])};te(String.prototype,"split",ye)}var Ee=ee.symbol(z.match),be=Ee&&function(){var e={};return e[z.match]=function(){return 42},42!=="a".match(e)}();if(!Ee||be){var Ie=ue("match"),Te=String.prototype.match;p(RegExp.prototype,Ie,function(e){return le.Call(Te,e,[this])});var we=function(e){var t=le.RequireObjectCoercible(this);if(!se(e)){var n=le.GetMethod(e,Ie);if(void 0!==n)return le.Call(n,e,[t])}return le.Call(Te,t,[le.ToString(e)])};te(String.prototype,"match",we)}}var Se=function(e,t,n){y.preserveToString(t,e),Object.setPrototypeOf&&Object.setPrototypeOf(e,t),l?c(Object.getOwnPropertyNames(e),function(r){r in V||n[r]||y.proxy(e,r,t)}):c(Object.keys(e),function(r){r in V||n[r]||(t[r]=e[r])}),t.prototype=e.prototype,y.redefine(e.prototype,"constructor",t)},_e=function(){return this},Ce=function(e){l&&!k(e,q)&&y.getter(e,q,_e)},Oe=function(e,t){var n=t||function(){return this};p(e,re,n),!e[re]&&ee.symbol(re)&&(e[re]=n)},Pe=function(e,t,n){l?Object.defineProperty(e,t,{configurable:!0,enumerable:!0,writable:!0,value:n}):e[t]=n},Ne=function(e,t,n){if(Pe(e,t,n),!le.SameValue(e[t],n))throw new TypeError("property is nonconfigurable")},Re=function(e,t,n,r){if(!le.TypeIsObject(e))throw new TypeError("Constructor requires `new`: "+t.name);var i=t.prototype;le.TypeIsObject(i)||(i=n);var o=E(i);for(var a in r)if(k(r,a)){var s=r[a];p(o,a,s,!0)}return o};if(String.fromCodePoint&&1!==String.fromCodePoint.length){var De=String.fromCodePoint;te(String,"fromCodePoint",function(e){return le.Call(De,this,arguments)})}var xe={fromCodePoint:function(e){for(var t,n=[],r=0,i=arguments.length;r<i;r++){if(t=Number(arguments[r]),!le.SameValue(t,le.ToInteger(t))||t<0||t>1114111)throw new RangeError("Invalid code point "+t);t<65536?O(n,String.fromCharCode(t)):(t-=65536,O(n,String.fromCharCode(55296+(t>>10))),O(n,String.fromCharCode(t%1024+56320)))}return N(n,"")},raw:function(e){var t=(arguments.length,le.ToObject(e,"bad template")),n=le.ToObject(t.raw,"bad raw value"),r=n.length,i=le.ToLength(r);if(i<=0)return"";for(var o,a,s,l,u=[],c=0;c<i&&(o=le.ToString(c),s=le.ToString(n[o]),O(u,s),!(c+1>=i));)a=c+1<arguments.length?arguments[c+1]:"",l=le.ToString(a),O(u,l),c+=1;return N(u,"")}};String.raw&&"xy"!==String.raw({raw:{0:"x",1:"y",length:2}})&&te(String,"raw",xe.raw),g(String,xe);var Ae=function e(t,n){if(n<1)return"";if(n%2)return e(t,n-1)+t;var r=e(t,n/2);return r+r},Me={repeat:function(e){var t=le.ToString(le.RequireObjectCoercible(this)),n=le.ToInteger(e);if(n<0||n>=1/0)throw new RangeError("repeat count must be less than infinity and not overflow maximum string size");return Ae(t,n)},startsWith:function(e){var t=le.ToString(le.RequireObjectCoercible(this));if(le.IsRegExp(e))throw new TypeError('Cannot call method "startsWith" with a regex');var n,r=le.ToString(e);arguments.length>1&&(n=arguments[1]);var i=D(le.ToInteger(n),0);return C(t,i,i+r.length)===r},endsWith:function(e){var t=le.ToString(le.RequireObjectCoercible(this));if(le.IsRegExp(e))throw new TypeError('Cannot call method "endsWith" with a regex');var n,r=le.ToString(e),i=t.length;arguments.length>1&&(n=arguments[1]);var o=void 0===n?i:le.ToInteger(n),a=x(D(o,0),i);return C(t,a-r.length,a)===r},includes:function(e){if(le.IsRegExp(e))throw new TypeError('"includes" does not accept a RegExp');var t,n=le.ToString(e);return arguments.length>1&&(t=arguments[1]),-1!==w(this,n,t)},codePointAt:function(e){var t=le.ToString(le.RequireObjectCoercible(this)),n=le.ToInteger(e),r=t.length;if(n>=0&&n<r){var i=t.charCodeAt(n),o=n+1===r;if(i<55296||i>56319||o)return i;var a=t.charCodeAt(n+1);return a<56320||a>57343?i:1024*(i-55296)+(a-56320)+65536}}};if(String.prototype.includes&&!1!=="a".includes("a",1/0)&&te(String.prototype,"includes",Me.includes),String.prototype.startsWith&&String.prototype.endsWith){var Fe=o(function(){return"/a/".startsWith(/a/)}),Le=a(function(){return!1==="abc".startsWith("a",1/0)});Fe&&Le||(te(String.prototype,"startsWith",Me.startsWith),te(String.prototype,"endsWith",Me.endsWith))}if(ne){a(function(){var e=/a/;return e[z.match]=!1,"/a/".startsWith(e)})||te(String.prototype,"startsWith",Me.startsWith);a(function(){var e=/a/;return e[z.match]=!1,"/a/".endsWith(e)})||te(String.prototype,"endsWith",Me.endsWith);a(function(){var e=/a/;return e[z.match]=!1,"/a/".includes(e)})||te(String.prototype,"includes",Me.includes)}g(String.prototype,Me);var je=["\t\n\v\f\r   ᠎    ","         　\u2028","\u2029\ufeff"].join(""),ke=new RegExp("(^["+je+"]+)|(["+je+"]+$)","g"),Ve=function(){return le.ToString(le.RequireObjectCoercible(this)).replace(ke,"")},Ue=["","​","￾"].join(""),Be=new RegExp("["+Ue+"]","g"),Ge=/^[-+]0x[0-9a-f]+$/i,We=Ue.trim().length!==Ue.length;p(String.prototype,"trim",Ve,We);var He=function(e){return{value:e,done:0===arguments.length}},ze=function(e){le.RequireObjectCoercible(e),this._s=le.ToString(e),this._i=0};ze.prototype.next=function(){var e=this._s,t=this._i;if(void 0===e||t>=e.length)return this._s=void 0,He();var n,r,i=e.charCodeAt(t);return i<55296||i>56319||t+1===e.length?r=1:(n=e.charCodeAt(t+1),r=n<56320||n>57343?1:2),this._i=t+r,He(e.substr(t,r))},Oe(ze.prototype),Oe(String.prototype,function(){return new ze(this)});var qe={from:function(e){var t,r=this;arguments.length>1&&(t=arguments[1]);var i,o;if(void 0===t)i=!1;else{if(!le.IsCallable(t))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(o=arguments[2]),i=!0}var a,s,l,u=void 0!==(Q(e)||le.GetMethod(e,re));if(u){s=le.IsConstructor(r)?Object(new r):[];var c,f,d=le.GetIterator(e);for(l=0;;){if(!1===(c=le.IteratorStep(d)))break;f=c.value;try{i&&(f=void 0===o?t(f,l):n(t,o,f,l)),s[l]=f}catch(e){throw le.IteratorClose(d,!0),e}l+=1}a=l}else{var h=le.ToObject(e);a=le.ToLength(h.length),s=le.IsConstructor(r)?Object(new r(a)):new Array(a);var p;for(l=0;l<a;++l)p=h[l],i&&(p=void 0===o?t(p,l):n(t,o,p,l)),Ne(s,l,p)}return s.length=a,s},of:function(){for(var e=arguments.length,t=this,n=r(t)||!le.IsCallable(t)?new Array(e):le.Construct(t,[e]),i=0;i<e;++i)Ne(n,i,arguments[i]);return n.length=e,n}};g(Array,qe),Ce(Array),e=function(e,t){this.i=0,this.array=e,this.kind=t},g(e.prototype,{next:function(){var t=this.i,n=this.array;if(!(this instanceof e))throw new TypeError("Not an ArrayIterator");if(void 0!==n){if(t<le.ToLength(n.length)){var r,i=this.kind;return"key"===i?r=t:"value"===i?r=n[t]:"entry"===i&&(r=[t,n[t]]),this.i=t+1,He(r)}}return this.array=void 0,He()}}),Oe(e.prototype),Array.of===qe.of||function(){var e=function(e){this.length=e};e.prototype=[];var t=Array.of.apply(e,[1,2]);return t instanceof e&&2===t.length}()||te(Array,"of",qe.of);var Je={copyWithin:function(e,t){var n,r=le.ToObject(this),i=le.ToLength(r.length),o=le.ToInteger(e),a=le.ToInteger(t),s=o<0?D(i+o,0):x(o,i),l=a<0?D(i+a,0):x(a,i);arguments.length>2&&(n=arguments[2]);var u=void 0===n?i:le.ToInteger(n),c=u<0?D(i+u,0):x(u,i),f=x(c-l,i-s),d=1;for(l<s&&s<l+f&&(d=-1,l+=f-1,s+=f-1);f>0;)l in r?r[s]=r[l]:delete r[s],l+=d,s+=d,f-=1;return r},fill:function(e){var t;arguments.length>1&&(t=arguments[1]);var n;arguments.length>2&&(n=arguments[2]);var r=le.ToObject(this),i=le.ToLength(r.length);t=le.ToInteger(void 0===t?0:t),n=le.ToInteger(void 0===n?i:n);for(var o=t<0?D(i+t,0):x(t,i),a=n<0?i+n:n,s=o;s<i&&s<a;++s)r[s]=e;return r},find:function(e){var t=le.ToObject(this),r=le.ToLength(t.length);if(!le.IsCallable(e))throw new TypeError("Array#find: predicate must be a function");for(var i,o=arguments.length>1?arguments[1]:null,a=0;a<r;a++)if(i=t[a],o){if(n(e,o,i,a,t))return i}else if(e(i,a,t))return i},findIndex:function(e){var t=le.ToObject(this),r=le.ToLength(t.length);if(!le.IsCallable(e))throw new TypeError("Array#findIndex: predicate must be a function");for(var i=arguments.length>1?arguments[1]:null,o=0;o<r;o++)if(i){if(n(e,i,t[o],o,t))return o}else if(e(t[o],o,t))return o;return-1},keys:function(){return new e(this,"key")},values:function(){return new e(this,"value")},entries:function(){return new e(this,"entry")}};if(Array.prototype.keys&&!le.IsCallable([1].keys().next)&&delete Array.prototype.keys,Array.prototype.entries&&!le.IsCallable([1].entries().next)&&delete Array.prototype.entries,Array.prototype.keys&&Array.prototype.entries&&!Array.prototype.values&&Array.prototype[re]&&(g(Array.prototype,{values:Array.prototype[re]}),ee.symbol(z.unscopables)&&(Array.prototype[z.unscopables].values=!0)),u&&Array.prototype.values&&"values"!==Array.prototype.values.name){var Xe=Array.prototype.values;te(Array.prototype,"values",function(){return le.Call(Xe,this,arguments)}),p(Array.prototype,re,Array.prototype.values,!0)}g(Array.prototype,Je),1/[!0].indexOf(!0,-0)<0&&p(Array.prototype,"indexOf",function(e){var t=S(this,arguments);return 0===t&&1/t<0?0:t},!0),Oe(Array.prototype,function(){return this.values()}),Object.getPrototypeOf&&Oe(Object.getPrototypeOf([].values()));var Ye=function(){return a(function(){return 0===Array.from({length:-1}).length})}(),Ke=function(){var e=Array.from([0].entries());return 1===e.length&&r(e[0])&&0===e[0][0]&&0===e[0][1]}();if(Ye&&Ke||te(Array,"from",qe.from),!function(){return a(function(){return Array.from([0],void 0)})}()){var $e=Array.from;te(Array,"from",function(e){return arguments.length>1&&void 0!==arguments[1]?le.Call($e,this,arguments):n($e,this,e)})}var Ze=-(Math.pow(2,32)-1),Qe=function(e,t){var r={length:Ze};return r[t?(r.length>>>0)-1:0]=!0,a(function(){return n(e,r,function(){throw new RangeError("should not reach here")},[]),!0})};if(!Qe(Array.prototype.forEach)){var et=Array.prototype.forEach;te(Array.prototype,"forEach",function(e){return le.Call(et,this.length>=0?this:[],arguments)})}if(!Qe(Array.prototype.map)){var tt=Array.prototype.map;te(Array.prototype,"map",function(e){return le.Call(tt,this.length>=0?this:[],arguments)})}if(!Qe(Array.prototype.filter)){var nt=Array.prototype.filter;te(Array.prototype,"filter",function(e){return le.Call(nt,this.length>=0?this:[],arguments)})}if(!Qe(Array.prototype.some)){var rt=Array.prototype.some;te(Array.prototype,"some",function(e){return le.Call(rt,this.length>=0?this:[],arguments)})}if(!Qe(Array.prototype.every)){var it=Array.prototype.every;te(Array.prototype,"every",function(e){return le.Call(it,this.length>=0?this:[],arguments)})}if(!Qe(Array.prototype.reduce)){var ot=Array.prototype.reduce;te(Array.prototype,"reduce",function(e){return le.Call(ot,this.length>=0?this:[],arguments)})}if(!Qe(Array.prototype.reduceRight,!0)){var at=Array.prototype.reduceRight;te(Array.prototype,"reduceRight",function(e){return le.Call(at,this.length>=0?this:[],arguments)})}var st=8!==Number("0o10"),lt=2!==Number("0b10"),ut=h(Ue,function(e){return 0===Number(e+0+e)});if(st||lt||ut){var ct=Number,ft=/^0b[01]+$/i,dt=/^0o[0-7]+$/i,ht=ft.test.bind(ft),pt=dt.test.bind(dt),gt=function(e,t){var n;if("function"==typeof e.valueOf&&(n=e.valueOf(),ee.primitive(n)))return n;if("function"==typeof e.toString&&(n=e.toString(),ee.primitive(n)))return n;throw new TypeError("No default value")},mt=Be.test.bind(Be),vt=Ge.test.bind(Ge),yt=function(){var e=function(t){var n;"string"==typeof(n=arguments.length>0?ee.primitive(t)?t:gt(t):0)&&(n=le.Call(Ve,n),ht(n)?n=parseInt(C(n,2),2):pt(n)?n=parseInt(C(n,2),8):(mt(n)||vt(n))&&(n=NaN));var r=this,i=a(function(){return ct.prototype.valueOf.call(r),!0});return r instanceof e&&!i?new ct(n):ct(n)};return e}();Se(ct,yt,{}),g(yt,{NaN:ct.NaN,MAX_VALUE:ct.MAX_VALUE,MIN_VALUE:ct.MIN_VALUE,NEGATIVE_INFINITY:ct.NEGATIVE_INFINITY,POSITIVE_INFINITY:ct.POSITIVE_INFINITY}),Number=yt,y.redefine(I,"Number",yt)}var Et=Math.pow(2,53)-1;g(Number,{MAX_SAFE_INTEGER:Et,MIN_SAFE_INTEGER:-Et,EPSILON:2.220446049250313e-16,parseInt:I.parseInt,parseFloat:I.parseFloat,isFinite:X,isInteger:function(e){return X(e)&&le.ToInteger(e)===e},isSafeInteger:function(e){return Number.isInteger(e)&&M(e)<=Number.MAX_SAFE_INTEGER},isNaN:J}),p(Number,"parseInt",I.parseInt,Number.parseInt!==I.parseInt),1===[,1].find(function(){return!0})&&te(Array.prototype,"find",Je.find),0!==[,1].findIndex(function(){return!0})&&te(Array.prototype,"findIndex",Je.findIndex);var bt=Function.bind.call(Function.bind,Object.prototype.propertyIsEnumerable),It=function(e,t){l&&bt(e,t)&&Object.defineProperty(e,t,{enumerable:!1})},Tt=function(){for(var e=Number(this),t=arguments.length,n=t-e,r=new Array(n<0?0:n),i=e;i<t;++i)r[i-e]=arguments[i];return r},wt=function(e){return function(t,n){return t[n]=e[n],t}},St=function(e,t){var n,r=i(Object(t));return le.IsCallable(Object.getOwnPropertySymbols)&&(n=d(Object.getOwnPropertySymbols(Object(t)),bt(t))),f(_(r,n||[]),wt(t),e)},_t={assign:function(e,t){var n=le.ToObject(e,"Cannot convert undefined or null to object");return f(le.Call(Tt,1,arguments),St,n)},is:function(e,t){return le.SameValue(e,t)}};if(Object.assign&&Object.preventExtensions&&function(){var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return"y"===e[1]}}()&&te(Object,"assign",_t.assign),g(Object,_t),l){var Ct={setPrototypeOf:function(e,t){var r,i=function(e,t){if(!le.TypeIsObject(e))throw new TypeError("cannot set prototype on a non-object");if(null!==t&&!le.TypeIsObject(t))throw new TypeError("can only set prototype to an object or null"+t)},o=function(e,t){return i(e,t),n(r,e,t),e};try{r=e.getOwnPropertyDescriptor(e.prototype,"__proto__").set,n(r,{},null)}catch(t){if(e.prototype!=={}.__proto__)return;r=function(e){this.__proto__=e},o.polyfill=o(o({},null),e.prototype)instanceof e}return o}(Object)};g(Object,Ct)}if(Object.setPrototypeOf&&Object.getPrototypeOf&&null!==Object.getPrototypeOf(Object.setPrototypeOf({},null))&&null===Object.getPrototypeOf(Object.create(null))&&function(){var e=Object.create(null),t=Object.getPrototypeOf,n=Object.setPrototypeOf;Object.getPrototypeOf=function(n){var r=t(n);return r===e?null:r},Object.setPrototypeOf=function(t,r){return n(t,null===r?e:r)},Object.setPrototypeOf.polyfill=!1}(),!!o(function(){return Object.keys("foo")})){var Ot=Object.keys;te(Object,"keys",function(e){return Ot(le.ToObject(e))}),i=Object.keys}if(o(function(){return Object.keys(/a/g)})){var Pt=Object.keys;te(Object,"keys",function(e){if(ee.regex(e)){var t=[];for(var n in e)k(e,n)&&O(t,n);return t}return Pt(e)}),i=Object.keys}if(Object.getOwnPropertyNames){if(!!o(function(){return Object.getOwnPropertyNames("foo")})){var Nt="object"==typeof window?Object.getOwnPropertyNames(window):[],Rt=Object.getOwnPropertyNames;te(Object,"getOwnPropertyNames",function(e){var t=le.ToObject(e);if("[object Window]"===m(t))try{return Rt(t)}catch(e){return _([],Nt)}return Rt(t)})}}if(Object.getOwnPropertyDescriptor){if(!!o(function(){return Object.getOwnPropertyDescriptor("foo","bar")})){var Dt=Object.getOwnPropertyDescriptor;te(Object,"getOwnPropertyDescriptor",function(e,t){return Dt(le.ToObject(e),t)})}}if(Object.seal){if(!!o(function(){return Object.seal("foo")})){var xt=Object.seal;te(Object,"seal",function(e){return le.TypeIsObject(e)?xt(e):e})}}if(Object.isSealed){if(!!o(function(){return Object.isSealed("foo")})){var At=Object.isSealed;te(Object,"isSealed",function(e){return!le.TypeIsObject(e)||At(e)})}}if(Object.freeze){if(!!o(function(){return Object.freeze("foo")})){var Mt=Object.freeze;te(Object,"freeze",function(e){return le.TypeIsObject(e)?Mt(e):e})}}if(Object.isFrozen){if(!!o(function(){return Object.isFrozen("foo")})){var Ft=Object.isFrozen;te(Object,"isFrozen",function(e){return!le.TypeIsObject(e)||Ft(e)})}}if(Object.preventExtensions){if(!!o(function(){return Object.preventExtensions("foo")})){var Lt=Object.preventExtensions;te(Object,"preventExtensions",function(e){return le.TypeIsObject(e)?Lt(e):e})}}if(Object.isExtensible){if(!!o(function(){return Object.isExtensible("foo")})){var jt=Object.isExtensible;te(Object,"isExtensible",function(e){return!!le.TypeIsObject(e)&&jt(e)})}}if(Object.getPrototypeOf){if(!!o(function(){return Object.getPrototypeOf("foo")})){var kt=Object.getPrototypeOf;te(Object,"getPrototypeOf",function(e){return kt(le.ToObject(e))})}}var Vt=l&&function(){var e=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags");return e&&le.IsCallable(e.get)}();if(l&&!Vt){var Ut=function(){if(!le.TypeIsObject(this))throw new TypeError("Method called on incompatible type: must be an object.");var e="";return this.global&&(e+="g"),this.ignoreCase&&(e+="i"),this.multiline&&(e+="m"),this.unicode&&(e+="u"),this.sticky&&(e+="y"),e};y.getter(RegExp.prototype,"flags",Ut)}var Bt=l&&a(function(){return"/a/i"===String(new RegExp(/a/g,"i"))}),Gt=ne&&l&&function(){var e=/./;return e[z.match]=!1,RegExp(e)===e}(),Wt=a(function(){return"/abc/"===RegExp.prototype.toString.call({source:"abc"})}),Ht=Wt&&a(function(){return"/a/b"===RegExp.prototype.toString.call({source:"a",flags:"b"})});if(!Wt||!Ht){var zt=RegExp.prototype.toString;p(RegExp.prototype,"toString",function(){var e=le.RequireObjectCoercible(this);return ee.regex(e)?n(zt,e):"/"+oe(e.source)+"/"+oe(e.flags)},!0),y.preserveToString(RegExp.prototype.toString,zt)}if(l&&(!Bt||Gt)){var qt=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags").get,Jt=Object.getOwnPropertyDescriptor(RegExp.prototype,"source")||{},Xt=function(){return this.source},Yt=le.IsCallable(Jt.get)?Jt.get:Xt,Kt=RegExp,$t=function(){return function e(t,n){var r=le.IsRegExp(t);if(!(this instanceof e)&&r&&void 0===n&&t.constructor===e)return t;var i=t,o=n;return ee.regex(t)?(i=le.Call(Yt,t),o=void 0===n?le.Call(qt,t):n,new e(i,o)):(r&&(i=t.source,o=void 0===n?t.flags:n),new Kt(t,n))}}();Se(Kt,$t,{$input:!0}),RegExp=$t,y.redefine(I,"RegExp",$t)}if(l){var Zt={input:"$_",lastMatch:"$&",lastParen:"$+",leftContext:"$`",rightContext:"$'"};c(i(Zt),function(e){e in RegExp&&!(Zt[e]in RegExp)&&y.getter(RegExp,Zt[e],function(){return RegExp[e]})})}Ce(RegExp);var Qt=1/Number.EPSILON,en=function(e){return e+Qt-Qt},tn=Math.pow(2,-23),nn=Math.pow(2,127)*(2-tn),rn=Math.pow(2,-126),on=Math.E,an=Math.LOG2E,sn=Math.LOG10E,ln=Number.prototype.clz;delete Number.prototype.clz;var un={acosh:function(e){var t=Number(e);if(J(t)||e<1)return NaN;if(1===t)return 0;if(t===1/0)return t;var n=1/(t*t);if(t<2)return K(t-1+j(1-n)*t);var r=t/2;return K(r+j(1-n)*r-1)+1/an},asinh:function(e){var t=Number(e);if(0===t||!T(t))return t;var n=M(t),r=n*n,i=Y(t);return n<1?i*K(n+r/(j(r+1)+1)):i*(K(n/2+j(1+1/r)*n/2-1)+1/an)},atanh:function(e){var t=Number(e);if(0===t)return t;if(-1===t)return-1/0;if(1===t)return 1/0;if(J(t)||t<-1||t>1)return NaN;var n=M(t);return Y(t)*K(2*n/(1-n))/2},cbrt:function(e){var t=Number(e);if(0===t)return t;var n,r=t<0;return r&&(t=-t),t===1/0?n=1/0:(n=F(L(t)/3),n=(t/(n*n)+2*n)/3),r?-n:n},clz32:function(e){var t=Number(e),n=le.ToUint32(t);return 0===n?32:ln?le.Call(ln,n):31-A(L(n+.5)*an)},cosh:function(e){var t=Number(e);if(0===t)return 1;if(J(t))return NaN;if(!T(t))return 1/0;var n=F(M(t)-1);return(n+1/(n*on*on))*(on/2)},expm1:function(e){var t=Number(e);if(t===-1/0)return-1;if(!T(t)||0===t)return t;if(M(t)>.5)return F(t)-1;for(var n=t,r=0,i=1;r+n!==r;)r+=n,i+=1,n*=t/i;return r},hypot:function(e,t){for(var n=0,r=0,i=0;i<arguments.length;++i){var o=M(Number(arguments[i]));r<o?(n*=r/o*(r/o),n+=1,r=o):n+=o>0?o/r*(o/r):o}return r===1/0?1/0:r*j(n)},log2:function(e){return L(e)*an},log10:function(e){return L(e)*sn},log1p:K,sign:Y,sinh:function(e){var t=Number(e);if(!T(t)||0===t)return t;var n=M(t);if(n<1){var r=Math.expm1(n);return Y(t)*r*(1+1/(r+1))/2}var i=F(n-1);return Y(t)*(i-1/(i*on*on))*(on/2)},tanh:function(e){var t=Number(e);return J(t)||0===t?t:t>=20?1:t<=-20?-1:(Math.expm1(t)-Math.expm1(-t))/(F(t)+F(-t))},trunc:function(e){var t=Number(e);return t<0?-A(-t):A(t)},imul:function(e,t){var n=le.ToUint32(e),r=le.ToUint32(t),i=n>>>16&65535,o=65535&n,a=r>>>16&65535,s=65535&r;return o*s+(i*s+o*a<<16>>>0)|0},fround:function(e){var t=Number(e);if(0===t||t===1/0||t===-1/0||J(t))return t;var n=Y(t),r=M(t);if(r<rn)return n*en(r/rn/tn)*rn*tn;var i=(1+tn/Number.EPSILON)*r,o=i-(i-r);return o>nn||J(o)?n*(1/0):n*o}},cn=function(e,t,n){return M(1-e/t)/Number.EPSILON<(n||8)};g(Math,un),p(Math,"sinh",un.sinh,Math.sinh(710)===1/0),p(Math,"cosh",un.cosh,Math.cosh(710)===1/0),p(Math,"log1p",un.log1p,-1e-17!==Math.log1p(-1e-17)),p(Math,"asinh",un.asinh,Math.asinh(-1e7)!==-Math.asinh(1e7)),p(Math,"asinh",un.asinh,Math.asinh(1e300)===1/0),p(Math,"atanh",un.atanh,0===Math.atanh(1e-300)),p(Math,"tanh",un.tanh,-2e-17!==Math.tanh(-2e-17)),p(Math,"acosh",un.acosh,Math.acosh(Number.MAX_VALUE)===1/0),p(Math,"acosh",un.acosh,!cn(Math.acosh(1+Number.EPSILON),Math.sqrt(2*Number.EPSILON))),p(Math,"cbrt",un.cbrt,!cn(Math.cbrt(1e-300),1e-100)),p(Math,"sinh",un.sinh,-2e-17!==Math.sinh(-2e-17));var fn=Math.expm1(10);p(Math,"expm1",un.expm1,fn>22025.465794806718||fn<22025.465794806718),p(Math,"hypot",un.hypot,Math.hypot(1/0,NaN)!==1/0);var dn=Math.round,hn=0===Math.round(.5-Number.EPSILON/4)&&1===Math.round(Number.EPSILON/3.99-.5),pn=Qt+1,gn=2*Qt-1,mn=[pn,gn].every(function(e){return Math.round(e)===e});p(Math,"round",function(e){var t=A(e),n=-1===t?-0:t+1;return e-t<.5?t:n},!hn||!mn),y.preserveToString(Math.round,dn);var vn=Math.imul;-5!==Math.imul(4294967295,5)&&(Math.imul=un.imul,y.preserveToString(Math.imul,vn)),2!==Math.imul.length&&te(Math,"imul",function(e,t){return le.Call(vn,Math,arguments)});var yn=function(){var e=I.setTimeout;if("function"==typeof e||"object"==typeof e){le.IsPromise=function(e){return!!le.TypeIsObject(e)&&void 0!==e._promise};var t,r=function(e){if(!le.IsConstructor(e))throw new TypeError("Bad promise constructor");var t=this,n=function(e,n){if(void 0!==t.resolve||void 0!==t.reject)throw new TypeError("Bad Promise implementation!");t.resolve=e,t.reject=n};if(t.resolve=void 0,t.reject=void 0,t.promise=new e(n),!le.IsCallable(t.resolve)||!le.IsCallable(t.reject))throw new TypeError("Bad promise constructor")};"undefined"!=typeof window&&le.IsCallable(window.postMessage)&&(t=function(){var e=[],t=function(t){O(e,t),window.postMessage("zero-timeout-message","*")},n=function(t){if(t.source===window&&"zero-timeout-message"===t.data){if(t.stopPropagation(),0===e.length)return;R(e)()}};return window.addEventListener("message",n,!0),t});var i,o,a=le.IsCallable(I.setImmediate)?I.setImmediate:"object"==typeof process&&process.nextTick?process.nextTick:function(){var e=I.Promise,t=e&&e.resolve&&e.resolve();return t&&function(e){return t.then(e)}}()||(le.IsCallable(t)?t():function(t){e(t,0)}),s=function(e){return e},l=function(e){throw e},u={},c=function(e,t,n){a(function(){f(e,t,n)})},f=function(e,t,n){var r,i
;if(t===u)return e(n);try{r=e(n),i=t.resolve}catch(e){r=e,i=t.reject}i(r)},d=function(e,t){var n=e._promise,r=n.reactionLength;if(r>0&&(c(n.fulfillReactionHandler0,n.reactionCapability0,t),n.fulfillReactionHandler0=void 0,n.rejectReactions0=void 0,n.reactionCapability0=void 0,r>1))for(var i=1,o=0;i<r;i++,o+=3)c(n[o+0],n[o+2],t),e[o+0]=void 0,e[o+1]=void 0,e[o+2]=void 0;n.result=t,n.state=1,n.reactionLength=0},h=function(e,t){var n=e._promise,r=n.reactionLength;if(r>0&&(c(n.rejectReactionHandler0,n.reactionCapability0,t),n.fulfillReactionHandler0=void 0,n.rejectReactions0=void 0,n.reactionCapability0=void 0,r>1))for(var i=1,o=0;i<r;i++,o+=3)c(n[o+1],n[o+2],t),e[o+0]=void 0,e[o+1]=void 0,e[o+2]=void 0;n.result=t,n.state=2,n.reactionLength=0},p=function(e){var t=!1;return{resolve:function(n){var r;if(!t){if(t=!0,n===e)return h(e,new TypeError("Self resolution"));if(!le.TypeIsObject(n))return d(e,n);try{r=n.then}catch(t){return h(e,t)}if(!le.IsCallable(r))return d(e,n);a(function(){v(e,n,r)})}},reject:function(n){if(!t)return t=!0,h(e,n)}}},m=function(e,t,r,i){e===o?n(e,t,r,i,u):n(e,t,r,i)},v=function(e,t,n){var r=p(e),i=r.resolve,o=r.reject;try{m(n,t,i,o)}catch(e){o(e)}},y=function(){var e=function(t){if(!(this instanceof e))throw new TypeError('Constructor Promise requires "new"');if(this&&this._promise)throw new TypeError("Bad construction");if(!le.IsCallable(t))throw new TypeError("not a valid resolver");var n=Re(this,e,i,{_promise:{result:void 0,state:0,reactionLength:0,fulfillReactionHandler0:void 0,rejectReactionHandler0:void 0,reactionCapability0:void 0}}),r=p(n),o=r.reject;try{t(r.resolve,o)}catch(e){o(e)}return n};return e}();i=y.prototype;var E=function(e,t,n,r){var i=!1;return function(o){if(!i&&(i=!0,t[e]=o,0==--r.count)){(0,n.resolve)(t)}}},b=function(e,t,n){for(var r,i,o=e.iterator,a=[],s={count:1},l=0;;){try{if(!1===(r=le.IteratorStep(o))){e.done=!0;break}i=r.value}catch(t){throw e.done=!0,t}a[l]=void 0;var u=t.resolve(i),c=E(l,a,n,s);s.count+=1,m(u.then,u,c,n.reject),l+=1}if(0==--s.count){(0,n.resolve)(a)}return n.promise},T=function(e,t,n){for(var r,i,o,a=e.iterator;;){try{if(!1===(r=le.IteratorStep(a))){e.done=!0;break}i=r.value}catch(t){throw e.done=!0,t}o=t.resolve(i),m(o.then,o,n.resolve,n.reject)}return n.promise};return g(y,{all:function(e){var t=this;if(!le.TypeIsObject(t))throw new TypeError("Promise is not object");var n,i,o=new r(t);try{return n=le.GetIterator(e),i={iterator:n,done:!1},b(i,t,o)}catch(e){var a=e;if(i&&!i.done)try{le.IteratorClose(n,!0)}catch(e){a=e}var s=o.reject;return s(a),o.promise}},race:function(e){var t=this;if(!le.TypeIsObject(t))throw new TypeError("Promise is not object");var n,i,o=new r(t);try{return n=le.GetIterator(e),i={iterator:n,done:!1},T(i,t,o)}catch(e){var a=e;if(i&&!i.done)try{le.IteratorClose(n,!0)}catch(e){a=e}var s=o.reject;return s(a),o.promise}},reject:function(e){var t=this;if(!le.TypeIsObject(t))throw new TypeError("Bad promise constructor");var n=new r(t);return(0,n.reject)(e),n.promise},resolve:function(e){var t=this;if(!le.TypeIsObject(t))throw new TypeError("Bad promise constructor");if(le.IsPromise(e)){var n=e.constructor;if(n===t)return e}var i=new r(t);return(0,i.resolve)(e),i.promise}}),g(i,{catch:function(e){return this.then(null,e)},then:function(e,t){var n=this;if(!le.IsPromise(n))throw new TypeError("not a promise");var i,o=le.SpeciesConstructor(n,y);i=arguments.length>2&&arguments[2]===u&&o===y?u:new r(o);var a,f=le.IsCallable(e)?e:s,d=le.IsCallable(t)?t:l,h=n._promise;if(0===h.state){if(0===h.reactionLength)h.fulfillReactionHandler0=f,h.rejectReactionHandler0=d,h.reactionCapability0=i;else{var p=3*(h.reactionLength-1);h[p+0]=f,h[p+1]=d,h[p+2]=i}h.reactionLength+=1}else if(1===h.state)a=h.result,c(f,i,a);else{if(2!==h.state)throw new TypeError("unexpected Promise state");a=h.result,c(d,i,a)}return i.promise}}),u=new r(y),o=i.then,y}}();if(I.Promise&&(delete I.Promise.accept,delete I.Promise.defer,delete I.Promise.prototype.chain),"function"==typeof yn){g(I,{Promise:yn});var En=b(I.Promise,function(e){return e.resolve(42).then(function(){})instanceof e}),bn=!o(function(){return I.Promise.reject(42).then(null,5).then(null,V)}),In=o(function(){return I.Promise.call(3,V)}),Tn=function(e){var t=e.resolve(5);t.constructor={};var n=e.resolve(t);try{n.then(null,V).then(null,V)}catch(e){return!0}return t===n}(I.Promise),wn=l&&function(){var e=0,t=Object.defineProperty({},"then",{get:function(){e+=1}});return Promise.resolve(t),1===e}(),Sn=function e(t){var n=new Promise(t);t(3,function(){}),this.then=n.then,this.constructor=e};Sn.prototype=Promise.prototype,Sn.all=Promise.all;var _n=a(function(){return!!Sn.all([1,2])});if(En&&bn&&In&&!Tn&&wn&&!_n||(Promise=yn,te(I,"Promise",yn)),1!==Promise.all.length){var Cn=Promise.all;te(Promise,"all",function(e){return le.Call(Cn,this,arguments)})}if(1!==Promise.race.length){var On=Promise.race;te(Promise,"race",function(e){return le.Call(On,this,arguments)})}if(1!==Promise.resolve.length){var Pn=Promise.resolve;te(Promise,"resolve",function(e){return le.Call(Pn,this,arguments)})}if(1!==Promise.reject.length){var Nn=Promise.reject;te(Promise,"reject",function(e){return le.Call(Nn,this,arguments)})}It(Promise,"all"),It(Promise,"race"),It(Promise,"resolve"),It(Promise,"reject"),Ce(Promise)}var Rn=function(e){var t=i(f(e,function(e,t){return e[t]=!0,e},{}));return e.join(":")===t.join(":")},Dn=Rn(["z","a","bb"]),xn=Rn(["z",1,"a","3",2]);if(l){var An=function(e,t){return t||Dn?se(e)?"^"+le.ToString(e):"string"==typeof e?"$"+e:"number"==typeof e?xn?e:"n"+e:"boolean"==typeof e?"b"+e:null:null},Mn=function(){return Object.create?Object.create(null):{}},Fn=function(e,t,i){if(r(i)||ee.string(i))c(i,function(e){if(!le.TypeIsObject(e))throw new TypeError("Iterator value "+e+" is not an entry object");t.set(e[0],e[1])});else if(i instanceof e)n(e.prototype.forEach,i,function(e,n){t.set(n,e)});else{var o,a;if(!se(i)){if(a=t.set,!le.IsCallable(a))throw new TypeError("bad map");o=le.GetIterator(i)}if(void 0!==o)for(;;){var s=le.IteratorStep(o);if(!1===s)break;var l=s.value;try{if(!le.TypeIsObject(l))throw new TypeError("Iterator value "+l+" is not an entry object");n(a,t,l[0],l[1])}catch(e){throw le.IteratorClose(o,!0),e}}}},Ln=function(e,t,i){if(r(i)||ee.string(i))c(i,function(e){t.add(e)});else if(i instanceof e)n(e.prototype.forEach,i,function(e){t.add(e)});else{var o,a;if(!se(i)){if(a=t.add,!le.IsCallable(a))throw new TypeError("bad set");o=le.GetIterator(i)}if(void 0!==o)for(;;){var s=le.IteratorStep(o);if(!1===s)break;var l=s.value;try{n(a,t,l)}catch(e){throw le.IteratorClose(o,!0),e}}}},jn={Map:function(){var e={},t=function(e,t){this.key=e,this.value=t,this.next=null,this.prev=null};t.prototype.isRemoved=function(){return this.key===e};var r=function(e){return!!e._es6map},i=function(e,t){if(!le.TypeIsObject(e)||!r(e))throw new TypeError("Method Map.prototype."+t+" called on incompatible receiver "+le.ToString(e))},o=function(e,t){i(e,"[[MapIterator]]"),this.head=e._head,this.i=this.head,this.kind=t};o.prototype={isMapIterator:!0,next:function(){if(!this.isMapIterator)throw new TypeError("Not a MapIterator");var e=this.i,t=this.kind,n=this.head;if(void 0===this.i)return He();for(;e.isRemoved()&&e!==n;)e=e.prev;for(var r;e.next!==n;)if(e=e.next,!e.isRemoved())return r="key"===t?e.key:"value"===t?e.value:[e.key,e.value],this.i=e,He(r);return this.i=void 0,He()}},Oe(o.prototype);var a,s=function e(){if(!(this instanceof e))throw new TypeError('Constructor Map requires "new"');if(this&&this._es6map)throw new TypeError("Bad construction");var n=Re(this,e,a,{_es6map:!0,_head:null,_map:U?new U:null,_size:0,_storage:Mn()}),r=new t(null,null);return r.next=r.prev=r,n._head=r,arguments.length>0&&Fn(e,n,arguments[0]),n};return a=s.prototype,y.getter(a,"size",function(){if(void 0===this._size)throw new TypeError("size method called on incompatible Map");return this._size}),g(a,{get:function(e){i(this,"get");var t,n=An(e,!0);if(null!==n)return t=this._storage[n],t?t.value:void 0;if(this._map)return t=G.call(this._map,e),t?t.value:void 0;for(var r=this._head,o=r;(o=o.next)!==r;)if(le.SameValueZero(o.key,e))return o.value},has:function(e){i(this,"has");var t=An(e,!0);if(null!==t)return void 0!==this._storage[t];if(this._map)return W.call(this._map,e);for(var n=this._head,r=n;(r=r.next)!==n;)if(le.SameValueZero(r.key,e))return!0;return!1},set:function(e,n){i(this,"set");var r,o=this._head,a=o,s=An(e,!0);if(null!==s){if(void 0!==this._storage[s])return this._storage[s].value=n,this;r=this._storage[s]=new t(e,n),a=o.prev}else this._map&&(W.call(this._map,e)?G.call(this._map,e).value=n:(r=new t(e,n),H.call(this._map,e,r),a=o.prev));for(;(a=a.next)!==o;)if(le.SameValueZero(a.key,e))return a.value=n,this;return r=r||new t(e,n),le.SameValue(-0,e)&&(r.key=0),r.next=this._head,r.prev=this._head.prev,r.prev.next=r,r.next.prev=r,this._size+=1,this},delete:function(t){i(this,"delete");var n=this._head,r=n,o=An(t,!0);if(null!==o){if(void 0===this._storage[o])return!1;r=this._storage[o].prev,delete this._storage[o]}else if(this._map){if(!W.call(this._map,t))return!1;r=G.call(this._map,t).prev,B.call(this._map,t)}for(;(r=r.next)!==n;)if(le.SameValueZero(r.key,t))return r.key=e,r.value=e,r.prev.next=r.next,r.next.prev=r.prev,this._size-=1,!0;return!1},clear:function(){i(this,"clear"),this._map=U?new U:null,this._size=0,this._storage=Mn();for(var t=this._head,n=t,r=n.next;(n=r)!==t;)n.key=e,n.value=e,r=n.next,n.next=n.prev=t;t.next=t.prev=t},keys:function(){return i(this,"keys"),new o(this,"key")},values:function(){return i(this,"values"),new o(this,"value")},entries:function(){return i(this,"entries"),new o(this,"key+value")},forEach:function(e){i(this,"forEach");for(var t=arguments.length>1?arguments[1]:null,r=this.entries(),o=r.next();!o.done;o=r.next())t?n(e,t,o.value[1],o.value[0],this):e(o.value[1],o.value[0],this)}}),Oe(a,a.entries),s}(),Set:function(){var e,t=function(e){return e._es6set&&void 0!==e._storage},r=function(e,n){if(!le.TypeIsObject(e)||!t(e))throw new TypeError("Set.prototype."+n+" called on incompatible receiver "+le.ToString(e))},o=function t(){if(!(this instanceof t))throw new TypeError('Constructor Set requires "new"');if(this&&this._es6set)throw new TypeError("Bad construction");var n=Re(this,t,e,{_es6set:!0,"[[SetData]]":null,_storage:Mn()});if(!n._es6set)throw new TypeError("bad set");return arguments.length>0&&Ln(t,n,arguments[0]),n};e=o.prototype;var a=function(e){var t=e;if("^null"===t)return null;if("^undefined"!==t){var n=t.charAt(0);return"$"===n?C(t,1):"n"===n?+C(t,1):"b"===n?"btrue"===t:+t}},s=function(e){if(!e["[[SetData]]"]){var t=new jn.Map;e["[[SetData]]"]=t,c(i(e._storage),function(e){var n=a(e);t.set(n,n)}),e["[[SetData]]"]=t}e._storage=null};y.getter(o.prototype,"size",function(){return r(this,"size"),this._storage?i(this._storage).length:(s(this),this["[[SetData]]"].size)}),g(o.prototype,{has:function(e){r(this,"has");var t;return this._storage&&null!==(t=An(e))?!!this._storage[t]:(s(this),this["[[SetData]]"].has(e))},add:function(e){r(this,"add");var t;return this._storage&&null!==(t=An(e))?(this._storage[t]=!0,this):(s(this),this["[[SetData]]"].set(e,e),this)},delete:function(e){r(this,"delete");var t;if(this._storage&&null!==(t=An(e))){var n=k(this._storage,t);return delete this._storage[t]&&n}return s(this),this["[[SetData]]"].delete(e)},clear:function(){r(this,"clear"),this._storage&&(this._storage=Mn()),this["[[SetData]]"]&&this["[[SetData]]"].clear()},values:function(){return r(this,"values"),s(this),new l(this["[[SetData]]"].values())},entries:function(){return r(this,"entries"),s(this),new l(this["[[SetData]]"].entries())},forEach:function(e){r(this,"forEach");var t=arguments.length>1?arguments[1]:null,i=this;s(i),this["[[SetData]]"].forEach(function(r,o){t?n(e,t,o,o,i):e(o,o,i)})}}),p(o.prototype,"keys",o.prototype.values,!0),Oe(o.prototype,o.prototype.values);var l=function(e){this.it=e};return l.prototype={isSetIterator:!0,next:function(){if(!this.isSetIterator)throw new TypeError("Not a SetIterator");return this.it.next()}},Oe(l.prototype),o}()};if(I.Set&&!Set.prototype.delete&&Set.prototype.remove&&Set.prototype.items&&Set.prototype.map&&Array.isArray((new Set).keys)&&(I.Set=jn.Set),I.Map||I.Set){a(function(){return 2===new Map([[1,2]]).get(1)})||(I.Map=function e(){if(!(this instanceof e))throw new TypeError('Constructor Map requires "new"');var t=new U;return arguments.length>0&&Fn(e,t,arguments[0]),delete t.constructor,Object.setPrototypeOf(t,I.Map.prototype),t},I.Map.prototype=E(U.prototype),p(I.Map.prototype,"constructor",I.Map,!0),y.preserveToString(I.Map,U));var kn=new Map,Vn=function(){var e=new Map([[1,0],[2,0],[3,0],[4,0]]);return e.set(-0,e),e.get(0)===e&&e.get(-0)===e&&e.has(0)&&e.has(-0)}(),Un=kn.set(1,2)===kn;Vn&&Un||te(Map.prototype,"set",function(e,t){return n(H,this,0===e?0:e,t),this}),Vn||(g(Map.prototype,{get:function(e){return n(G,this,0===e?0:e)},has:function(e){return n(W,this,0===e?0:e)}},!0),y.preserveToString(Map.prototype.get,G),y.preserveToString(Map.prototype.has,W));var Bn=new Set,Gn=Set.prototype.delete&&Set.prototype.add&&Set.prototype.has&&function(e){return e.delete(0),e.add(-0),!e.has(0)}(Bn),Wn=Bn.add(1)===Bn;if(!Gn||!Wn){var Hn=Set.prototype.add;Set.prototype.add=function(e){return n(Hn,this,0===e?0:e),this},y.preserveToString(Set.prototype.add,Hn)}if(!Gn){var zn=Set.prototype.has;Set.prototype.has=function(e){return n(zn,this,0===e?0:e)},y.preserveToString(Set.prototype.has,zn);var qn=Set.prototype.delete;Set.prototype.delete=function(e){return n(qn,this,0===e?0:e)},y.preserveToString(Set.prototype.delete,qn)}var Jn=b(I.Map,function(e){var t=new e([]);return t.set(42,42),t instanceof e}),Xn=Object.setPrototypeOf&&!Jn,Yn=function(){try{return!(I.Map()instanceof I.Map)}catch(e){return e instanceof TypeError}}();0===I.Map.length&&!Xn&&Yn||(I.Map=function e(){if(!(this instanceof e))throw new TypeError('Constructor Map requires "new"');var t=new U;return arguments.length>0&&Fn(e,t,arguments[0]),delete t.constructor,Object.setPrototypeOf(t,e.prototype),t},I.Map.prototype=U.prototype,p(I.Map.prototype,"constructor",I.Map,!0),y.preserveToString(I.Map,U));var Kn=b(I.Set,function(e){var t=new e([]);return t.add(42,42),t instanceof e}),$n=Object.setPrototypeOf&&!Kn,Zn=function(){try{return!(I.Set()instanceof I.Set)}catch(e){return e instanceof TypeError}}();if(0!==I.Set.length||$n||!Zn){var Qn=I.Set;I.Set=function e(){if(!(this instanceof e))throw new TypeError('Constructor Set requires "new"');var t=new Qn;return arguments.length>0&&Ln(e,t,arguments[0]),delete t.constructor,Object.setPrototypeOf(t,e.prototype),t},I.Set.prototype=Qn.prototype,p(I.Set.prototype,"constructor",I.Set,!0),y.preserveToString(I.Set,Qn)}var er=new I.Map,tr=!a(function(){return er.keys().next().done});if(("function"!=typeof I.Map.prototype.clear||0!==(new I.Set).size||0!==er.size||"function"!=typeof I.Map.prototype.keys||"function"!=typeof I.Set.prototype.keys||"function"!=typeof I.Map.prototype.forEach||"function"!=typeof I.Set.prototype.forEach||s(I.Map)||s(I.Set)||"function"!=typeof er.keys().next||tr||!Jn)&&g(I,{Map:jn.Map,Set:jn.Set},!0),I.Set.prototype.keys!==I.Set.prototype.values&&p(I.Set.prototype,"keys",I.Set.prototype.values,!0),Oe(Object.getPrototypeOf((new I.Map).keys())),Oe(Object.getPrototypeOf((new I.Set).keys())),u&&"has"!==I.Set.prototype.has.name){var nr=I.Set.prototype.has;te(I.Set.prototype,"has",function(e){return n(nr,this,e)})}}g(I,jn),Ce(I.Map),Ce(I.Set)}var rr=function(e){if(!le.TypeIsObject(e))throw new TypeError("target must be an object")},ir={apply:function(){return le.Call(le.Call,null,arguments)},construct:function(e,t){if(!le.IsConstructor(e))throw new TypeError("First argument must be a constructor.");var n=arguments.length>2?arguments[2]:e;if(!le.IsConstructor(n))throw new TypeError("new.target must be a constructor.");return le.Construct(e,t,n,"internal")},deleteProperty:function(e,t){if(rr(e),l){var n=Object.getOwnPropertyDescriptor(e,t);if(n&&!n.configurable)return!1}return delete e[t]},has:function(e,t){return rr(e),t in e}};Object.getOwnPropertyNames&&Object.assign(ir,{ownKeys:function(e){rr(e);var t=Object.getOwnPropertyNames(e);return le.IsCallable(Object.getOwnPropertySymbols)&&P(t,Object.getOwnPropertySymbols(e)),t}});var or=function(e){return!o(e)};if(Object.preventExtensions&&Object.assign(ir,{isExtensible:function(e){return rr(e),Object.isExtensible(e)},preventExtensions:function(e){return rr(e),or(function(){return Object.preventExtensions(e)})}}),l){var ar=function(e,t,n){var r=Object.getOwnPropertyDescriptor(e,t);if(!r){var i=Object.getPrototypeOf(e);if(null===i)return;return ar(i,t,n)}return"value"in r?r.value:r.get?le.Call(r.get,n):void 0},sr=function(e,t,r,i){var o=Object.getOwnPropertyDescriptor(e,t);if(!o){var a=Object.getPrototypeOf(e);if(null!==a)return sr(a,t,r,i);o={value:void 0,writable:!0,enumerable:!0,configurable:!0}}if("value"in o){if(!o.writable)return!1;if(!le.TypeIsObject(i))return!1;return Object.getOwnPropertyDescriptor(i,t)?ie.defineProperty(i,t,{value:r}):ie.defineProperty(i,t,{value:r,writable:!0,enumerable:!0,configurable:!0})}return!!o.set&&(n(o.set,i,r),!0)};Object.assign(ir,{defineProperty:function(e,t,n){return rr(e),or(function(){return Object.defineProperty(e,t,n)})},getOwnPropertyDescriptor:function(e,t){return rr(e),Object.getOwnPropertyDescriptor(e,t)},get:function(e,t){rr(e);var n=arguments.length>2?arguments[2]:e;return ar(e,t,n)},set:function(e,t,n){rr(e);var r=arguments.length>3?arguments[3]:e;return sr(e,t,n,r)}})}if(Object.getPrototypeOf){var lr=Object.getPrototypeOf;ir.getPrototypeOf=function(e){return rr(e),lr(e)}}if(Object.setPrototypeOf&&ir.getPrototypeOf){var ur=function(e,t){for(var n=t;n;){if(e===n)return!0;n=ir.getPrototypeOf(n)}return!1};Object.assign(ir,{setPrototypeOf:function(e,t){if(rr(e),null!==t&&!le.TypeIsObject(t))throw new TypeError("proto must be an object or null");return t===ie.getPrototypeOf(e)||!(ie.isExtensible&&!ie.isExtensible(e))&&(!ur(e,t)&&(Object.setPrototypeOf(e,t),!0))}})}var cr=function(e,t){if(le.IsCallable(I.Reflect[e])){a(function(){return I.Reflect[e](1),I.Reflect[e](NaN),I.Reflect[e](!0),!0})&&te(I.Reflect,e,t)}else p(I.Reflect,e,t)};Object.keys(ir).forEach(function(e){cr(e,ir[e])});var fr=I.Reflect.getPrototypeOf;if(u&&fr&&"getPrototypeOf"!==fr.name&&te(I.Reflect,"getPrototypeOf",function(e){return n(fr,I.Reflect,e)}),I.Reflect.setPrototypeOf&&a(function(){return I.Reflect.setPrototypeOf(1,{}),!0})&&te(I.Reflect,"setPrototypeOf",ir.setPrototypeOf),I.Reflect.defineProperty&&(a(function(){var e=!I.Reflect.defineProperty(1,"test",{value:1}),t="function"!=typeof Object.preventExtensions||!I.Reflect.defineProperty(Object.preventExtensions({}),"test",{});return e&&t})||te(I.Reflect,"defineProperty",ir.defineProperty)),I.Reflect.construct&&(a(function(){var e=function(){};return I.Reflect.construct(function(){},[],e)instanceof e})||te(I.Reflect,"construct",ir.construct)),"Invalid Date"!==String(new Date(NaN))){var dr=Date.prototype.toString,hr=function(){var e=+this;return e!==e?"Invalid Date":le.Call(dr,this)};te(Date.prototype,"toString",hr)}var pr={anchor:function(e){return le.CreateHTML(this,"a","name",e)},big:function(){return le.CreateHTML(this,"big","","")},blink:function(){return le.CreateHTML(this,"blink","","")},bold:function(){return le.CreateHTML(this,"b","","")},fixed:function(){return le.CreateHTML(this,"tt","","")},fontcolor:function(e){return le.CreateHTML(this,"font","color",e)},fontsize:function(e){return le.CreateHTML(this,"font","size",e)},italics:function(){return le.CreateHTML(this,"i","","")},link:function(e){return le.CreateHTML(this,"a","href",e)},small:function(){return le.CreateHTML(this,"small","","")},strike:function(){return le.CreateHTML(this,"strike","","")},sub:function(){return le.CreateHTML(this,"sub","","")},sup:function(){return le.CreateHTML(this,"sup","","")}};c(Object.keys(pr),function(e){var t=String.prototype[e],r=!1;if(le.IsCallable(t)){var i=n(t,"",' " '),o=_([],i.match(/"/g)).length;r=i!==i.toLowerCase()||o>2}else r=!0;r&&te(String.prototype,e,pr[e])});var gr=function(){if(!ne)return!1;var e="object"==typeof JSON&&"function"==typeof JSON.stringify?JSON.stringify:null;if(!e)return!1;if(void 0!==e(z()))return!0;if("[null]"!==e([z()]))return!0;var t={a:z()};return t[z()]=!0,"{}"!==e(t)}(),mr=a(function(){return!ne||"{}"===JSON.stringify(Object(z()))&&"[{}]"===JSON.stringify([Object(z())])});if(gr||!mr){var vr=JSON.stringify;te(JSON,"stringify",function(e){if("symbol"!=typeof e){var t;arguments.length>1&&(t=arguments[1]);var i=[e];if(r(t))i.push(t);else{var o=le.IsCallable(t)?t:null,a=function(e,t){var r=o?n(o,this,e,t):t;if("symbol"!=typeof r)return ee.symbol(r)?wt({})(r):r};i.push(a)}return arguments.length>2&&i.push(arguments[2]),vr.apply(this,i)}})}return I}),define("readium_js_plugins",["jquery","underscore","eventEmitter"],function(e,t,n){function r(e,t){this.reader=e,this.plugin=t}function i(e){this.create=function(t){return{host:e,instance:new r(e,t)}}}function o(e,t,n){this.name=e,this.dependencies=t,this.initialized=!1,this.supported=!1,this.initializer=n}var a={},s=function(){this.initialize=function(e){var n=new i(e);if(e.plugins)throw new Error("Already initialized on reader!");e.plugins={},t.each(a,function(e){e.init(n)})},this.getLoadedPlugins=function(){return a},this.register=function(t,r,i){if(a[t])throw new Error("Duplicate registration for plugin with name: "+t);var s;"function"==typeof r?i=r:s=r,a[t]=new o(t,s,function(t,r){if(!t.initialized||!r.host.plugins[t.name]){t.initialized=!0;try{var o={};e.extend(o,new n),i.call(o,r.instance),t.supported=!0,r.host.plugins[t.name]=o}catch(e){t.fail(e)}}})}};return o.prototype={init:function(e){for(var t,n,r=this.dependencies||[],i=0,s=r.length;i<s;++i){if(n=r[i],!((t=a[n])&&t instanceof o))throw new Error("required Plugin '"+n+"' not found");if(t.init(e),!t.supported)throw new Error("required Plugin '"+n+"' not supported")}this.initializer(this,e.create(this))},fail:function(e){throw this.initialized=!0,this.supported=!1,new Error("Plugin '"+this.name+"' failed to load: "+e)},warn:function(e){console.warn("Plugin "+this.name+": "+e)},deprecationNotice:function(e,t){console.warn("DEPRECATED: "+e+" in Plugin "+this.name+"is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in "+this.name+" Plugin: "+e)}},new s}),define("readium_shared_js/globalsSetup",["./globals","jquery","console_shim","es6-shim","eventEmitter","URIjs","readium_cfi_js","readium_js_plugins"],function(e,t,n,r,i,o,a,s){if(console.log("Globals..."),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){if(null==this)throw new TypeError('"this" is null or not defined');var n=Object(this),r=n.length>>>0;if(0===r)return!1;for(var i=0|t,o=Math.max(i>=0?i:r-Math.abs(i),0);o<r;){if(function(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&isNaN(e)&&isNaN(t)}(n[o],e))return!0;o++}return!1}}),window.ReadiumSDK?(console.log("ReadiumSDK extend."),t.extend(e,window.ReadiumSDK)):console.log("ReadiumSDK set."),window.ReadiumSDK=e,i.prototype.trigger=i.prototype.emit,window.EventEmitter=i,window.URI=o,"URL"in window==!1){if("webkitURL"in window==!1)throw Error("Browser does not support window.URL");window.URL=window.webkitURL}if(e.Plugins=s,e.on(e.Events.READER_INITIALIZED,function(t){e.logEvent("READER_INITIALIZED","ON","globalsSetup.js");try{s.initialize(t)}catch(e){console.error("Plugins failed to initialize:",e)}setTimeout(function(){e.logEvent("PLUGINS_LOADED","EMIT","globalsSetup.js"),e.emit(e.Events.PLUGINS_LOADED,t)},0)}),window._RJS_isBrowser){var l=window._RJS_pluginsList;console.log("Plugins included: ",l.map(function(e){return e.replace("readium_plugin_","")})),require(l)}else setTimeout(function(){var e=Object.keys(s.getLoadedPlugins());console.log("Plugins included: ",e)},0)}),define("readium_shared_js",["readium_shared_js/globalsSetup"],function(e){return e}),define("readium_shared_js/models/bookmark_data",[],function(){var e=function(e,t){var n=this;this.idref=e,this.contentCFI=t,this.toString=function(){return JSON.stringify(n)}};return e.fromString=function(t){var n=JSON.parse(t);return new e(n.idref,n.contentCFI)},e}),define("readium_shared_js/models/current_pages_info",[],function(){return function(e,t){this.isRightToLeft=e.isRightToLeft(),this.isFixedLayout=t,this.spineItemCount=e.items.length,this.openPages=[],this.addOpenPage=function(e,t,n,r){this.openPages.push({spineItemPageIndex:e,spineItemPageCount:t,idref:n,spineItemIndex:r}),this.sort()},this.canGoLeft=function(){return this.isRightToLeft?this.canGoNext():this.canGoPrev()},this.canGoRight=function(){return this.isRightToLeft?this.canGoPrev():this.canGoNext()},this.canGoNext=function(){if(0==this.openPages.length)return!1;var t=this.openPages[this.openPages.length-1];return t.spineItemIndex<e.last().index||t.spineItemPageIndex<t.spineItemPageCount-1},this.canGoPrev=function(){if(0==this.openPages.length)return!1;var t=this.openPages[0];return e.first().index<t.spineItemIndex||0<t.spineItemPageIndex},this.sort=function(){this.openPages.sort(function(e,t){return e.spineItemIndex!=t.spineItemIndex?e.spineItemIndex-t.spineItemIndex:e.spineItemPageIndex-t.spineItemPageIndex})}}}),define("readium_shared_js/models/fixed_page_spread",[],function(){var e=function(t,n){function r(){s.leftItem=void 0,s.rightItem=void 0,s.centerItem=void 0}function i(t,n){n==e.POSITION_LEFT?s.leftItem=t:n==e.POSITION_RIGHT?s.rightItem=t:(n!=e.POSITION_CENTER&&console.error("Unrecognized position value"),s.centerItem=t)}function o(t){return l?t.isLeftPage()?e.POSITION_LEFT:t.isRightPage()?e.POSITION_RIGHT:e.POSITION_CENTER:e.POSITION_CENTER}function a(e){return e.isLeftPage()?s.spine.isRightToLeft()?s.spine.prevItem(e):s.spine.nextItem(e):e.isRightPage()?s.spine.isRightToLeft()?s.spine.nextItem(e):s.spine.prevItem(e):void 0}var s=this;this.spine=t,this.leftItem=void 0,this.rightItem=void 0,this.centerItem=void 0;var l=n;this.setSyntheticSpread=function(e){l=e},this.isSyntheticSpread=function(){return l},this.openFirst=function(){0==this.spine.items.length?r():this.openItem(this.spine.first())},this.openLast=function(){0==this.spine.items.length?r():this.openItem(this.spine.last())},this.openItem=function(t){r();var n=o(t);if(i(t,n),n!=e.POSITION_CENTER&&this.spine.isValidLinearItem(t.index)){var s=a(t);if(s){var l=o(s);l!=n&&l!=e.POSITION_CENTER&&!s.isReflowable()&&s.isRenditionSpreadAllowed()&&i(s,l)}}},this.openNext=function(){var e=this.validItems();if(0==e.length)this.openFirst();else{var t=this.spine.nextItem(e[e.length-1]);t&&this.openItem(t)}},this.openPrev=function(){var e=this.validItems();if(0==e.length)this.openLast();else{var t=this.spine.prevItem(e[0]);t&&this.openItem(t)}},this.validItems=function(){var e=[];return this.leftItem&&e.push(this.leftItem),this.rightItem&&e.push(this.rightItem),this.centerItem&&e.push(this.centerItem),e.sort(function(e,t){return e.index-t.index}),e}};return e.POSITION_LEFT="left",e.POSITION_RIGHT="right",e.POSITION_CENTER="center",e}),define("readium_shared_js/models/spine_item",[],function(){var e=function(t,n,r){function i(){a.page_spread&&a.page_spread!=e.SPREAD_LEFT&&a.page_spread!=e.SPREAD_RIGHT&&a.page_spread!=e.SPREAD_CENTER&&console.error(a.page_spread+" is not a recognized spread type")}function o(e,t){return a[e]?a[e]===t:!!a.spine.package[e]&&a.spine.package[e]===t}var a=this;this.idref=t.idref,this.href=t.href,this.cfi=t.cfi,this.linear=t.linear?t.linear.toLowerCase():t.linear,this.page_spread=t.page_spread,this.rendition_viewport=t.rendition_viewport,this.rendition_spread=t.rendition_spread,this.rendition_orientation=t.rendition_orientation,this.rendition_layout=t.rendition_layout,this.rendition_flow=t.rendition_flow,this.media_overlay_id=t.media_overlay_id,this.media_type=t.media_type,this.index=n,this.spine=r,i(),this.setSpread=function(e){this.page_spread=e,i()},this.isRenditionSpreadAllowed=function(){var t=a.getRenditionSpread();return!t||t!=e.RENDITION_SPREAD_NONE},this.isLeftPage=function(){return a.page_spread==e.SPREAD_LEFT},this.isRightPage=function(){return a.page_spread==e.SPREAD_RIGHT},this.isCenterPage=function(){return a.page_spread==e.SPREAD_CENTER},this.isReflowable=function(){return!a.isFixedLayout()},this.isFixedLayout=function(){if(a.getRenditionLayout()){if(a.rendition_layout){if(a.rendition_layout===e.RENDITION_LAYOUT_PREPAGINATED)return!0;if(a.rendition_layout===e.RENDITION_LAYOUT_REFLOWABLE)return!1}return a.spine.package.isFixedLayout()}return a.media_type.indexOf("image/")>=0},this.getRenditionFlow=function(){return a.rendition_flow?a.rendition_flow:a.spine.package.rendition_flow},this.getRenditionViewport=function(){return a.rendition_viewport?a.rendition_viewport:a.spine.package.rendition_viewport},this.getRenditionSpread=function(){return a.rendition_spread?a.rendition_spread:a.spine.package.rendition_spread},this.getRenditionOrientation=function(){return a.rendition_orientation?a.rendition_orientation:a.spine.package.rendition_orientation},this.getRenditionLayout=function(){return a.rendition_layout?a.rendition_layout:a.spine.package.rendition_layout},this.isFlowScrolledContinuous=function(){return o("rendition_flow",e.RENDITION_FLOW_SCROLLED_CONTINUOUS)},this.isFlowScrolledDoc=function(){return o("rendition_flow",e.RENDITION_FLOW_SCROLLED_DOC)}};return e.RENDITION_LAYOUT_REFLOWABLE="reflowable",e.RENDITION_LAYOUT_PREPAGINATED="pre-paginated",e.RENDITION_ORIENTATION_LANDSCAPE="landscape",e.RENDITION_ORIENTATION_PORTRAIT="portrait",e.RENDITION_ORIENTATION_AUTO="auto",e.SPREAD_LEFT="page-spread-left",e.SPREAD_RIGHT="page-spread-right",e.SPREAD_CENTER="page-spread-center",e.RENDITION_SPREAD_NONE="none",e.RENDITION_SPREAD_LANDSCAPE="landscape",e.RENDITION_SPREAD_PORTRAIT="portrait",e.RENDITION_SPREAD_BOTH="both",e.RENDITION_SPREAD_AUTO="auto",e.RENDITION_FLOW_PAGINATED="paginated",e.RENDITION_FLOW_SCROLLED_CONTINUOUS="scrolled-continuous",e.RENDITION_FLOW_SCROLLED_DOC="scrolled-doc",e.RENDITION_FLOW_AUTO="auto",e.alternateSpread=function(t){return t===e.SPREAD_LEFT?e.SPREAD_RIGHT:t===e.SPREAD_RIGHT?e.SPREAD_LEFT:t},e}),define("readium_shared_js/helpers",["./globals","underscore","jquery","jquerySizes","./models/spine_item","URIjs"],function(e,t,n,r,i,o){!function(){"use strict";if(window.performance){if(window.performance.now)return;for(var e=["webkitNow","mozNow","msNow","oNow"],t=0;t<e.length;t++)if(e[t]in window.performance)return void(window.performance.now=window.performance[e[t]])}else window.performance={};if(Date.now)return void(window.performance.now=function(){return Date.now()});window.performance.now=function(){return+new Date}}();var a={};return a.getEbookUrlFilePath=function(e){return window.Blob&&window.File?e instanceof File?e.name:e instanceof Blob?"readium-ebook.epub":e:e},a.getURLQueryParams=function(e){var t={},n=e||window.location.search;if(n&&n.length){n=n.substring(1);for(var r=n.split("&"),i=0;i<r.length;i++){var o=r[i].split("=");o.length>1&&(t[o[0]]=decodeURIComponent(o[1]))}}return t},a.buildUrlQueryParameters=function(e,n){var r=new o(e||window.location),i=r.search(),s=r.hash(),l=r.search("").hash("").toString(),u="";for(var c in n)if(n.hasOwnProperty(c)&&n[c]){var f=n[c];t.isString(f)&&(f=f.trim()),f&&(f=f.verbatim?f.value:encodeURIComponent(f),console.debug("URL QUERY PARAM OVERRIDE: "+c+" = "+f),u+=c+"="+f,u+="&")}var d=a.getURLQueryParams(i);for(var h in d)if(d.hasOwnProperty(h)&&d[h]&&!n[h]){var p=d[h].trim();p&&(console.debug("URL QUERY PARAM PRESERVED: "+h+" = "+p),u+=h+"="+encodeURIComponent(p),u+="&")}return u=u.slice(0,-1),l+"?"+u+s},a.Rect=function(e,t,n,r){this.left=e,this.top=t,this.width=n,this.height=r,this.right=function(){return this.left+this.width},this.bottom=function(){return this.top+this.height},this.isOverlap=function(e,t){return void 0==t&&(t=0),
!(e.right()<this.left+t||e.left>this.right()-t||e.bottom()<this.top+t||e.top>this.bottom()-t)}},a.Rect.fromElement=function(e){var n;n=t.isArray(e)||e instanceof jQuery?e[0]:e,3===n.nodeType&&(n=e.parent()[0]);for(var r=n.offsetLeft,i=n.offsetTop,o=n.offsetWidth,s=n.offsetHeight;n=n.offsetParent;)r+=n.offsetLeft,i+=n.offsetTop;return new a.Rect(r,i,o,s)},a.UpdateHtmlFontAttributes=function(e,r,i,o){var a=n("head",e),s=n("#readium_font_family_link",a);var l=0,u=function(){if(0!=l){var t=n("style#readium-fontFamily",a);if(t&&t[0]&&a[0].removeChild(t[0]),1==l){var s=e[0].ownerDocument.createElement("style");s.setAttribute("id","readium-fontFamily"),s.appendChild(e[0].ownerDocument.createTextNode('html * { font-family: "'+i.fontFamily+'" !important; }')),a[0].appendChild(s)}}var u=r/100,c=e[0].ownerDocument.defaultView;if(!c)return void console.log("NIL $epubHtml[0].ownerDocument.defaultView");for(var f=n("p, div, span, h1, h2, h3, h4, h5, h6, li, blockquote, td, pre, dt, dd, code, a",e),d=0;d<f.length;d++){var h=f[d],p=h.getAttribute("data-original-font-size");if(p)break;var s=c.getComputedStyle(h),g=parseInt(s.fontSize);h.setAttribute("data-original-font-size",g);var m=parseInt(s.lineHeight);m&&h.setAttribute("data-original-line-height",m)}for(var d=0;d<f.length;d++){var h=f[d],p=h.getAttribute("data-original-font-size"),g=p?Number(p):0;g&&n(h).css("font-size",g*u+"px");var v=h.getAttribute("data-original-line-height"),m=v?Number(v):0;m&&n(h).css("line-height",m*u+"px")}e.css("font-size",r+"%");o()},c=t.once(u);if(i.fontFamily&&i.url){var f=s.length?s.attr("data-fontfamily"):void 0;s.length?f!=i.fontFamily?(l=1,s.attr({"data-fontfamily":i.fontFamily,href:i.url})):l=0:(l=1,setTimeout(function(){s=n("<link/>",{id:"readium_font_family_link","data-fontfamily":i.fontFamily,rel:"stylesheet",type:"text/css"}),a.append(s),s.attr({href:i.url})},0))}else l=2,s.length&&s.remove();1==l?setTimeout(function(){c()},100):c()},a.ResolveContentRef=function(e,t){if(!t)return e;var n=t.split("/");n.pop();for(var r=e.split("/");n.length>0&&".."===r[0];)n.pop(),r.splice(0,1);return n.concat(r).join("/")},a.EndsWith=function(e,t){return-1!==e.indexOf(t,e.length-t.length)},a.BeginsWith=function(e,t){return 0===e.indexOf(t)},a.RemoveFromString=function(e,t){var n=e.indexOf(t);return-1==n?e:e.substring(0,n)+e.substring(n+t.length)},a.Margins=function(e,t,n){this.margin=e,this.border=t,this.padding=n,this.left=this.margin.left+this.border.left+this.padding.left,this.right=this.margin.right+this.border.right+this.padding.right,this.top=this.margin.top+this.border.top+this.padding.top,this.bottom=this.margin.bottom+this.border.bottom+this.padding.bottom,this.width=function(){return this.left+this.right},this.height=function(){return this.top+this.bottom}},a.triggerLayout=function(e){var t=e[0].contentDocument;if(t){var n=void 0;try{if(!(n=t.styleSheets&&t.styleSheets.length?t.styleSheets[0]:void 0)){var r=t.createElement("style");t.head.appendChild(r),r.appendChild(t.createTextNode("")),n=r.sheet}if(n){var i="body:first-child::before {content:'READIUM';color: red;font-weight: bold;}";n.cssRules?n.insertRule(i,n.cssRules.length):n.insertRule(i,0)}}catch(e){console.error(e)}try{var o=t.createElementNS("http://www.w3.org/1999/xhtml","style");o.appendChild(t.createTextNode("*{}")),t.body.appendChild(o),t.body.removeChild(o),n&&(n.cssRules?n.deleteRule(n.cssRules.length-1):n.deleteRule(0))}catch(e){console.error(e)}if(t.body){t.body.offsetTop}}},a.deduceSyntheticSpread=function(t,n,r){if(!t||0==t.length)return 0;var o=n?n.getRenditionSpread():void 0;if(o===i.RENDITION_SPREAD_NONE)return!1;if("double"==r.syntheticSpread)return!0;if("single"==r.syntheticSpread)return!1;if(!n)return 0;if(o===i.RENDITION_SPREAD_BOTH)return!0;var s=a.getOrientation(t);if(o===i.RENDITION_SPREAD_LANDSCAPE)return s===e.Views.ORIENTATION_LANDSCAPE;if(o===i.RENDITION_SPREAD_PORTRAIT)return s===e.Views.ORIENTATION_PORTRAIT;if(!o||o===i.RENDITION_SPREAD_AUTO){return s===e.Views.ORIENTATION_LANDSCAPE?1:0}return console.warn("Helpers.deduceSyntheticSpread: spread properties?!"),0},a.Margins.fromElement=function(e){return new this(e.margin(),e.border(),e.padding())},a.Margins.empty=function(){return new this({left:0,right:0,top:0,bottom:0},{left:0,right:0,top:0,bottom:0},{left:0,right:0,top:0,bottom:0})},a.loadTemplate=function(e,t){return a.loadTemplate.cache[e]},a.loadTemplate.cache={fixed_book_frame:'<div id="fixed-book-frame" class="clearfix book-frame fixed-book-frame"></div>',single_page_frame:'<div><div id="scaler"><iframe enable-annotation="enable-annotation" allowfullscreen="allowfullscreen" scrolling="no" class="iframe-fixed"></iframe></div></div>',scrolled_book_frame:'<div id="reflowable-book-frame" class="clearfix book-frame reflowable-book-frame"><div id="scrolled-content-frame"></div></div>',reflowable_book_frame:'<div id="reflowable-book-frame" class="clearfix book-frame reflowable-book-frame"></div>',reflowable_book_page_frame:'<div id="reflowable-content-frame" class="reflowable-content-frame"><iframe enable-annotation="enable-annotation" allowfullscreen="allowfullscreen" scrolling="no" id="epubContentIframe"></iframe></div>'},a.setStyles=function(e,t){var r=e.length;if(r){for(var i="",o=[],a=!(!t||!t.createTextNode),s=0;s<r;s++){var l=e[s];if(a){if(l.selector&&""!=l.selector&&"html"!=l.selector&&"body"!=l.selector&&"*"!=l.selector){var u="";for(var c in l.declarations)if(l.declarations.hasOwnProperty(c)){var f=c.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()});u+=f+": "+l.declarations[c]+" !important; "}o.push({selector:l.selector,cssProps:u})}else for(var c in l.declarations)if(l.declarations.hasOwnProperty(c)){var f=c.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()});i+=f+": "+l.declarations[c]+" !important; "}}else l.selector?n(l.selector,t).css(l.declarations):t.css(l.declarations)}if(a){var d=t,h=n("style#readium-bookStyles",d.head);h&&h[0]&&d.head.removeChild(h[0]);var p="";if(i.length>0&&(p+=" body, body::after, body::before, body *, body *::after, body *::before { "+i+" } "),o.length>0)for(var s=0;s<o.length;s++){var g=o[s];p+=" "+g.selector+" { "+g.cssProps+" } "}if(p.length>0){var m=d.createElement("style");m.setAttribute("id","readium-bookStyles"),m.appendChild(d.createTextNode(p)),d.head.appendChild(m)}}}},a.isIframeAlive=function(e){var t=void 0,n=void 0;try{t=e.contentWindow,n=e.contentDocument}catch(e){return console.error(e),!1}return t&&n},a.getOrientation=function(t){var n=t.width(),r=t.height();if(n&&r)return n>=r?e.Views.ORIENTATION_LANDSCAPE:e.Views.ORIENTATION_PORTRAIT},a.isRenditionSpreadPermittedForItem=function(t,n){var r=t.getRenditionSpread();return!r||r==i.RENDITION_SPREAD_BOTH||r==i.RENDITION_SPREAD_AUTO||r==i.RENDITION_SPREAD_LANDSCAPE&&n==e.Views.ORIENTATION_LANDSCAPE||r==i.RENDITION_SPREAD_PORTRAIT&&n==e.Views.ORIENTATION_PORTRAIT},a.CSSTransition=function(e,n){var r={};t.each(["","-webkit-","-moz-","-ms-"],function(e){r[e+"transition"]=e+n}),e.css(r)},a.CSSTransformString=function(e){var t,n,r,i=!!e.enable3D,o=e.origin;if(e.left||e.top){var a=e.left||0,s=e.top||0;t=i?"translate3D("+a+"px, "+s+"px, 0)":"translate("+a+"px, "+s+"px)"}if(e.scale&&(n=i?"scale3D("+e.scale+", "+e.scale+", 0)":"scale("+e.scale+")"),e.angle&&(r=i?"rotate3D(0,0,"+e.angle+"deg)":"rotate("+e.angle+"deg)"),!(t||n||r))return{};var l=t&&n?t+" "+n:t||n;r&&(l=l+" "+r);var u={};return u.transform=l,u["transform-origin"]=o||(i?"0 0 0":"0 0"),u},a.extendedThrottle=function(e,t,n,r,i,o){r||(r=250),i||(i=r);var a,s,l=!0;return function(){var u=o||this,c=Date.now&&Date.now()||(new Date).getTime(),f=arguments;a&&c<a+r||(a=c,l?(e.apply(u,f),l=!1):t.apply(u,f)),clearTimeout(s),s=setTimeout(function(){a=c,l=!0,n.apply(u,f)},i)}},a.escapeJQuerySelector=function(e){if(e){return e.replace(/([;&,\.\+\*\~\?':"\!\^#$%@\[\]\(\)<=>\|\/\\{}`])/g,"\\$1")}},a.polyfillCaretRangeFromPoint=function(e){if(!e.caretRangeFromPoint)if(e.caretPositionFromPoint)e.caretRangeFromPoint=function(t,n){var r=e.createRange(),i=e.caretPositionFromPoint(t,n);return i?(i.offsetNode&&(r.setStart(i.offsetNode,i.offset),r.setEnd(i.offsetNode,i.offset)),r):null};else if((e.body||e.createElement("body")).createTextRange){var t={convertToDOMRange:function(e,t){var n=function(e,n,r){var i=t.createElement("a"),o=n.duplicate();o.collapse(r);var a=o.parentElement();do{a.insertBefore(i,i.previousSibling),o.moveToElementText(i)}while(o.compareEndPoints(r?"StartToStart":"StartToEnd",n)>0&&i.previousSibling);-1==o.compareEndPoints(r?"StartToStart":"StartToEnd",n)&&i.nextSibling?(o.setEndPoint(r?"EndToStart":"EndToEnd",n),e[r?"setStart":"setEnd"](i.nextSibling,o.text.length)):e[r?"setStartBefore":"setEndBefore"](i),i.parentNode.removeChild(i)},r=t.createRange();return n(r,e,!0),n(r,e,!1),r}};e.caretRangeFromPoint=function(n,r){for(var i=e.body.createTextRange(),o=40;o;o-=4)try{return i.moveToPoint(n,o+r-40),t.convertToDOMRange(i,e)}catch(e){}try{var a=e.elementFromPoint(n-1,r-1),s=e.createRange();return s.setStartAfter(a),s}catch(e){return null}}}},a}),define("readium_shared_js/views/cfi_navigation_logic",["jquery","underscore","../helpers","readium_cfi_js"],function(e,t,n,r){return function(i){function o(){return ie.getRootDocument().createRange()}function a(e){var t=o();return t.selectNodeContents(e),t}function s(e){var t=o();return t.selectNode(e),O(t.getBoundingClientRect(),0,0)}function l(e){var t=o();return t.selectNodeContents(e),O(t.getBoundingClientRect(),0,0)}function u(e,t,n,r){var i=o();return i.setStart(e,t||0),n.nodeType===Node.ELEMENT_NODE?i.setEnd(n,r||n.childNodes.length):n.nodeType===Node.TEXT_NODE&&i.setEnd(n,r||0),i.collapsed?O(i.getClientRects()[0],0,0):O(i.getBoundingClientRect(),0,0)}function c(e,n){return n=n||y(),t.map(e.getClientRects(),function(e){return O(e,n.left,n.top)})}function f(){return i.frameDimensionsGetter?i.frameDimensionsGetter():(console.error("CfiNavigationLogic: No frame dimensions specified!"),null)}function d(e,t,r){return r=r||ie.getRootDocument(),n.polyfillCaretRangeFromPoint(r),r.caretRangeFromPoint(e,t)}function h(){return!!i.paginationInfo}function p(){return i.paginationInfo&&!!i.paginationInfo.rightToLeft}function g(){return i.paginationInfo&&!!i.paginationInfo.isVerticalWritingMode}function m(e,t,n){return n=n||f(),!!e&&((0!=e.left||0!=e.right||0!=e.top||0!=e.bottom)&&(h()&&!g()?e.left>=0&&e.left<n.width||!t&&e.left<0&&e.right>0:e.top>=0&&e.top<n.height||!t&&e.top<0&&e.bottom>0))}function v(){return!i.paginationInfo||g()?i.$iframe.width():i.paginationInfo.columnWidth+i.paginationInfo.columnGap}function y(){return i.visibleContentOffsetsGetter?i.visibleContentOffsetsGetter():g()&&i.paginationOffsetsGetter?i.paginationOffsetsGetter():{top:0,left:0}}function E(){return i.paginationOffsetsGetter?i.paginationOffsetsGetter():{top:0,left:0}}function b(e,t,n,r){n=n||y(),r=r||f();var i=_(e,n);if(0===i.length)return null;var o=0;if(1===i.length){var a=i[0];h()&&(a.bottom>r.height||a.top<0)&&N(a,!0,r),m(a,!1,r)&&(o=t&&a.top<0?Math.floor(100*(a.height+a.top)/a.height):t&&a.bottom>r.height?Math.floor(100*(r.height-a.top)/a.height):t&&a.left<0&&a.right>0?Math.floor(100*a.right/a.width):t&&a.left<0&&a.right>0?Math.floor(100*a.right/a.width):100)}else for(var s=0,l=i.length;s<l;++s)if(m(i[s],!1,r)){o=t?S(i,s):100;break}return o}function I(e){var t=y(),n=_(e,t);return 0===n.length?null:T(n)}function T(e,n,r){var o=p(),a=g();r=r||v(),n=n||f();var s=t.first(e);1===e.length&&N(s,!1,n,r,o,a);var l;if(a){var u=s.top;l=Math.floor(u/n.height)}else{var c=s.left;o&&(c=r*(i.paginationInfo?i.paginationInfo.visibleColumnCount:1)-c),l=Math.floor(c/r)}return l}function w(e,t,n){return t=t||y(),n=n||f(),T([O(e,t.left,t.top)],n)}function S(e,n){var r=0,i=0;return e.length>1?t.each(e,function(e,t){r+=e.height,t>=n&&(i+=e.height)}):(r=e[0].height,i=e[0].height-Math.max(0,-e[0].top)),i===r?100:Math.floor(100*i/r)}function _(e,t){t=t||{};var n,r=t.left||0,i=t.top||0,a=e[0].nodeType===Node.TEXT_NODE;if(a){var s=o();s.selectNode(e[0]),n=s.getClientRects()}else n=e[0].getClientRects();for(var l=[],u=0,c=n.length;u<c;++u)(n[u].height>0||1===n.length)&&l.push(O(n[u],r,i));return l}function C(e,t){t=t||{};var n,r=t.left||0,i=t.top||0,a=e[0].nodeType===Node.TEXT_NODE;if(a){var s=o();s.selectNode(e[0]),n=s.getBoundingClientRect()}else n=e[0].getBoundingClientRect();return O(n,r,i)}function O(e,t,n){var r={left:e.left,right:e.right,top:e.top,bottom:e.bottom,width:e.right-e.left,height:e.bottom-e.top};return t=t||0,n=n||0,P(r,t,n),r}function P(e,t,n){e.left+=t,e.right+=t,e.top+=n,e.bottom+=n}function N(e,t,n,r,i,o){if(n=n||f(),r=r||v(),i=i||p(),!(o=o||g())){for(i&&(r*=-1);e.top<0;)P(e,-r,n.height);if(t)for(;e.bottom>=n.height&&!m(e,!1,n);)P(e,r,-n.height)}}function R(e,t){var n=t/100;return Math.round((e.endOffset-e.startOffset)*n)}function D(e,t){if(e.endOffset-e.startOffset==1)return[e];var n=R(e,t),r=e.startContainer,i=e.cloneRange();i.setStart(r,e.startOffset),i.setEnd(r,e.startOffset+n);var o=e.cloneRange();return o.setStart(r,e.startOffset+n),o.setEnd(r,e.endOffset),[i,o]}function x(e,t,n,r){n=n||y();var i=a(e),o=c(i,n),s=A(o,t([0,1]));return L(D(i,s),n,t([0,1]),s,function(e){return(g()?e.height:e.width)&&m(e,!1,r)})}function A(e,n){var r=0,i=t.filter(e,function(e){return(g()?e.height:e.width)&&m(e,!1,f())}),o=F(i),a=s-o,s=F(e);return o===s?n?55:45:(r=o/s*100,a>o?r+5:r-5)}function M(e){var n=e.sort(function(e,t){return e.top<t.top}),r=[];t.each(n,function(e){var t=e.top;if(r[t]){var n=r[t];n.push(e.height),r[t]=n}else r[t]=[e.height]})}function F(e){var n=M(e),r=0;return t.each(n,function(e){r+=Math.max.apply(null,e)}),r}function L(e,t,n,r,i){for(var o=0,a=e;1!==a.length;){o++;a=j(c(a[n],t),i)?D(a[n],r):D(a[n?0:1],r)}oe&&(console.debug("getVisibleTextRangeOffsets:getTextRangeOffset:runCount",o),window.top._DEBUG_visibleTextRangeOffsetsRuns.push(o));var s=a[0];return s&&s.collapse(!n),s}function j(e,n){return!!t.filter(e,n).length}function k(e,t,n,r){if(!e)return null;var i=e.element,o=e.textNode;if(o&&Y(o)){var a=x(o,t,n,r);return a?B(a):(oe&&console.warn("findVisibleLeafNodeCfi: failed to find text range offset"),null)}return ie.getCfiForElement(i)}function V(e,n){return k(ie.findLastVisibleElement(e,n),t.last,e,n)}function U(e,n){return k(ie.findFirstVisibleElement(e,n),t.first,e,n)}function B(e){return e.collapsed&&e.startContainer.nodeType===Node.TEXT_NODE?r.generateCharacterOffsetCFIComponent(e.startContainer,e.startOffset,["cfi-marker"],[],["MathJax_Message","MathJax_SVG_Hidden"]):e.collapsed?ie.getCfiForElement(e.startContainer):r.generateRangeComponent(e.startContainer,e.startOffset,e.endContainer,e.endOffset,ie.getClassBlacklist(),ie.getElementBlacklist(),ie.getIdBlacklist())}function G(e){return"epubcfi(/99!"+e+")"}function W(e){return r.Interpreter.isRangeCfi(G(e))}function H(e){return r.Interpreter.hasTextTerminus(G(e))}function z(e,t,n,i){var o=ie.getRootDocument(),a=G(e);try{var s=r.getTargetElement(a,o,t,n,i)}catch(e){}return s&&0!=s.length?s:void console.log("Can't find element for CFI: "+e)}function q(t){var n=ie.getLeafNodeElements(e(ie.getBodyElement())),r=t(n),i=t([!0,!1]),a=o();return a.selectNodeContents(r[0]),a.collapse(i),B(a)}function J(e){var n=e.className;n&&void 0!==n.animVal?n=n.animVal:n&&void 0!==n.baseVal&&(n=n.baseVal);var r=n?n.split(" "):[],i=e.id,o=ie.getClassBlacklist();return!(1!==r.length||!t.contains(o,r[0]))||(!(!r.length||!t.intersection(o,r).length)||(!!(i&&i.length&&t.contains(ie.getIdBlacklist(),i))||!!t.contains(ie.getElementBlacklist(),e.tagName.toLowerCase())))}function X(e){return!!e&&e.nodeType===Node.ELEMENT_NODE}function Y(e){return!!e&&(e.nodeType===Node.TEXT_NODE&&K(e.nodeValue))}function K(e){return!!e.trim().length}function $(){var e=this,n={leafNodeElements:!0,visibleLeafNodes:!1};t.each(n,function(t,n){e[n]=new Map}),this._invalidate=function(){t.each(n,function(t,n){t||(e[n]=new Map)})}}function Z(){for(var e="0123456789ABCDEF".split(""),t="#",n=0;n<6;n++)t+=e[Math.round(15*Math.random())];return t}function Q(t,n,r){var i=Z();t instanceof Array||(t=[t]);for(var o=0;o!=t.length;o++){var a=t[o],s=r.createElement("div");s.style.position="absolute",e(s).css("z-index","1000"),e(s).css("pointer-events","none"),e(s).css("opacity","0.4"),s.style.border="1px solid white",n||i?i&&!n?s.style.background=i:(!0===n&&(n="red"),s.style.border="1px dashed "+n,s.style.background="yellow"):s.style.background="purple",s.style.margin=s.style.padding="0",s.style.top=a.top+"px",s.style.left=a.left+"px",s.style.width=a.width-2+"px",s.style.height=a.height-2+"px",r.documentElement.appendChild(s),le.push(e(s))}}function ee(e){var t=E();Q({left:e.left+t.left,top:e.top+t.top,width:e.width,height:e.height},!0,ie.getRootDocument())}function te(e){var t=u(e.startContainer,e.startOffset,e.endContainer,e.endOffset);return ee(t),t}function ne(e){ee(s(e))}function re(){t.each(le,function(e){e.remove()}),le=[]}var ie=this;i=i||{};var oe=ReadiumSDK.DEBUG_MODE;oe&&(window.top._DEBUG_visibleTextRangeOffsetsRuns=window.top._DEBUG_visibleTextRangeOffsetsRuns||[]),this.getRootElement=function(){return i.$iframe?i.$iframe[0].contentDocument.documentElement:null},this.getBodyElement=function(){var e=this.getRootDocument();return e&&e.body?e.body:this.getRootElement()},this.getClassBlacklist=function(){return i.classBlacklist||[]},this.getIdBlacklist=function(){return i.idBlacklist||[]},this.getElementBlacklist=function(){return i.elementBlacklist||[]},this.getRootDocument=function(){return i.$iframe?i.$iframe[0].contentDocument:null},this.getCfiForElement=function(e){var t=r.Generator.generateElementCFIComponent(e,this.getClassBlacklist(),this.getElementBlacklist(),this.getIdBlacklist());return"!"==t[0]&&(t=t.substring(1)),t},this.getVisibleCfiFromPoint=function(e,t,n){var r=ie.getRootDocument(),i=d(e,t,r),a=r.elementFromPoint(e,t),s=!a||a===r.documentElement;if(n){if(!a||s)return null;var u=l(a);if(!m(u,!1))return null;if(e<u.left||e>u.right||t<u.top||t>u.bottom)return null}if(!i){if(s)return console.error("Could not generate CFI no visible element on page"),null;i=o(),i.selectNode(a)}var c,f,h,p=i,g=p.startContainer;if(g.nodeType===Node.TEXT_NODE){if(n&&g.parentNode!==a)return null;1===g.length&&1===p.startOffset?(f=0,h=1):p.startOffset===g.length?(f=p.startOffset-1,h=p.startOffset):(f=p.startOffset,h=p.startOffset+1);var v={startContainer:g,endContainer:g,startOffset:f,endOffset:h,commonAncestorContainer:p.commonAncestorContainer};oe&&te(v),c=B(v)}else if(g.nodeType===Node.ELEMENT_NODE){if(g=p.startContainer.childNodes[p.startOffset]||p.startContainer.childNodes[0]||p.startContainer,n&&g!==a)return null;c=g.nodeType!==Node.ELEMENT_NODE?B(p):ie.getCfiForElement(g)}else{if(n&&g!==a)return null;c=ie.getCfiForElement(a)}return c&&-1!==c.indexOf("NaN")?void console.log("Did not generate a valid CFI:"+c):c},this.getRangeCfiFromPoints=function(e,t,n,r){var i=ie.getRootDocument(),a=d(e,t,i),s=d(n,r,i),l=o();return l.setStart(a.startContainer,a.startOffset),l.setEnd(s.startContainer,s.startOffset),a.startContainer===a.endContainer&&a.startContainer.nodeType===Node.TEXT_NODE&&s.startContainer.length>s.startOffset+1&&l.setEnd(s.startContainer,s.startOffset+1),B(l)},this.getFirstVisibleCfi=function(e,t){return U(e,t)},this.getLastVisibleCfi=function(e,t){return V(e,t)},this.getDomRangeFromRangeCfi=function(e,t,n){var r=o();if(t){if(ie.isRangeCfi(e)){var i=ie.getNodeRangeInfoFromCfi(e);r.setStart(i.startInfo.node,i.startInfo.offset)}else{var a=ie.getElementByCfi(e,this.getClassBlacklist(),this.getElementBlacklist(),this.getIdBlacklist())[0];r.setStart(a,0)}if(ie.isRangeCfi(t)){var s=ie.getNodeRangeInfoFromCfi(t);n?r.setEnd(s.endInfo.node,s.endInfo.offset):r.setEnd(s.startInfo.node,s.startInfo.offset)}else{var l=ie.getElementByCfi(t,this.getClassBlacklist(),this.getElementBlacklist(),this.getIdBlacklist())[0];r.setEnd(l,l.childNodes.length)}}else if(ie.isRangeCfi(e)){var u=ie.getNodeRangeInfoFromCfi(e);r.setStart(u.startInfo.node,u.startInfo.offset),r.setEnd(u.endInfo.node,u.endInfo.offset)}else{var c=ie.getElementByCfi(e,this.getClassBlacklist(),this.getElementBlacklist(),this.getIdBlacklist())[0];r.selectNode(c)}return r},this.getRangeCfiFromDomRange=function(e){return B(e)},this.isRangeCfi=function(e){return W(e)||H(e)},this.getPageIndexDeltaForCfi=function(e,t,n,r){if(this.isRangeCfi(e)){return w(this.getNodeRangeInfoFromCfi(e).clientRect)}var i=z(e,t,n,r);return i?this.getPageIndexDeltaForElement(i):-1},this.getElementFromPoint=function(e,t){return ie.getRootDocument().elementFromPoint(e,t)},this.getNodeRangeInfoFromCfi=function(e){var t=ie.getRootDocument(),n=G(e);if(W(e)){try{var i=r.Interpreter.getRangeTargetElements(n,t,this.getClassBlacklist(),this.getElementBlacklist(),this.getIdBlacklist());oe&&console.log(i)}catch(e){}if(!i)return void console.log("Can't find nodes for range CFI: "+e);var o={node:i.startElement,offset:i.startOffset},a={node:i.endElement,offset:i.endOffset},s=o&&a?u(o.node,o.offset,a.node,a.offset):null;return oe&&(console.log(s),Q(s,"purple",t)),{startInfo:o,endInfo:a,clientRect:s}}if(H(e)){try{var l=r.Interpreter.getTextTerminusInfo(n,t,this.getClassBlacklist(),this.getElementBlacklist(),this.getIdBlacklist());oe&&console.log(l)}catch(e){}if(!l)return void console.log("Can't find node for text term CFI: "+e);var c={node:l.textNode,offset:l.textOffset},f=u(c.node,c.offset,c.node,c.offset);return oe&&(console.log(f),Q(f,"purple",t)),{startInfo:c,endInfo:c,clientRect:f}}return{startInfo:null,endInfo:null,clientRect:C(ie.getElementByCfi(e,this.getClassBlacklist(),this.getElementBlacklist(),this.getIdBlacklist()),y())}},this.isNodeFromRangeCfiVisible=function(e){var t=this.getNodeRangeInfoFromCfi(e);return t?m(t.clientRect,!1):void 0},this.getNearestCfiFromElement=function(n){var r,i,o,a=t.filter(n.parentNode.childNodes,function(e){return e===n||Y(e)}),s=a.indexOf(n),l=a[s-1];if(l||(l=a[s+1],r=!0),l||(l=t.last(this.getLeafNodeElements(e(n.previousElementSibling))))||(r=!0,l=t.first(this.getLeafNodeElements(e(n.nextElementSibling)))),Y(l)?(i=l,o=!0):i=X(l)?l:X(n.previousElementSibling)?n.previousElementSibling:X(n.nextElementSibling)?n.nextElementSibling:n.parentNode,o){var u=i.ownerDocument.createRange();return u.selectNodeContents(i),u.collapse(r),this.getRangeCfiFromDomRange(u)}return this.getCfiForElement(i)},this.getElementByCfi=function(e,t,n,r){return z(e,t,n,r)},this.getPageIndexDeltaForElement=function(e){var t=I(e);if(null===t){return I(this.getElementByCfi(this.getNearestCfiFromElement(e[0])))}return t},this.getElementById=function(t){var n=this.getRootDocument(),r=e(n.getElementById(t));if(0!=r.length)return r},this.getPageIndexDeltaForElementId=function(e){var t=this.getElementById(e);return t?this.getPageIndexDeltaForElement(t):-1},this.getFirstVisibleMediaOverlayElement=function(t){function n(r){if(r&&r.length)for(var a=0,s=r.length;a<s;a++){var l=r[a];if(l){var u=e(l);if(u.data("mediaOverlayData")){var c=i.getElementVisibility(u,t);if(c&&(o||(o=l),100==c))return l}else{var f=n(l.children);if(f)return f}}}}var r=e(this.getBodyElement());if(r&&r.length&&r[0]){var i=this,o=void 0,a=n([r[0]]);return a||(a=o),a}},this.getElementVisibility=function(e,t){return b(e,!0,t)},this.isElementVisible=this.getElementVisibility,this.getVisibleElementsWithFilter=function(t,n){var r=this.getElementsWithFilter(e(this.getBodyElement()),n);return this.getVisibleElements(r,t)},this.getAllElementsWithFilter=function(t){return this.getElementsWithFilter(e(this.getBodyElement()),t)},this.getAllVisibleElementsWithSelector=function(t,n){var r=e(t,this.getRootElement()),i=[];return e.each(r,function(){i.push(e(this))}),this.getVisibleElements(i,n)},this.getVisibleElements=function(e,n,r){var i=[];return t.each(e,function(e){var t=e[0].nodeType===Node.TEXT_NODE,o=t?e.parent():e,a=b(e,!0,n,r);a&&i.push({element:o[0],textNode:t?e[0]:null,percentVisible:a})}),i},this.getVisibleLeafNodes=function(t,n){if(se){var r=(i.paginationInfo||{}).currentSpreadIndex||0,o=ae.visibleLeafNodes.get(r);if(o)return o}var a=this.getLeafNodeElements(e(this.getBodyElement())),s=this.getVisibleElements(a,t,n);return se&&ae.visibleLeafNodes.set(r,s),s},this.getStartCfi=function(){return q(t.first)},this.getEndCfi=function(){return q(t.last)},this.getElementsWithFilter=function(t,n){function r(t){if(void 0!=t)for(var o=0,a=t.length;o<a;o++){var s=e(t[o]);n(s)?i.push(s):r(s[0].children)}}var i=[];return r([t[0]]),i},this.getLeafNodeElements=function(t){if(se){var n=ae.leafNodeElements.get(t);if(n)return n}for(var r,i=document.createNodeIterator(t[0],NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,function(){return NodeFilter.FILTER_ACCEPT},!1),o=[];r=i.nextNode();){if(r.nodeType===Node.ELEMENT_NODE&&!r.childElementCount&&!K(r.textContent)||Y(r)){J(r.nodeType===Node.TEXT_NODE?r.parentNode:r)||o.push(e(r))}}return se&&ae.leafNodeElements.set(t,o),o},this.getElements=function(t){return t?e(t,this.getRootElement()):e(this.getRootElement()).children()},this.getElement=function(e){var t=this.getElements(e);if(t.length>0)return t};var ae=new $,se=!1;this.invalidateCache=function(){ae._invalidate()};var le=[];ReadiumSDK._DEBUG_CfiNavigationLogic={clearDebugOverlays:re,drawDebugOverlayFromRect:ee,drawDebugOverlayFromDomRange:te,drawDebugOverlayFromNode:ne,debugVisibleCfis:function(){console.log(JSON.stringify(ReadiumSDK.reader.getPaginationInfo().openPages));var e=ReadiumSDK.reader.getFirstVisibleCfi(),t=ReadiumSDK.reader.getDomRangeFromRangeCfi(e);console.log(e,t,te(t));var n=ReadiumSDK.reader.getLastVisibleCfi(),r=ReadiumSDK.reader.getDomRangeFromRangeCfi(n);console.log(n,r,te(r))},visibleTextRangeOffsetsRunsAvg:function(){var e=window.top._DEBUG_visibleTextRangeOffsetsRuns;return e.reduce(function(e,t){return e+t})/e.length}},this.findFirstVisibleElement=function(t,n){var r=this.getBodyElement();if(!r)return null;for(var i,o,a=0,s=document.createTreeWalker(r,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,function(r){return r.nodeType===Node.ELEMENT_NODE&&J(r)?NodeFilter.FILTER_REJECT:(r.nodeType!==Node.TEXT_NODE||Y(r))&&b(e(r),!0,t,n)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT},!1);s.nextNode();){var l=s.currentNode;if(l.nodeType===Node.TEXT_NODE){i=l.parentNode,o=l,a=100;break}for(var u=!1,c=!1,f=l.childNodes.length-1;f>=0;f--){var d=l.childNodes[f];if(d.nodeType===Node.ELEMENT_NODE){u=!0;break}d.nodeType===Node.TEXT_NODE&&(c=!0)}if(!u&&c)for(var f=l.childNodes.length-1;f>=0;f--){var d=l.childNodes[f];if(d.nodeType===Node.TEXT_NODE&&Y(d)){var h=b(e(d),!0,t,n);if(h){i=l,o=d,a=h;break}}}else if(!u){i=l,a=100,o=null;break}}return i?{element:i,textNode:o,percentVisible:a}:null},this.findLastVisibleElement=function(t,n){var r=this.getBodyElement();if(!r)return null;for(var i,o,a=0,s=document.createTreeWalker(r,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,function(r){return r.nodeType===Node.ELEMENT_NODE&&J(r)?NodeFilter.FILTER_REJECT:(r.nodeType!==Node.TEXT_NODE||Y(r))&&b(e(r),!0,t,n)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT},!1);s.lastChild(););do{var l=s.currentNode;if(l.nodeType===Node.TEXT_NODE){i=l.parentNode,o=l,a=100;break}for(var u=!1,c=!1,f=l.childNodes.length-1;f>=0;f--){var d=l.childNodes[f];if(d.nodeType===Node.ELEMENT_NODE){u=!0;break}d.nodeType===Node.TEXT_NODE&&(c=!0)}if(!u&&c)for(var f=l.childNodes.length-1;f>=0;f--){var d=l.childNodes[f];if(d.nodeType===Node.TEXT_NODE&&Y(d)){var h=b(e(d),!0,t,n);if(h){i=l,o=d,a=h;break}}}else if(!u){i=l,a=100,o=null;break}}while(s.previousNode());return i?{element:i,textNode:o,percentVisible:a}:null}}}),define("readium_shared_js/models/viewer_settings",[],function(){return function(e){function t(e){for(var t=[],n=e.split(/[\s,;]+/),r=0;r<n.length;r++){var i=n[r].trim();""!==i&&t.push(i)}return t}function n(e,t,n){void 0!==t[e]&&(r[e]=n?n(t[e]):t[e])}var r=this;this.syntheticSpread="auto",this.fontSelection=0,this.fontSize=100,this.columnGap=20,this.columnMaxWidth=700,this.columnMinWidth=400,this.mediaOverlaysPreservePlaybackWhenScroll=!1,this.mediaOverlaysSkipSkippables=!1,this.mediaOverlaysEscapeEscapables=!0,this.mediaOverlaysSkippables=[],this.mediaOverlaysEscapables=[],this.mediaOverlaysEnableClick=!0,this.mediaOverlaysRate=1,this.mediaOverlaysVolume=100,this.mediaOverlaysSynchronizationGranularity="",this.mediaOverlaysAutomaticPageTurn=!0,this.enableGPUHardwareAccelerationCSS3D=!1,this.pageTransition=-1,this.scroll="auto",this.update=function(e){n("columnGap",e),n("columnMaxWidth",e),n("columnMinWidth",e),n("fontSize",e),n("fontSelection",e),n("mediaOverlaysPreservePlaybackWhenScroll",e),n("mediaOverlaysSkipSkippables",e),n("mediaOverlaysEscapeEscapables",e),n("mediaOverlaysSkippables",e,t),n("mediaOverlaysEscapables",e,t),n("mediaOverlaysEnableClick",e),n("mediaOverlaysRate",e),n("mediaOverlaysVolume",e),n("mediaOverlaysSynchronizationGranularity",e),n("mediaOverlaysAutomaticPageTurn",e),n("scroll",e),n("syntheticSpread",e),n("pageTransition",e),n("enableGPUHardwareAccelerationCSS3D",e)},this.update(e)}}),function(e,t){"function"==typeof define&&define.amd?define("ResizeSensor",t):"object"==typeof exports?module.exports=t():e.ResizeSensor=t()}("undefined"!=typeof window?window:this,function(){function e(e,t){var n=Object.prototype.toString.call(e),r="[object Array]"===n||"[object NodeList]"===n||"[object HTMLCollection]"===n||"[object Object]"===n||"undefined"!=typeof jQuery&&e instanceof jQuery||"undefined"!=typeof Elements&&e instanceof Elements,i=0,o=e.length;if(r)for(;i<o;i++)t(e[i]);else t(e)}function t(e){if(!e.getBoundingClientRect)return{width:e.offsetWidth,height:e.offsetHeight};var t=e.getBoundingClientRect();return{width:Math.round(t.width),height:Math.round(t.height)}}if("undefined"==typeof window)return null;var n=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(e){return window.setTimeout(e,20)},r=function(i,o){function a(){var e=[];this.add=function(t){e.push(t)};var t,n;this.call=function(r){for(t=0,n=e.length;t<n;t++)e[t].call(this,r)},this.remove=function(r){var i=[];for(t=0,n=e.length;t<n;t++)e[t]!==r&&i.push(e[t]);e=i},this.length=function(){return e.length}}function s(e,r){if(e){if(e.resizedAttached)return void e.resizedAttached.add(r);e.resizedAttached=new a,e.resizedAttached.add(r),e.resizeSensor=document.createElement("div"),e.resizeSensor.dir="ltr",e.resizeSensor.className="resize-sensor";var i="position: absolute; left: -10px; top: -10px; right: 0; bottom: 0; overflow: hidden; z-index: -1; visibility: hidden; max-width: 100%",o="position: absolute; left: 0; top: 0; transition: 0s;";e.resizeSensor.style.cssText=i,e.resizeSensor.innerHTML='<div class="resize-sensor-expand" style="'+i+'"><div style="'+o+'" class="resize-sensor-inner"></div></div><div class="resize-sensor-shrink" style="'+i+'"><div style="'+o+' width: 200%; height: 200%" class="resize-sensor-inner"></div></div>',e.appendChild(e.resizeSensor);var s=window.getComputedStyle(e),l=s?s.getPropertyValue("position"):null;"absolute"!==l&&"relative"!==l&&"fixed"!==l&&(e.style.position="relative");var u,c,f,d=e.resizeSensor.childNodes[0],h=d.childNodes[0],p=e.resizeSensor.childNodes[1],g=t(e),m=g.width,v=g.height,y=!0,E=function(){h.style.width="100000px",h.style.height="100000px",d.scrollLeft=1e5,d.scrollTop=1e5,p.scrollLeft=1e5,p.scrollTop=1e5},b=function(){if(y){if(!d.scrollTop&&!d.scrollLeft)return E(),void(f||(f=n(function(){f=0,b()})));y=!1}E()};e.resizeSensor.resetSensor=b;var I=function(){c=0,u&&(m=g.width,v=g.height,e.resizedAttached&&e.resizedAttached.call(g))},T=function(){g=t(e),u=g.width!==m||g.height!==v,u&&!c&&(c=n(I)),b()},w=function(e,t,n){e.attachEvent?e.attachEvent("on"+t,n):e.addEventListener(t,n)};w(d,"scroll",T),w(p,"scroll",T),n(b)}}var l;"undefined"!=typeof ResizeObserver?(l=new ResizeObserver(function(t){e(t,function(e){o.call(this,{width:e.contentRect.width,height:e.contentRect.height})})}),void 0!==i&&e(i,function(e){l.observe(e)})):e(i,function(e){s(e,o)}),this.detach=function(t){"undefined"!=typeof ResizeObserver?e(i,function(e){l.unobserve(e)
}):r.detach(i,t)},this.reset=function(){i.resizeSensor.resetSensor()}};return r.reset=function(t,n){e(t,function(e){e.resizeSensor.resetSensor()})},r.detach=function(t,n){e(t,function(e){e&&(e.resizedAttached&&"function"==typeof n&&(e.resizedAttached.remove(n),e.resizedAttached.length())||e.resizeSensor&&(e.contains(e.resizeSensor)&&e.removeChild(e.resizeSensor),delete e.resizeSensor,delete e.resizedAttached))})},r}),define("readium_shared_js/views/one_page_view",["../globals","jquery","underscore","eventEmitter","./cfi_navigation_logic","../helpers","../models/viewer_settings","../models/bookmark_data","ResizeSensor"],function(e,t,n,r,i,o,a,s,l){var u=function(c,f,d,h){function p(e){if(e){F=!0;var n=O[0].contentDocument;S=t("html",n),S&&0!=S.length?(_=t("body",S),V||_.css("margin","0")):(S=t("svg",n),_=void 0),V&&R.applyBookStyles(),y(),g(),k.onIFrameLoad()}}function g(){if(_&&V){var n=_[0];if(n.resizeSensor)return;L.width=t(n).width(),L.height=t(n).height(),n.resizeSensor=new l(n,function(){var r={width:t(n).width(),height:t(n).height()};if(console.debug("OnePageView content resized ...",r.width,r.height,P.idref),r.width!=L.width||r.height!=L.height){L.width=r.width,L.height=r.height,console.debug("... updating pagination.");var i=D.package.resolveRelativeUrl(P.href);e.logEvent("OnePageView.Events.CONTENT_SIZE_CHANGED","EMIT","one_page_view.js [ "+P.href+" -- "+i+" ]"),R.emit(u.Events.CONTENT_SIZE_CHANGED,O,P)}else console.debug("... ignored (identical dimensions).")})}}function m(){if(V&&S&&B){var e=B.fontSelection,t=!h.fonts||!h.fonts.length||e<=0||e-1>=h.fonts.length,n=t?{}:h.fonts[e-1];o.UpdateHtmlFontAttributes(S,B.fontSize,n,function(){})}}function v(){if(!O||!O.length)return 0;if(o.isIframeAlive(O[0])){var e=O[0].contentWindow,t=O[0].contentDocument;return Math.round(parseFloat(e.getComputedStyle(t.documentElement).height))}if(S){console.error("getContentDocHeight ??");return S.height()}return 0}function y(){if(U.width=0,U.height=0,!V){var e=void 0,n=void 0,r=void 0,i=O[0].contentDocument,o=t("meta[name=viewport]",i).attr("content");if(o||(o=t("meta[name=viewbox]",i).attr("content")),o&&(e=b(o)),!e&&i&&i.documentElement&&i.documentElement.nodeName&&"svg"==i.documentElement.nodeName.toLowerCase()){var a=void 0,s=void 0,l=i.documentElement.getAttribute("width"),u=l&&l.length>=1&&"%"==l[l.length-1];if(l)try{a=parseInt(l,10)}catch(e){}a&&u&&(n=a,a=void 0);var c=i.documentElement.getAttribute("height"),f=c&&c.length>=1&&"%"==c[c.length-1];if(c)try{s=parseInt(c,10)}catch(e){}s&&f&&(r=s,s=void 0),a&&s&&(e={width:a,height:s})}if(!e&&P&&(o=P.getRenditionViewport())&&(e=b(o))&&console.log("Viewport: using rendition:viewport dimensions"),!e){var d=t(i).find("img");if(d.length>0){e={width:d.width(),height:d.height()};P&&P.media_type&&P.media_type.length&&0==P.media_type.indexOf("image/")||console.warn("Viewport: using img dimensions!")}else if(d=t(i).find("image"),d.length>0){var a=void 0,s=void 0,l=d[0].getAttribute("width");if(l)try{a=parseInt(l,10)}catch(e){}var c=d[0].getAttribute("height");if(c)try{s=parseInt(c,10)}catch(e){}a&&s&&(e={width:a,height:s},!0,console.warn("Viewport: using image dimensions!"))}}if(!e){a=M.width(),s=M.height();t("iframe.iframe-fixed",M).length>1&&(a*=.5),n&&(a*=n/100),r&&(s*=r/100),e={width:a,height:s},!0,console.warn("Viewport: using browser / e-reader viewport dimensions!")}e&&(U.width=e.width,U.height=e.height)}}function E(t){t&&(e.logEvent("CONTENT_DOCUMENT_UNLOADED","EMIT","one_page_view.js [ "+t.href+" ]"),R.emit(e.Events.CONTENT_DOCUMENT_UNLOADED,O,t))}function b(e){for(var t=e.replace(/\s/g,"").split(","),n={},r=0;r<t.length;r++){var i=t[r].split("=");2==i.length&&(n[i[0]]=i[1])}var o=Number.NaN,a=Number.NaN;if(n.width&&(o=parseInt(n.width)),n.height&&(a=parseInt(n.height)),!isNaN(o)&&!isNaN(a))return{width:o,height:a}}function I(){return{top:-C.parent().scrollTop(),left:0}}function T(){if(h.needsFixedLayoutScalerWorkAround()){var e=C.parent()[0];return{width:e.clientWidth,height:e.clientHeight}}return{width:U.width,height:U.height}}function w(e){return P?new s(P.idref,e):null}t.extend(this,new r);var S,_,C,O,P,N,R=this,D=c.spine,x=c.iframeLoader,A=c.bookStyles,M=c.$viewport,F=!1,L={width:void 0,height:void 0},j=function(e){var t=function(e,t){this.begin=e,this.end=t},n=new t(function(e,t,n,r,i,o,a){r.css("opacity","0")},function(e,t,n,r,i,a,s){r.css("transform","none"),o.CSSTransition(r,"opacity 150ms ease-out"),r.css("opacity","1")}),r=new t(function(e,t,n,r,i,a,s){r.css("opacity","0");var l=Math.ceil(i*e),u=.8*l*(2===s?1:-1),c=o.CSSTransformString({left:Math.round(u),origin:"50% 50% 0",enable3D:d});r.css(c)},function(e,t,n,r,i,a,s){r.css("opacity","1"),o.CSSTransition(r,"transform 150ms ease-out"),r.css("transform","none")}),i=new t(function(e,t,n,r,i,a,s){r.css("opacity","0");var l=Math.ceil(i*e),u=1.7*l*(2===s?1:-1),c=o.CSSTransformString({left:Math.round(u),angle:30*(2===s?-1:1),origin:"50% 50% 0",enable3D:d});r.css(c)},function(e,t,n,r,i,a,s){r.css("opacity","1"),o.CSSTransition(r,"transform 300ms ease-in-out"),r.css("transform","none")}),s=new t(function(e,t,n,r,i,a,s){r.css("opacity","0");for(var l=!1,u=!1,c=0;c<f.length;c++){var h=f[c].toLowerCase();if(h.indexOf("left")>=0){l=!0;break}if(h.indexOf("right")>=0){!0;break}if(h.indexOf("center")>=0){u=!0;break}}var p=Math.ceil(i*e),g=.5*p*(l||u&&1===s?1:-1),m=o.CSSTransformString({scale:.2,left:Math.round(g),angle:30*(l||u&&1===s?1:-1),origin:"50% 50% 0",enable3D:d});r.css(m)},function(e,t,n,r,i,a,s){r.css("opacity","1"),o.CSSTransition(r,"transform 400ms ease-out"),r.css("transform","none")}),l=[];l.push(n),l.push(r),l.push(i),l.push(s);var u=e.disablePageTransitions||!1;u=!0;var c=-1,d=new a({}).enableGPUHardwareAccelerationCSS3D,h=void 0;this.updateOptions=function(e){h=e;var t=h;t&&void 0!==t.enableGPUHardwareAccelerationCSS3D||(t=new a({})),t.enableGPUHardwareAccelerationCSS3D&&(d=!0),null!==e.pageTransition&&void 0!==e.pageTransition&&(c=e.pageTransition)},this.updateOptions(e);var p=0,g=!1,m=!1;this.updatePageSwitchDir=function(e,t){m||(p=e,g=t)},this.onIFrameLoad=function(){m=!0},this.transformContentImmediate_BEGIN=function(e,t,n,r){var i=g||m;if(m=!1,!u&&-1!==c&&(o.CSSTransition(e,"all 0 ease 0"),i)){var a=c>=0&&c<l.length?l[c]:void 0;0!==p&&a?a.begin(t,n,r,e,R.meta_width(),R.meta_height(),p):e.css("opacity","0")}},this.transformContentImmediate_END=function(e,t,n,r){if(u||-1===c)return void e.css("transform","none");setTimeout(function(){var i=c>=0&&c<l.length?l[c]:void 0;0!==p&&i?i.end(t,n,r,e,R.meta_width(),R.meta_height(),p):(e.css("transform","none"),o.CSSTransition(e,"opacity 250ms linear"),e.css("opacity","1"))},10)}},k=new j(c),V=d||!1,U={width:0,height:0};this.element=function(){return C},this.meta_height=function(){return U.height},this.meta_width=function(){return U.width},this.isDisplaying=function(){return F},this.render=function(){var e=o.loadTemplate("single_page_frame",{});C=t(e),N=t("#scaler",C),o.CSSTransition(C,"all 0 ease 0"),C.css("transform","none");var n=h.viewerSettings();n&&void 0!==n.enableGPUHardwareAccelerationCSS3D||(n=new a({})),n.enableGPUHardwareAccelerationCSS3D&&C.css("transform","translateZ(0)"),C.css("height","100%"),C.css("width","100%");for(var r=0,i=f.length;r<i;r++)C.addClass(f[r]);return O=t("iframe",C),this},this.decorateIframe=function(){O&&O.length&&(O.css("border-bottom","1px dashed silver"),O.css("border-top","1px dashed silver"))},this.remove=function(){this.clear(),P=void 0,C&&C[0]&&C.remove(),C=void 0,N=void 0,O=void 0},this.clear=function(){F=!1,O&&O[0]&&(O[0].src="")},this.currentSpineItem=function(){return P};var B=void 0;this.setViewSettings=function(e,t){B=e,V&&!t&&R.applyBookStyles(),y(),k.updateOptions(e)},this.applyBookStyles=function(){V&&S&&(o.setStyles(A.getStyles(),S),m())},this.scaleToWidth=function(e){if(!(V||U.width<=0)){var t=e/U.width;R.transformContentImmediate(t,0,0)}},this.resizeIFrameToContent=function(){var e=v();R.setHeight(e),R.showIFrame()},this.setHeight=function(e){N.css("height",e+"px"),C.css("height",e+"px")};this.showIFrame=function(){O.css("visibility","visible"),O.css("transform","none");var e=B;e&&void 0!==e.enableGPUHardwareAccelerationCSS3D||(e=new a({})),e.enableGPUHardwareAccelerationCSS3D&&(!0,O.css("transform","translateZ(0)"))},this.hideIFrame=function(){O.css("visibility","hidden");var e=!1,t=B;t&&void 0!==t.enableGPUHardwareAccelerationCSS3D||(t=new a({})),t.enableGPUHardwareAccelerationCSS3D&&(e=!0);var n=o.CSSTransformString({left:"10000",top:"10000",enable3D:e});O.css(n)},this.updatePageSwitchDir=function(e,t){k.updatePageSwitchDir(e,t)},this.transformContentImmediate=function(e,t,n){if(!V){var r=Math.ceil(U.width*e),i=Math.floor(U.height*e);if(k.transformContentImmediate_BEGIN(C,e,t,n),C.css("left",t+"px"),C.css("top",n+"px"),C.css("width",r+"px"),C.css("height",i+"px"),S){var s=!1,l=B;if(l&&void 0!==l.enableGPUHardwareAccelerationCSS3D||(l=new a({})),l.enableGPUHardwareAccelerationCSS3D&&(s=!0),_&&h.needsFixedLayoutScalerWorkAround()){var u=o.CSSTransformString({scale:e,enable3D:s});u["min-width"]=U.width,u["min-height"]=U.height,S.css(u),_&&_.length&&_.css({width:U.width,height:U.height});var c=o.CSSTransformString({scale:1,enable3D:s});c.width=U.width*e,c.height=U.height*e,N.css(c)}else{var f=o.CSSTransformString({scale:e,enable3D:s});f.width=U.width,f.height=U.height,N.css(f)}S.css("opacity","0.999"),R.showIFrame(),setTimeout(function(){S.css("opacity","1")},0),k.transformContentImmediate_END(C,e,t,n)}}},this.getCalculatedPageHeight=function(){return C.height()},this.transformContent=n.bind(n.debounce(this.transformContentImmediate,50),R),this.onUnload=function(){E(P)},this.loadSpineItem=function(t,n,r){if(P!=t){var i=P;P=t;var a=D.package.resolveRelativeUrl(t.href);R.hideIFrame(),E(i),e.logEvent("OnePageView.Events.SPINE_ITEM_OPEN_START","EMIT","one_page_view.js [ "+t.href+" -- "+a+" ]"),R.emit(u.Events.SPINE_ITEM_OPEN_START,O,P),x.loadIframe(O[0],a,function(e){if(e&&n){var i=function(){n(e,O,P,!0,r)};o.isIframeAlive(O[0])?(p(e),i()):(console.error("onIFrameLoad !! doc && win + TIMEOUT"),console.debug(t.href),p(e),setTimeout(i,500))}else p(e)},R,{spineItem:P})}else n&&n(!0,O,P,!1,r)},this.getNavigator=function(){return new i({$iframe:O,frameDimensionsGetter:T,visibleContentOffsetsGetter:I,classBlacklist:["cfi-marker","mo-cfi-highlight","resize-sensor","resize-sensor-expand","resize-sensor-shrink","resize-sensor-inner","js-hypothesis-config","js-hypothesis-embed"],elementBlacklist:["hypothesis-adder"],idBlacklist:["MathJax_Message","MathJax_SVG_Hidden"]})},this.getElementByCfi=function(e,t,n,r,i){return e!=P.idref?void console.error("spine item is not loaded"):R.getNavigator().getElementByCfi(t,n,r,i)},this.getElementById=function(e,t){return e!=P.idref?void console.error("spine item is not loaded"):R.getNavigator().getElementById(t)},this.getElement=function(e,t){return e!=P.idref?void console.error("spine item is not loaded"):R.getNavigator().getElement(t)},this.getFirstVisibleMediaOverlayElement=function(){return R.getNavigator().getFirstVisibleMediaOverlayElement()},this.offset=function(){if(O)return O.offset()},this.getVisibleElementsWithFilter=function(e){return R.getNavigator().getVisibleElementsWithFilter(null,e)},this.getVisibleElements=function(e){return R.getNavigator().getAllVisibleElementsWithSelector(e)},this.getAllElementsWithFilter=function(e,t){return R.getNavigator().getAllElementsWithFilter(e,t)},this.getElements=function(e,t){return e!=P.idref?void console.error("spine item is not loaded"):R.getNavigator().getElements(t)},this.getNodeRangeInfoFromCfi=function(e,t){return e!=P.idref?void console.warn("spine item is not loaded"):R.getNavigator().getNodeRangeInfoFromCfi(t)},this.getLoadedContentFrames=function(){return[{spineItem:P,$iframe:O}]},this.getFirstVisibleCfi=function(e,t){return w(R.getNavigator().getFirstVisibleCfi(e,t))},this.getLastVisibleCfi=function(e,t){return w(R.getNavigator().getLastVisibleCfi(e,t))},this.getDomRangeFromRangeCfi=function(e,t,n){return R.getNavigator().getDomRangeFromRangeCfi(e,t,n)},this.getRangeCfiFromDomRange=function(e){return w(R.getNavigator().getRangeCfiFromDomRange(e))},this.getVisibleCfiFromPoint=function(e,t,n){return w(R.getNavigator().getVisibleCfiFromPoint(e,t,n))},this.getRangeCfiFromPoints=function(e,t,n,r){return w(R.getNavigator().getRangeCfiFromPoints(e,t,n,r))},this.getCfiForElement=function(e){return w(R.getNavigator().getCfiForElement(e))},this.getElementFromPoint=function(e,t){return R.getNavigator().getElementFromPoint(e,t)},this.getStartCfi=function(){return w(R.getNavigator().getStartCfi())},this.getEndCfi=function(){return w(R.getNavigator().getEndCfi())},this.getNearestCfiFromElement=function(e){return w(R.getNavigator().getNearestCfiFromElement(e))}};return u.Events={SPINE_ITEM_OPEN_START:"SpineItemOpenStart",CONTENT_SIZE_CHANGED:"ContentSizeChanged"},u}),define("readium_shared_js/models/page_open_request",[],function(){return function(e,t){this.spineItem=e,this.spineItemPageIndex=void 0,this.elementId=void 0,this.elementCfi=void 0,this.firstVisibleCfi=void 0,this.lastVisibleCfi=void 0,this.firstPage=!1,this.lastPage=!1,this.initiator=t,this.reset=function(){this.spineItemPageIndex=void 0,this.elementId=void 0,this.elementCfi=void 0,this.firstPage=!1,this.lastPage=!1},this.setFirstPage=function(){this.reset(),this.firstPage=!0},this.setLastPage=function(){this.reset(),this.lastPage=!0},this.setPageIndex=function(e){this.reset(),this.spineItemPageIndex=e},this.setElementId=function(e){this.reset(),this.elementId=e},this.setElementCfi=function(e){this.reset(),this.elementCfi=e},this.setFirstAndLastVisibleCfi=function(e,t){this.reset(),this.firstVisibleCfi=e,this.lastVisibleCfi=t}}}),define("readium_shared_js/views/fixed_view",["../globals","jquery","underscore","eventEmitter","../models/bookmark_data","../models/current_pages_info","../models/fixed_page_spread","./one_page_view","../models/page_open_request","../helpers"],function(e,t,n,r,i,o,a,s,l,u){return function(n,c){function f(t){var r=new s(n,[t],!1,c);return r.on(s.Events.SPINE_ITEM_OPEN_START,function(t,n){e.logEvent("OnePageView.Events.SPINE_ITEM_OPEN_START","ON","fixed_view.js [ "+n.href+" ]"),e.logEvent("CONTENT_DOCUMENT_LOAD_START","EMIT","fixed_view.js [ "+n.href+" ]"),O.emit(e.Events.CONTENT_DOCUMENT_LOAD_START,t,n)}),r.on(e.Events.CONTENT_DOCUMENT_UNLOADED,function(t,n){e.logEvent("CONTENT_DOCUMENT_UNLOADED","ON","fixed_view.js [ "+n.href+" ]"),e.logEvent("CONTENT_DOCUMENT_UNLOADED","EMIT","fixed_view.js [ "+n.href+" ]"),O.emit(e.Events.CONTENT_DOCUMENT_UNLOADED,t,n)}),r}function d(){return V.validItems()[0]}function h(e,n){if(U)return void(B={initiator:e,paginationRequest:n});U=!0;var r={isElementAdded:!1},i=p([{pageView:A,spineItem:V.leftItem,context:r},{pageView:M,spineItem:V.rightItem,context:r},{pageView:F,spineItem:V.centerItem,context:r}]);t.when.apply(t,i).done(function(){if(U=!1,B){var t=B.initiator,i=B.paginationRequest;B=void 0,h(t,i)}else r.isElementAdded&&(u.setStyles(R.getStyles(),_.parent()),I()),n?g(e,n.spineItem,n.elementId):g(e)})}function p(e){for(var t=[],n=0;n<e.length;n++){var r=T(e[n].pageView,e[n].spineItem,e[n].context);t.push(r)}return t}function g(t,n,r){b(),y(),window.setTimeout(function(){e.logEvent("InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED","EMIT","fixed_view.js"),O.emit(e.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:O.getPaginationInfo(),initiator:t,spineItem:n,elementId:r})},60)}function m(e,t){var n=new a(N,t);return n.openItem(e),V.leftItem!=n.leftItem||V.rightItem!=n.rightItem||V.centerItem!=n.centerItem}function v(){if(!k||!j)return!1;var e=P.width(),t=P.height();return e&&t}function y(t){if(G(0,!1),v()){var n=P.width(),r=P.height(),i=A.isDisplaying()?u.Margins.fromElement(A.element()):u.Margins.empty(),o=M.isDisplaying()?u.Margins.fromElement(M.element()):u.Margins.empty(),a=F.isDisplaying()?u.Margins.fromElement(F.element()):u.Margins.empty(),s=E(i,o,a),l={width:n-j.width(),height:r-j.height()},c={width:l.width-s.width(),height:l.height-s.height()};if(!(l.width<=0||l.height<=0)){var f=c.width/k.width,d=c.height/k.height;P.css("overflow","auto");var h;"fit-width"==D.style?h=f:"fit-height"==D.style?h=d:"user"==D.style?h=D.scale:(h=Math.min(f,d),P.css("overflow","hidden")),C=h;var p={width:k.width*h,height:k.height*h},g={width:p.width+s.width(),height:p.height+s.height()},m={width:g.width+j.width(),height:g.height+j.height()},y=Math.floor((n-m.width)/2),b=Math.floor((r-m.height)/2);y<0&&(y=0),b<0&&(b=0),_.css("left",y+"px"),_.css("top",b+"px"),_.css("width",g.width+"px"),_.css("height",g.height+"px");var I=j.padding.left,T=j.padding.top,w=t?"transformContentImmediate":"transformContent";A.isDisplaying()&&A[w](h,I,T),M.isDisplaying()&&(I+=k.separatorPosition*h,A.isDisplaying()&&(I+=i.left),M[w](h,I,T)),F.isDisplaying()&&F[w](h,I,T),e.logEvent("FXL_VIEW_RESIZED","EMIT","fixed_view.js"),O.emit(e.Events.FXL_VIEW_RESIZED)}}}function E(e,t,n){var r={left:Math.max(e.margin.left,t.margin.left,n.margin.left),right:Math.max(e.margin.right,t.margin.right,n.margin.right),top:Math.max(e.margin.top,t.margin.top,n.margin.top),bottom:Math.max(e.margin.bottom,t.margin.bottom,n.margin.bottom)},i={left:Math.max(e.border.left,t.border.left,n.border.left),right:Math.max(e.border.right,t.border.right,n.border.right),top:Math.max(e.border.top,t.border.top,n.border.top),bottom:Math.max(e.border.bottom,t.border.bottom,n.border.bottom)},o={left:Math.max(e.padding.left,t.padding.left,n.padding.left),right:Math.max(e.padding.right,t.padding.right,n.padding.right),top:Math.max(e.padding.top,t.padding.top,n.padding.top),bottom:Math.max(e.padding.bottom,t.padding.bottom,n.padding.bottom)};return new u.Margins(r,i,o)}function b(){k={},F.isDisplaying()?(k.width=F.meta_width(),k.height=F.meta_height(),k.separatorPosition=0):A.isDisplaying()&&M.isDisplaying()?A.meta_height()==M.meta_height()?(k.width=A.meta_width()+M.meta_width(),k.height=A.meta_height(),k.separatorPosition=A.meta_width()):(k.width=A.meta_width()+M.meta_width()*(A.meta_height()/M.meta_height()),k.height=A.meta_height(),k.separatorPosition=A.meta_width()):A.isDisplaying()?(k.width=2*A.meta_width(),k.height=A.meta_height(),k.separatorPosition=A.meta_width()):M.isDisplaying()?(k.width=2*M.meta_width(),k.height=M.meta_height(),k.separatorPosition=M.meta_width()):k=void 0}function I(){j=u.Margins.fromElement(_)}function T(n,r,i){var o=t.Deferred();return r?(n.remove(),_.append(n.render().element()),i.isElementAdded=!0,n.loadSpineItem(r,function(t,r,i,a,s){t&&a&&(n.meta_height()&&n.meta_width()||console.error("Invalid document "+i.href+": viewport is not specified!"),e.logEvent("CONTENT_DOCUMENT_LOADED","EMIT","fixed_view.js [ "+i.href+" ]"),O.emit(e.Events.CONTENT_DOCUMENT_LOADED,r,i)),o.resolve()},i)):(n.isDisplaying()&&n.remove(),o.resolve()),o.promise()}function w(){var e=[];e=N.isLeftToRight()?[A,F,M]:[M,F,A];for(var t=[],n=0,r=e.length;n<r;n++)e[n].isDisplaying()&&t.push(e[n]);return t}function S(e,t){for(var n=w(),r=0,i=n.length;r<i;r++){var o=n[r];if(o.currentSpineItem().idref==e)return t(o)}console.error("spine item is not loaded")}t.extend(this,new r);var _,C,O=this,P=t(n.$viewport),N=n.spine,R=n.userStyles,D=(n.bookStyles,n.zoom||{style:"default"}),x=(n.iframeLoader,void 0),A=f("fixed-page-frame-left"),M=f("fixed-page-frame-right"),F=f("fixed-page-frame-center"),L=[];L.push(A),L.push(M),L.push(F);var j,k,V=new a(N,!1),U=!1,B=!1;this.isReflowable=function(){return!1},this.setZoom=function(e){D=e,y(!1)},this.render=function(){var e=u.loadTemplate("fixed_book_frame",{});return _=t(e),u.CSSTransition(_,"all 0 ease 0"),_.css("overflow","hidden"),P.append(_),O.applyStyles(),this},this.remove=function(){_.remove()},this.setViewSettings=function(e,t){x=e,V.setSyntheticSpread(1==u.deduceSyntheticSpread(P,d(),x));for(var n=w(),r=0,i=n.length;r<i;r++)n[r].setViewSettings(e,t)};var G=function(e,t){A&&A.updatePageSwitchDir(e,t),M&&M.updatePageSwitchDir(e,t),F&&F.updatePageSwitchDir(e,t)};this.applyStyles=function(){u.setStyles(R.getStyles(),_.parent()),I(),b(),y()},this.applyBookStyles=function(){for(var e=w(),t=0,n=e.length;t<n;t++)e[t].applyBookStyles()},this.onViewportResize=function(){var e=d();if(e){var t=1==u.deduceSyntheticSpread(P,e,x);if(m(e,t)){V.setSyntheticSpread(t);var n=new l(e,O);O.openPage(n)}else y(!0)}},this.getViewScale=function(){return C},this.openPage=function(e,t){if(e.spineItem){var n=V.leftItem,r=V.rightItem,i=V.centerItem,o=1==u.deduceSyntheticSpread(P,e.spineItem,x);V.setSyntheticSpread(o),V.openItem(e.spineItem);var a=n!==V.leftItem||r!==V.rightItem||i!==V.centerItem;null!==t&&void 0!==t||(t=0),G(0===t?0:V.spine.isRightToLeft()?1===t?2:1:t,a),h(e.initiator,e)}},this.openPagePrev=function(e){V.openPrev(),G(V.spine.isRightToLeft()?2:1,!0),h(e,void 0)},this.openPageNext=function(e){V.openNext(),G(V.spine.isRightToLeft()?1:2,!0),h(e,void 0)},this.getPaginationInfo=function(){for(var e=new o(N,!0),t=[V.leftItem,V.rightItem,V.centerItem],n=0;n<t.length;n++){var r=t[n];r&&e.addOpenPage(0,1,r.idref,r.index)}return e},this.bookmarkCurrentPage=function(){var e=w(),t=this.getLoadedSpineItems();return e.length>0?e[0].getFirstVisibleCfi():t.length>0?new i(this.getLoadedSpineItems()[0].idref,null):void 0},this.getLoadedSpineItems=function(){return V.validItems()},this.getElement=function(e,t){return S(e,function(n){return n.getElement(e,t)})},this.getElementById=function(e,t){return S(e,function(n){return n.getElementById(e,t)})},this.getElementByCfi=function(e,t,n,r,i){return S(e,function(o){return o.getElementByCfi(e,t,n,r,i)})},this.getFirstVisibleMediaOverlayElement=function(){for(var e=w(),t=0,n=e.length;t<n;t++){var r=e[t].getFirstVisibleMediaOverlayElement();if(r)return r}},this.insureElementVisibility=function(e,t,n){},this.getElements=function(e,t){return S(e,function(n){return n.getElements(e,t)})},this.isElementVisible=function(e){return!0},this.getVisibleElementsWithFilter=function(e,t){for(var n=[],r=w(),i=0,o=r.length;i<o;i++)n.push(r[i].getAllElementsWithFilter(e,t));return n},this.getVisibleElements=function(e,t){for(var n=[],r=w(),i=0,o=r.length;i<o;i++)t?n.push({elements:r[i].getElements(r[i].currentSpineItem().idref,e),spineItem:r[i].currentSpineItem()}):n.push(r[i].getElements(r[i].currentSpineItem().idref,e));return n},this.isElementVisible=function(e){return!0},this.isVisibleSpineItemElementCfi=function(e,t){return S(e,function(e){return!0})},this.getNodeRangeInfoFromCfi=function(e,t){return S(e,function(n){return n.getNodeRangeInfoFromCfi(e,t)})},this.getFirstVisibleCfi=function(){var e=w();if(e.length>0)return e[0].getFirstVisibleCfi()},this.getLastVisibleCfi=function(){var e=w();if(e.length>0)return e[e.length-1].getLastVisibleCfi()},this.getDomRangesFromRangeCfi=function(e,t,n){var r=w();if(t&&e.idref!==t.idref){for(var i=[],o=0,a=r.length;o<a;o++){var s=r[o];if(s.currentSpineItem().idref===e.idref){var l=s.getLastVisibleCfi();i.push(s.getDomRangeFromRangeCfi(e.contentCFI,l.contentCFI,n))}else if(s.currentSpineItem().idref===t.idref){var u=s.getFirstVisibleCfi();i.push(s.getDomRangeFromRangeCfi(u.contentCFI,t.contentCFI,n))}}return i}return[this.getDomRangeFromRangeCfi(e,t,n)]},this.getDomRangeFromRangeCfi=function(e,t,n){var r=w();if(t&&e.idref!==t.idref)return void console.error("getDomRangeFromRangeCfi: both CFIs must be scoped under the same spineitem idref");for(var i=0,o=r.length;i<o;i++){var a=r[i];if(a.currentSpineItem().idref===e.idref)return a.getDomRangeFromRangeCfi(e.contentCFI,t?t.contentCFI:null,n)}},this.getRangeCfiFromDomRange=function(e){for(var t=w(),n=0,r=t.length;n<r;n++){var i=t[n];if(i.getLoadedContentFrames()[0].$iframe[0].contentDocument===e.startContainer.ownerDocument)return i.getRangeCfiFromDomRange(e)}},this.getVisibleCfiFromPoint=function(e,t,n,r){if(!r)throw new Error("getVisibleCfiFromPoint: Spine item idref must be specified for this fixed layout view.");return S(r,function(r){return r.getVisibleCfiFromPoint(e,t,n)})},this.getRangeCfiFromPoints=function(e,t,n,r,i){if(!i)throw new Error("getRangeCfiFromPoints: Spine item idref must be specified for this fixed layout view.");return S(i,function(i){return i.getRangeCfiFromPoints(e,t,n,r)})},this.getCfiForElement=function(e){for(var t=w(),n=0,r=t.length;n<r;n++){var i=t[n];if(i.getLoadedContentFrames()[0].$iframe[0].contentDocument===e.ownerDocument)return i.getCfiForElement(e)}},this.getElementFromPoint=function(e,t,n){if(!n)throw new Error("getElementFromPoint: Spine item idref must be specified for this fixed layout view.");return S(n,function(n){return n.getElementFromPoint(e,t)})},this.getStartCfi=function(){return w()[0].getStartCfi()},this.getEndCfi=function(){return w()[0].getEndCfi()},this.getNearestCfiFromElement=function(e){for(var t=w(),n=0,r=t.length;n<r;n++){var i=t[n];if(i.getLoadedContentFrames()[0].$iframe[0].contentDocument===e.ownerDocument)return i.getNearestCfiFromElement(e)}}}}),define("readium_shared_js/views/iframe_loader",["jquery","underscore","URIjs"],function(e,t,n){return function(){var r=this,i={};this.addIFrameEventListener=function(e,t,n){void 0==i[e]&&(i[e]=[]),i[e].push({callback:t,context:n})},this.updateIframeEvents=function(n){t.each(i,function(t,r){e(n.contentWindow).off(r);for(var i=0,o=t.length;i<o;i++)e(n.contentWindow).on(r,t[i].callback,t[i].context)})},this.loadIframe=function(e,t,i,o,a){e.baseURI||("undefined"!=typeof location&&(e.baseURI=location.href+""),console.error("!iframe.baseURI => "+e.baseURI)),console.log("EPUB doc iframe src:"),console.log(t),console.log("EPUB doc iframe base URI:"),console.log(e.baseURI),e.setAttribute("data-baseUri",e.baseURI),e.setAttribute("data-src",t);var s=new n(t).absoluteTo(e.baseURI).search("").hash("").toString();r._loadIframeWithUri(e,a,s,function(){i.call(o,!0,a)})},this._loadIframeWithUri=function(n,i,o,a){n.onload=function(){var i=n.contentDocument||n.contentWindow.document;e("svg",i).on("load",function(){console.log("SVG loaded")}),r.updateIframeEvents(n);var o=n.contentWindow.MathJax;if(o){console.log("MathJax VERSION: "+o.cdnVersion+" // "+o.fileversion+" // "+o.version);var s=!0;o.Hub.Browser.isFirefox&&(s=!1),o.Hub.Browser.isChrome&&(s=!1),window.navigator.userAgent.indexOf("Edge")>0&&(s=!1),o.Hub.Config({showMathMenu:!1,messageStyle:"none",showProcessingMessages:!0,SVG:{useFontCache:s}});var l=t.once(a);try{o.Hub.Queue(l)}catch(e){console.error("MathJax fail!"),a()}}else a()},n.setAttribute("src",o)}}}),define("readium_shared_js/views/internal_links_support",["jquery","../helpers","readium_cfi_js","URIjs"],function(e,t,n,r){return function(i){function o(e){var t=e.indexOf("("),n=e.indexOf("!"),r=e.indexOf(")");if(-1!=n)return-1==r&&(r=e.length),{spineItemCfi:e.substring(t+1,n),elementCfi:e.substring(n+1,r)}}function a(e,t){var n=i.package().resolveRelativeUrl(t.href);return e.absoluteTo(n)}function s(e,r){var s=a(e,r);if(!s)return void console.error("Unable to resolve "+e.href());var u=e.fragment(),c=s.toString();c=t.RemoveFromString(c,"#"+u),l(c,function(e){if(e){var t=new window.DOMParser,r=t.parseFromString(e,"text/xml"),a=o(u);if(!a)return void console.warn("Unable to split cfi:"+u);var s=n.Interpreter.getContentDocHref("epubcfi("+a.spineItemCfi+")",r);if(s){var l=i.spine().getItemByHref(s);l?i.openSpineItemElementCfi(l.idref,a.elementCfi,f):console.warn("Unable to find spineItem with href="+s)}else console.warn("Unable to find document ref from "+u+" cfi")}})}function l(t,n){e.ajax({isLocal:0!==t.indexOf("http"),url:t,dataType:"text",async:!0,success:function(e){n(e)},error:function(e,r,i){console.error("Error when AJAX fetching "+t),console.error(r),console.error(i),n()}})}function u(e){var n=e.filename();return n&&t.EndsWith(n,".opf")}function c(e,t){var n,o=e.filename();if(o){var a=new r(e,t.href),s=decodeURIComponent(a.pathname()),l=i.spine().getItemByHref(s);if(!l)return void console.error("spine item with href="+s+" not found");n=l.idref}else n=t.idref;var u=e.fragment();i.openSpineItemElementId(n,u,f)}var f=this;this.processLinkElements=function(t,n){var i=t[0].contentDocument;e("a",i).click(function(e){var t;t=e.currentTarget.attributes["xlink:href"]?e.currentTarget.attributes["xlink:href"].value:e.currentTarget.attributes.href.value;var i=!1,o=new r(t);o.is("relative")?u(o)?(s(o,n),i=!0):(c(o,n),i=!0):(window.open(t,"_blank"),i=!0),i&&(e.preventDefault(),e.stopPropagation())})}}}),define("readium_shared_js/models/smil_iterator",["jquery","../helpers"],function(e,t){return function(n){function r(e,t,n){for(var i=e,o=t.children.length;i>=0&&i<o;i+=n?-1:1){var a=t.children[i];if("par"==a.nodeType)return a;if(a=r(n?a.children.length-1:0,a,n))return a}if(t.parent)return r(t.index+(n?-1:1),t.parent,n)}this.smil=n,this.currentPar=void 0,this.reset=function(){this.currentPar=r(0,this.smil,!1)},this.findTextId=function(n){if(!this.currentPar)return void console.debug("Par iterator is out of range");if(!n)return!1;for(;this.currentPar;){if(this.currentPar.element){if(n===this.currentPar.text.srcFragmentId)return!0;for(var r=this.currentPar.element.parentNode;r;){if(r.id&&r.id==n)return!0;r=r.parentNode}var i=e("#"+t.escapeJQuerySelector(n),this.currentPar.element);if(i&&i.length&&i[0])return!0}this.next()}return!1},this.next=function(){if(!this.currentPar)return void console.debug("Par iterator is out of range");this.currentPar=r(this.currentPar.index+1,this.currentPar.parent,!1)},this.previous=function(){if(!this.currentPar)return void console.debug("Par iterator is out of range");this.currentPar=r(this.currentPar.index-1,this.currentPar.parent,!0)},this.isLast=function(){return this.currentPar?!r(this.currentPar.index+1,this.currentPar.parent,!1):void console.debug("Par iterator is out of range")},this.goToPar=function(e){for(;this.currentPar&&this.currentPar!=e;)this.next()},this.reset()}}),define("readium_shared_js/views/media_overlay_data_injector",["jquery","underscore","../helpers","../models/smil_iterator","readium_cfi_js"],function(e,t,n,r,i){return function(o,a){this.attachMediaOverlayData=function(s,l,u){var c=s[0].contentDocument.documentElement;if(l.media_overlay_id||0!==o.smil_models.length){var f=e("body",c);if(0==f.length)console.error("! BODY ???");else{if(f.data("mediaOverlayClick"))console.error("[WARN] already mediaOverlayClick");else{f.data("mediaOverlayClick",{ping:"pong"});var d=function(t){var n=e(this)[0];if(!(n=t.target))return a.touchInit(),!0;var r=void 0,i=n,o=!1;for("a"===i.nodeName.toLowerCase()&&(o=!0);!(r=e(i).data("mediaOverlayData"))&&("a"===i.nodeName.toLowerCase()&&(o=!0),i=i.parentNode););if(r&&(r.par||r.pars)){if(!u.mediaOverlaysEnableClick)return console.log("MO CLICK DISABLED"),a.touchInit(),!0;if(o)return console.log("MO CLICKED LINK"),a.touchInit(),!0;var s=r.par?r.par:r.pars[0];return i&&i!=n&&"body"===i.nodeName.toLowerCase()&&s&&!s.getSmil().id?(a.touchInit(),!0):(a.playUserPar(s),!0)}var l=e(n).attr("ibooks:readaloud");if(l||(l=e(n).attr("epub:readaloud")),l){console.debug("MO readaloud attr: "+l);var c=a.isPlaying();if("start"===l&&!c||"stop"===l&&c||"startstop"===l)return a.toggleMediaOverlay(),!0}return a.touchInit(),!0},h=t.debounce(d,200);"ontouchstart"in document.documentElement&&f[0].addEventListener("touchstart",h,!1),f[0].addEventListener("mousedown",h,!1)}}var p=o.getSmilBySpineItem(l);if(!p)return void console.error("NO SMIL?? "+l.idref+" /// "+l.media_overlay_id);var g=function(e){if(e){if(e.nodeType&&"seq"===e.nodeType&&e.textref){var t=e.textref.split("#"),r=t[0],i=2===t.length?t[1]:"";if(r&&i){n.ResolveContentRef(r,p.href)===l.href&&(e.element=s[0].contentDocument.getElementById(i),e.element||console.error("seq.textref !element? "+e.textref))}}if(e.children&&e.children.length)for(var o=0;o<e.children.length;o++){var a=e.children[o];g(a)}}};g(p);for(var m=new r(p);m.currentPar;){m.currentPar.element=void 0,m.currentPar.cfi=void 0;if(n.ResolveContentRef(m.currentPar.text.srcFile,m.smil.href)===l.href){
var v=!m.currentPar.text.srcFragmentId||0==m.currentPar.text.srcFragmentId.length,y=0==m.currentPar.text.srcFragmentId.indexOf("epubcfi")?void 0:m.currentPar.text.srcFragmentId,E=void 0,b=!1;if(v||y)E=v?f:e(s[0].contentDocument.getElementById(y));else if(0===m.currentPar.text.srcFragmentId.indexOf("epubcfi")){var I=m.currentPar.text.srcFragmentId.substr("epubcfi".length+1,m.currentPar.text.srcFragmentId.length-"epubcfi".length-2);0===I.indexOf("/99!")&&(I=I.substr("/99!".length,I.length-"/99!".length));var T=I.split(",");if(T&&3===T.length)try{var w=T[0]+T[1],S="epubcfi("+w+")",_=i.getTextTerminusInfoWithPartialCFI(S,s[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),C=T[0]+T[2],O="epubcfi("+C+")",P=(i.getTextTerminusInfoWithPartialCFI(O,s[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),_.textNode.parentNode);m.currentPar.cfi={smilTextSrcCfi:m.currentPar.text.srcFragmentId,partialRangeCfi:I,partialStartCfi:w,partialEndCfi:C,cfiTextParent:P},b=!0,E=e(P);var N=E.data("mediaOverlayData");if(N){N.par&&(console.error("[WARN] non-CFI MO DATA already exists!"),N.par=void 0);var R=!1;if(N.pars)for(var D=0;D<N.pars.length;D++){var x=N.pars[D];x===m.currentPar&&(R=!0,console.error("[WARN] mediaOverlayData CFI PAR already registered!"))}else N.pars=[];R||N.pars.push(m.currentPar)}else N={pars:[m.currentPar]},E.data("mediaOverlayData",N)}catch(e){console.error(e)}else try{var A="epubcfi("+I+")";E=i.getTargetElementWithPartialCFI(A,s[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"])}catch(e){console.error(e)}}else console.error("SMIL text@src CFI fragment identifier scheme not supported: "+m.currentPar.text.srcFragmentId);if(E&&E.length>0){if(!b){m.currentPar.element&&m.currentPar.element!==E[0]&&console.error("DIFFERENT ELEMENTS??! "+m.currentPar.text.srcFragmentId+" /// "+m.currentPar.element.id);var M=E[0].nodeName?E[0].nodeName.toLowerCase():void 0;"audio"!==M&&"video"!==M||E.attr("preload","auto"),m.currentPar.element=E[0];var N=E.data("mediaOverlayData");N&&(console.error("[WARN] MO DATA already exists."),N.par&&N.par!==m.currentPar&&console.error("DIFFERENT PARS??!")),E.data("mediaOverlayData",{par:m.currentPar})}}else console.error("!! CANNOT FIND ELEMENT: "+m.currentPar.text.srcFragmentId+" == "+m.currentPar.text.srcFile+" /// "+l.href)}m.next()}}}}}),define("readium_shared_js/views/audio_player",["jquery"],function(e){return function(t,n,r,i,o){function a(){t({isPlaying:!0}),i()}function s(){o(),t({isPlaying:!1})}function l(){if(y.moSeeking)return void(v&&console.debug("onEnded() skipped (still seeking...)"));c(),r(),t({isPlaying:!1})}function u(){_||(_=setInterval(function(){if(y.moSeeking)return void(++S>1e3&&(S=0,c()));var e=void 0;try{e=y.currentTime}catch(e){console.error(e.message)}e&&n(e,1)},20))}function c(){_&&clearInterval(_),_=void 0}function f(e){v&&console.debug("onReadyToSeek #"+e.data.playId),h(e.data.seekBegin,e.data.playId,!0)}function d(t){e(y).off(D,d),m?(v&&console.debug("onReadyToSeek ANDROID ... waiting a bit ... #"+t.data.playId),N(),setTimeout(function(){f(t)},1e3)):f(t)}function h(t,n,r){if(v&&console.debug("playSeekCurrentTime() #"+n),0==t&&(t=.01),Math.abs(t-y.currentTime)<.3)return v&&console.debug("playSeekCurrentTime() CONTINUE"),y.moSeeking=void 0,void E.play();var i=r?A:M;v&&console.debug("playSeekCurrentTime() NEED SEEK, EV: "+i),E.pause(),e(y).on(i,{newCurrentTime:t,playId:n,isNewSrc:r},p);try{y.currentTime=t}catch(e){console.error(e.message),setTimeout(function(){try{y.currentTime=t}catch(e){console.error(e.message)}},5)}}function p(t){var n=t.data.isNewSrc?A:M,r=void 0==t.data.seekRetries;(r||t.data.seekRetries==x)&&e(y).off(n,p),v&&console.debug("onSeeked() #"+t.data.playId+" FIRST? "+r+" EV: "+n);var i=y.currentTime,o=Math.abs(t.data.newCurrentTime-i);if((r||t.data.seekRetries>=0)&&o>=1)v&&console.debug("onSeeked() time diff: "+t.data.newCurrentTime+" vs. "+i+" ("+o+")"),r&&(t.data.seekRetries=x,t.data.isNewSrc=!1),t.data.seekRetries--,v&&console.debug("onSeeked() FAIL => retry again (timeout)"),setTimeout(function(){p(t)},m?1e3:200),setTimeout(function(){y.pause();try{y.currentTime=t.data.newCurrentTime}catch(e){console.error(e.message),setTimeout(function(){try{y.currentTime=t.data.newCurrentTime}catch(e){console.error(e.message)}},4)}},5);else{if(v&&(console.debug("onSeeked() STATE:"),console.debug(r),console.debug(t.data.seekRetries),console.debug(o)),o>=1){v&&console.debug("onSeeked() ABORT, TRY AGAIN FROM SCRATCH!");var a=I,s=b,l=t.data.newCurrentTime;return E.reset(),void setTimeout(function(){E.playFile(a,s,l)},10)}v&&console.debug("onSeeked() OKAY => play!"),t.data.seekRetries=void 0,E.play(),y.moSeeking=void 0}}var g=!!navigator.userAgent.match(/(iPad|iPhone|iPod)/g),m=navigator.userAgent.toLowerCase().indexOf("android")>-1,v=!1,y=new Audio;v&&(y.addEventListener("load",function(){console.debug("0) load")}),y.addEventListener("loadstart",function(){console.debug("1) loadstart")}),y.addEventListener("durationchange",function(){console.debug("2) durationchange")}),y.addEventListener("loadedmetadata",function(){console.debug("3) loadedmetadata")}),y.addEventListener("loadeddata",function(){console.debug("4) loadeddata")}),y.addEventListener("progress",function(){console.debug("5) progress")}),y.addEventListener("canplay",function(){console.debug("6) canplay")}),y.addEventListener("canplaythrough",function(){console.debug("7) canplaythrough")}),y.addEventListener("play",function(){console.debug("8) play")}),y.addEventListener("pause",function(){console.debug("9) pause")}),y.addEventListener("ended",function(){console.debug("10) ended")}),y.addEventListener("seeked",function(){console.debug("X) seeked")}),y.addEventListener("timeupdate",function(){console.debug("Y) timeupdate")}),y.addEventListener("seeking",function(){console.debug("Z) seeking")}));var E=this,b=void 0,I=void 0;this.currentSmilSrc=function(){return I};var T=1;this.setRate=function(e){T=e,T<.5&&(T=.5),T>4&&(T=4),y.playbackRate=T},E.setRate(T),this.getRate=function(){return T};var w=1;this.setVolume=function(e){w=e,w<0&&(w=0),w>1&&(w=1),y.volume=w},E.setVolume(w),this.getVolume=function(){return w},this.play=function(){return v&&console.error("this.play()"),!!b&&(u(),E.setVolume(w),E.setRate(T),y.play(),!0)},this.pause=function(){v&&console.error("this.pause()"),c(),y.pause()},y.addEventListener("play",a,!1),y.addEventListener("pause",s,!1),y.addEventListener("ended",l,!1);var S=0,_=void 0;this.isPlaying=function(){return void 0!==_},this.reset=function(){v&&console.error("this.reset()"),this.pause(),y.moSeeking=void 0,I=void 0,b=void 0,setTimeout(function(){y.setAttribute("src","")},1)},y.addEventListener("loadstart",function(){C=!0});var C=!1;this.touchInit=function(){return!!g&&(!C&&(C=!0,y.setAttribute("src","touch/init/html5/audio.mp3"),y.load(),!0))};var O=0,P=0;this.playFile=function(t,n,r){++O>99999&&(O=0);var i=O;return y.moSeeking?++P>x?void(P=0):(v&&console.debug("this.playFile("+n+") @"+r+" (POSTPONE, SEEKING...)"),void setTimeout(function(){E.playFile(t,n,r)},20)):(y.moSeeking={},v&&console.debug("this.playFile("+n+") @"+r+" #"+i),b&&b===n?(v&&console.debug("this.playFile() SAME SRC"),this.pause(),I=t,b=n,void h(r,i,!1)):(v&&(console.debug("this.playFile() NEW SRC"),console.debug("_currentEpubSrc: "+b),console.debug("epubSrc: "+n)),this.reset(),y.moSeeking={},I=t,b=n,m||y.addEventListener("play",R,!1),e(y).on(D,{seekBegin:r,playId:i},d),void setTimeout(function(){y.setAttribute("src",b),y.load(),m||N()},1)))};var N=function(){v&&console.debug("playToForcePreload");var e=w;w=0,E.play(),w=e},R=function(){y.removeEventListener("play",R,!1),v&&console.debug("onPlayToForcePreload"),y.pause()},D=m?"canplaythrough":"canplay",x=10,A=g?"canplaythrough":"seeked",M=g?"timeupdate":"seeked"}}),define("readium_shared_js/views/media_overlay_element_highlighter",["jquery","readium_cfi_js"],function(e,t){return function(t){function n(t,n,i){if(u)try{if(u[0].ownerDocument===t[0].ownerDocument)return}catch(e){}$head=e("head",t[0].ownerDocument.documentElement),u=e("<style type='text/css'> </style>"),u.append("."+r+" {");var o="background-color: yellow !important; color: black !important; border-radius: 0.4em;",a=i;if(a){var s=!1;for(var l in a.declarations)a.declarations.hasOwnProperty(l)&&(s=!0,u.append(l+": "+a.declarations[l]+"; "));s||n||u.append(o)}else n||u.append(o);u.append("}"),u.appendTo($head)}this.includeParWhenAdjustingToSeqSyncGranularity=!0;var r="mo-active-default",i=void 0;this.isElementHighlighted=function(e){return i&&e===i};var o=void 0;this.isCfiHighlighted=function(e){return o&&e===o};var a="",s="",l=t,u=void 0;this.reDo=function(){u&&u.remove(),u=void 0;var e=i,t=o,n=a,r=s;i?(this.reset(),this.highlightElement(e,n,r)):o&&(this.reset(),this.highlightCfi(t,n,r))},this.highlightElement=function(t,u,c){if(t&&t!==i){this.reset(),i=t,o=void 0,a=u,s=c;var f=this.adjustParToSeqSyncGranularity(i),d=f.element;s&&""!==s&&e(d.ownerDocument.documentElement).addClass(s);var h=e(d),p=a&&""!==a,g=l.userStyles().findStyle("."+r);n(h,p,g),g||!p?(p&&h.addClass(a),h.addClass(r)):h.addClass(a),(this.includeParWhenAdjustingToSeqSyncGranularity||i!==f)&&e(i.element).addClass("mo-sub-sync")}},this.highlightCfi=function(t,u,c){if(t&&t!==o){this.reset(),i=void 0,o=t,a=u,s=c;var f=e(o.cfi.cfiTextParent),d=a&&""!==a,h=l.userStyles().findStyle("."+r);n(f,d,h);if(l.plugins.highlights)try{var p=t.getSmil().spineItemId;l.plugins.highlights.addHighlight(p,t.cfi.partialRangeCfi,"MO_SPEAK","highlight",void 0)}catch(e){console.error(e)}else if(l.plugins.annotations)try{var p=t.getSmil().spineItemId;l.plugins.annotations.addHighlight(p,t.cfi.partialRangeCfi,"MO_SPEAK","highlight",void 0)}catch(e){console.error(e)}}},this.reset=function(){if(o){var t=o.cfi.cfiTextParent.ownerDocument;if(l.plugins.highlights)try{l.plugins.highlights.removeHighlight("MO_SPEAK");for(var n=void 0;null!==(n=t.getElementById("start-MO_SPEAK"));)console.log("toRemove START"),console.log(n),n.parentNode.removeChild(n);for(;null!==(n=t.getElementById("end-MO_SPEAK"));)console.log("toRemove END"),console.log(n),n.parentNode.removeChild(n)}catch(e){console.error(e)}else if(l.plugins.annotations)try{l.plugins.annotations.removeHighlight("MO_SPEAK");for(var n=void 0;null!==(n=t.getElementById("start-MO_SPEAK"));)console.log("toRemove START"),console.log(n),n.parentNode.removeChild(n);for(;null!==(n=t.getElementById("end-MO_SPEAK"));)console.log("toRemove END"),console.log(n),n.parentNode.removeChild(n)}catch(e){console.error(e)}o=void 0}if(i){var u=this.adjustParToSeqSyncGranularity(i),c=u.element;(this.includeParWhenAdjustingToSeqSyncGranularity||i!==u)&&e(i.element).removeClass("mo-sub-sync"),s&&""!==s&&e(c.ownerDocument.documentElement).removeClass(s),a&&""!==a&&e(c).removeClass(a),e(c).removeClass(r),i=void 0}a="",s=""},this.adjustParToSeqSyncGranularity=function(e){if(e){var t=l.viewerSettings().mediaOverlaysSynchronizationGranularity;if(t&&t.length>0){if(!(e.element||(e.cfi?e.cfi.cfiTextParent:void 0)))return console.error("adjustParToSeqSyncGranularity !element ???"),e;var n=e.getFirstSeqAncestorWithEpubType(t,this.includeParWhenAdjustingToSeqSyncGranularity);if(n&&n.element)return n}return e}}}}),define("readium_shared_js/views/scroll_view",["../globals","jquery","underscore","eventEmitter","../models/bookmark_data","../models/current_pages_info","../helpers","./one_page_view","../models/page_open_request","../models/viewer_settings"],function(e,t,n,r,i,o,a,s,l,u){return function(c,f,d){function h(e,t){if(he)return void e();var n=N();if(!n)return void e();var r=H(0),i=G(n);if(r.top-i.bottom>se){var o=L();S(n),y(o-(i.bottom-i.top),void 0),t("updateLoadedViewsTop 1"),h(e,t)}else r.top-i.top<se?b(n,function(n){n?(t("updateLoadedViewsTop 2"),h(e,t)):e()}):e()}function p(e,t){if(he)return void e();var n=R();if(!n)return void e();var r=H(0),i=G(n);i.top-r.bottom>se?(S(n),t("updateLoadedViewsBottom 1"),p(e,t)):i.bottom-r.bottom<se?T(n,function(n){t("updateLoadedViewsBottom 2"),n?p(e,t):e()}):e()}function g(e){if(f){var t=void 0;if(Q&&e){var n=e.offset();n&&(t=n.top)}var r=function(n){if(Q){if(!t)return;var r=void 0,i=e.offset();if(i&&(r=i.top),!r)return;var o=r-t;Math.abs(o)>1&&console.debug("@@@@@@@@@@@@@@@ SCROLL ADJUST ("+n+") "+o+" -- "+e.currentSpineItem().href)}};pe=!0,p(function(){h(function(){setTimeout(function(){pe=!1},le+100)},r)},r)}}function m(e){d.viewerSettings().mediaOverlaysPreservePlaybackWhenScroll||!ve&&d.isMediaOverlayAvailable()&&(ve=d.isPlayingMediaOverlay())&&d.pauseMediaOverlay()}function v(e){if(!pe&&!ge&&!me){ue.resetCurrentPosition(),g(),F(ue),n.defer(function(){re||ue.saveCurrentPosition()});d.viewerSettings().mediaOverlaysPreservePlaybackWhenScroll||ve&&setTimeout(function(){d.playMediaOverlay(),ve=!1},100)}}function y(e,t){ie[0].scrollTop=e,t&&F(t.initiator,t.spineItem,t.elementId)}function E(e){var t=L(),n=G(e);I(e);var r=G(e),i=r.bottom-r.top,o=n.bottom-n.top,a=i-o;Math.abs(a)>0&&(Q&&console.debug("IMMEDIATE SCROLL ADJUST: "+e.currentSpineItem().href+" == "+a),y(t+a))}function b(e,t){var n=fe.prevItem(e.currentSpineItem(),!0);if(!n)return void t(!1);var r=C(n,!0),i=R();r.element().insertAfter(i.element()),r.loadSpineItem(n,function(i,o,a,s,l){if(i){I(r);var u=G(r);S(r);var c=L(),f=C(n),d=u.bottom-u.top;f.setHeight(d),f.element().insertBefore(e.element()),c+=d,y(c,void 0),f.loadSpineItem(n,function(e,r,i,o,a){e?(E(f),D(f,e,r,i,o,a),t(e)):(console.error("Unable to open 2 "+n.href),S(f),t(!1))})}else console.error("Unable to open 1 "+n.href),S(r),t(!1)})}function I(e){e.currentSpineItem().isFixedLayout()?e.scaleToWidth(ie.width()):e.resizeIFrameToContent()}function T(e,t){var n=fe.nextItem(e.currentSpineItem(),!0);if(!n)return void t(!1);var r=(L(),C(n));r.element().insertAfter(e.element()),r.loadSpineItem(n,function(e,i,o,a,s){e?(I(r),D(r,e,i,o,a,s),t(e)):(console.error("Unable to load "+n.href),t(!1))})}function w(){var e=[];P(function(t){e.push(t)},!1);for(var t=0,n=e.length;t<n;t++)S(e[t])}function S(e){e.onUnload(),e.element().remove()}function _(e){ie.css("left",e.left),ie.css("top",e.top),ie.css("right",e.right),ie.css("bottom",e.bottom)}function C(t,r){function i(){I(a),F(ue),g(),re&&!ne&&ue.restoreCurrentPosition()}c.disablePageTransitions=!0;var o=!0;t.isFixedLayout()&&(o=!1);var a=new s(c,["content-doc-frame"],o,d);a.on(s.Events.SPINE_ITEM_OPEN_START,function(t,n){e.logEvent("OnePageView.Events.SPINE_ITEM_OPEN_START","ON","scroll_view.js [ "+n.href+" ]"),e.logEvent("CONTENT_DOCUMENT_LOAD_START","EMIT","scroll_view.js [ "+n.href+" ]"),ue.emit(e.Events.CONTENT_DOCUMENT_LOAD_START,t,n)}),a.on(e.Events.CONTENT_DOCUMENT_UNLOADED,function(t,n){e.logEvent("CONTENT_DOCUMENT_UNLOADED","ON","scroll_view.js [ "+n.href+" ]"),ue.emit(e.Events.CONTENT_DOCUMENT_UNLOADED,t,n)});var l=n.debounce(i,100);a.on(s.Events.CONTENT_SIZE_CHANGED,function(t,n){e.logEvent("OnePageView.Events.CONTENT_SIZE_CHANGED","ON","scroll_view.js [ "+n.href+" ]"),l()}),a.render();return ye&&a.setViewSettings(ye,!0),r||a.element().data("pageView",a),f&&a.decorateIframe(),a}function O(e,t){var n=void 0;return P(function(t){return t.currentSpineItem()!=e||(n=t,!1)},t),n}function P(e,t){for(var n=ie.children(),r=n.length,i=t?function(e){return e-1}:function(e){return e+1},o=t?function(e){return e>=0}:function(e){return e<r},a=t?r-1:0,s=a;o(s);s=i(s)){var l=n.eq(s),u=l.data("pageView");if(u&&!1===e(u))return}}function N(){var e=void 0;return P(function(t){return e=t,!1},!1),e}function R(){var e=void 0;return P(function(t){return e=t,!1},!0),e}function D(t,n,r,i,o,a){n&&o&&(e.logEvent("CONTENT_DOCUMENT_LOADED","EMIT","scroll_view.js [ "+i.href+" ]"),ue.emit(e.Events.CONTENT_DOCUMENT_LOADED,r,i))}function x(e,t){w();var n=(L(),C(e));ie.append(n.element()),n.loadSpineItem(e,function(e,r,i,o,a){e?(I(n),D(n,e,r,i,o,a)):(console.error("Unable to load "+i.href),S(n),n=void 0),t(n)})}function A(e,t){var n,r,i,o,a=0;if(void 0!==t.scrollTop)a=t.scrollTop;else if(void 0!==t.spineItemPageIndex){var s;n=M(),s=t.spineItemPageIndex<0?0:t.spineItemPageIndex>=n?n-1:t.spineItemPageIndex,a=s*k()}else if(e&&t.elementId){if(o=G(e),i=e.getNavigator(),!(r=i.getElementById(t.elementId))||!r.length)return void console.warn("Element id="+t.elementId+" not found!");if(J(e,r,60))return void F(t.initiator,t.spineItem,t.elementId);var l=Y(e,r);a=l.top+o.top}else if(e&&t.elementCfi){o=G(e),i=e.getNavigator();var u=i.getDomRangeFromRangeCfi(t.elementCfi);if(!u)return void console.warn("Range for cfi="+t.elementCfi+" not found!");var c=K(e,u);if(X(c,60))return void F(t.initiator,t.spineItem,t.elementId);a=c.top}else if(t.firstPage)a=0;else if(t.lastPage){if(0===(n=M()))return;a=V()-k()-5}else e?(o=G(e),a=o.top):a=0;L()!=a?(ge=!0,y(a,t),setTimeout(function(){ge=!1},le+100)):F(t.initiator,t.spineItem,t.elementId)}function M(){return Math.ceil(V()/k())}function F(t,n,r){e.logEvent("InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED","EMIT","scroll_view.js"),ue.emit(e.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:ue.getPaginationInfo(),initiator:t,spineItem:n,elementId:r})}function L(){return ie[0].scrollTop}function j(){return V()-(L()+k())}function k(){return ie.height()}function V(){return ie[0].scrollHeight}function U(){var e=[],t=H(-ae);return P(function(n){if(B(n,t))e.push(n);else if(e.length>0)return!1;return!0},!1),e}function B(e,t){return q(z(G(e),t))>0}function G(e){var t={top:0,bottom:0},n=e.element(),r=n.position();if(ee){var i=n.offsetParent();r.top-=i.scrollTop(),r.left-=i.scrollLeft()}return t.top=r.top+L(),t.bottom=t.top+e.getCalculatedPageHeight(),t}function W(e){var t,n=H(),r=void 0,i={top:0,bottom:0},o=!1;return P(function(a){if(t=G(a),i.top=Math.max(t.top,n.top)-t.top,i.bottom=Math.min(t.bottom,n.bottom)-t.top,q(i)>0){if(o=!0,r=e(a,i))return!1}else if(o)return!1;return!0},!1),r}function H(e){0===e||e||(e=0);var t={top:L()-e,bottom:L()+k()+e};return t.top<0&&(t.top=0),t.bottom>V()&&(t.bottom=V()),t}function z(e,t){return{top:Math.max(e.top,t.top),bottom:Math.min(e.bottom,t.bottom)}}function q(e){return e.bottom<e.top?0:e.bottom-e.top}function J(e,t,n){return X(Y(e,t),n)}function X(e,t){var n=H(),r=Math.min(q(n),q(e));return 0===r&&(r=5),q(z(n,e))/r*100>=t}function Y(e,t){var n=G(e),r={top:0,bottom:0};return r.top=t.offset().top+n.top,r.bottom=r.top+t.height(),r}function K(e,t){var n=G(e),r={top:0,bottom:0},i=t.getBoundingClientRect();return r.top=i.top+n.top,r.bottom=r.top+i.height,r}function $(e){var t,n,r=U(),i=e(r),o=i.element().position().top;t={top:Math.min(0,o),left:0};var a=Math.min(i.element().height(),k());return o>=0&&(a-=o),n={width:i.element().width(),height:a},e([i.getFirstVisibleCfi,i.getLastVisibleCfi])(t,n)}function Z(e,t){return new i(e.idref,t)}var Q=!1,ee=!1;try{var te=t.fn.jquery.split(".");2==parseInt(te[0])&&2==parseInt(te[1])&&0==parseInt(te[2])&&(ee=!0)}catch(e){console.error(e)}t.extend(this,new r);var ne,re,ie,oe,ae=5,se=2e3,le=300,ue=this,ce=t(c.$viewport),fe=c.spine,de=c.userStyles,he=!1,pe=!1,ge=!1,me=!1;this.isContinuousScroll=function(){return f},this.render=function(){var e=a.loadTemplate("scrolled_book_frame",{});oe=t(e),ce.append(oe),ie=t("#scrolled-content-frame",oe),ie.css("overflow",""),ie.css("overflow-y","auto"),ie.css("overflow-x","hidden"),ie.css("-webkit-overflow-scrolling","touch"),ie.css("width","100%"),ie.css("height","100%"),ie.css("position","relative");var r=d.viewerSettings();r&&void 0!==r.enableGPUHardwareAccelerationCSS3D||(r=new u({})),r.enableGPUHardwareAccelerationCSS3D&&ie.css("transform","translateZ(0)"),ue.applyStyles();var i=n.debounce(v,le);return ie.on("scroll",function(e){i(e),m()}),ue};var ve=!1;this.remove=function(){oe.remove()},this.onViewportResize=function(){},this.resetCurrentPosition=function(){re=void 0},this.saveCurrentPosition=function(){if(!ne){var e=ue.getFirstVisibleCfi(),t=fe.getItemById(e.idref);t&&(re=new l(t,ue),re.setElementCfi(e.contentCFI))}},this.restoreCurrentPosition=function(){re&&this.openPageInternal(re)};var ye=void 0;this.setViewSettings=function(e,t){ye=e,P(function(n){n.setViewSettings(e,t)},!1)},this.applyStyles=function(){a.setStyles(de.getStyles(),oe.parent()),_(a.Margins.fromElement(oe).padding)},this.applyBookStyles=function(){P(function(e){e.applyBookStyles()},!1)},this.openPageInternal=function(e){he=!0;var t=function(e,t){ne=void 0,A(e,t),he=!1,g(e)};if(e.spineItem){var n=O(e.spineItem);n?t(n,e):(ne=e,me=!0,x(e.spineItem,function(n){setTimeout(function(){me=!1},le+100),n&&ne?n.currentSpineItem()===ne.spineItem?t(n,ne):ue.openPage(ne):F(e.initiator,e.spineItem,e.elementId)}))}else t(void 0,e)},this.openPage=function(e){this.resetCurrentPosition(),re=e,this.openPageInternal(e)},this.openPageNext=function(e){var t;j()>0&&(t=new l(void 0,e),t.scrollTop=L()+Math.min(j(),k()-ae),A(void 0,t))},this.openPagePrev=function(e){var t;L()>0&&(t=new l(void 0,e),t.scrollTop=L()-(k()-ae),t.scrollTop<0&&(t.scrollTop=0),A(void 0,t))},this.getPaginationInfo=function(){for(var e,t,n,r,i,a,s,l,u=H(),c=u.bottom-u.top,f=new o(fe,!1),d=U(),h=0,p=d.length;h<p;h++)n=d[h],e=n.currentSpineItem(),r=G(n),i=Math.max(u.top-r.top,0),a=Math.max(r.bottom-u.bottom,0),s=Math.ceil(i/c),l=Math.ceil(a/c),t=s+l+1,f.addOpenPage(s,t,e.idref,e.index);return f},this.bookmarkCurrentPage=function(){return ue.getFirstVisibleCfi()},this.getLoadedSpineItems=function(){var e=[];return P(function(t){e.push(t.currentSpineItem())},!1),e},this.getElement=function(e,t){var n=void 0;return P(function(r){return r.currentSpineItem().idref!=e||(n=r.getNavigator().getElement(t),!1)},!1),n},this.getElementById=function(e,t){var n=void 0;return P(function(r){return r.currentSpineItem().idref!=e||(n=r.getNavigator().getElementById(t),!1)},!1),n||void console.error("spine item is not loaded")},this.getElementByCfi=function(e,t,n,r,i){var o=void 0;return P(function(a){return a.currentSpineItem().idref!=e||(o=a.getNavigator().getElementByCfi(t,n,r,i),!1)},!1),o||void console.error("spine item is not loaded")},this.getFirstVisibleMediaOverlayElement=function(){return W(function(e,t){return e.getNavigator().getFirstVisibleMediaOverlayElement(t)})},this.insureElementVisibility=function(e,n,r){var i=void 0;if(P(function(t){return t.currentSpineItem().idref!==e||(i=t,!1)},!1),!i)return void console.warn("Page for element "+n+" not found");var o=t(n),a=Y(i,o);if(!X(a,60)){var s=fe.getItemById(e),u=new l(s,r);u.scrollTop=a.top,ue.openPage(u)}},this.getVisibleElements=function(e,t){var r=[];return P(function(i){t?r.push({elements:i.getVisibleElements(e),spineItem:i.currentSpineItem()}):r=n.flatten([r,i.getVisibleElements(e)],!0)}),r},this.getVisibleElementsWithFilter=function(e){console.warn("getVisibleElementsWithFilter: Not implemented yet for scroll_view")},this.isElementVisible=function(e){console.warn("isElementVisible: Not implemented yet for scroll_view")},this.getElements=function(e,t){var n=O(e);if(n)return n.getElements(e,t)},this.isNodeFromRangeCfiVisible=function(e,t){var n=O(spineIdRef);if(n)return n.isNodeFromRangeCfiVisible(spineIdRef,t)},this.isVisibleSpineItemElementCfi=function(e,t){var n=O(e);if(n)return n.isVisibleSpineItemElementCfi(e,t)},this.getNodeRangeInfoFromCfi=function(e,t){var n=O(e);if(n)return n.isVisibleSpineItemElementCfi(e,t)},this.getFirstVisibleCfi=function(){return $(n.first)},this.getLastVisibleCfi=function(){return $(n.last)},this.getDomRangeFromRangeCfi=function(e,t,n){return t&&e.idref!==t.idref?void console.error("getDomRangeFromRangeCfi: both CFIs must be scoped under the same spineitem idref"):(e=e||{},t=t||{},W(function(r){if(r.currentSpineItem().idref===e.idref)return r.getDomRangeFromRangeCfi(e.contentCFI,t.contentCFI,n)}))},this.getRangeCfiFromDomRange=function(e){return W(function(t){return t.getRangeCfiFromDomRange(e)})},this.getVisibleCfiFromPoint=function(e,t,n){return W(function(r){return Z(r.currentSpineItem(),r.getVisibleCfiFromPoint(e,t,n))})},this.getRangeCfiFromPoints=function(e,t,n,r){return W(function(i){return Z(i.currentSpineItem(),i.getRangeCfiFromPoints(e,t,n,r))})},this.getCfiForElement=function(e){return W(function(t){return Z(t.currentSpineItem(),t.getCfiForElement(e).contentCFI)})},this.getElementFromPoint=function(e,t){return W(function(n){return n.getElementFromPoint(e,t)})},this.getStartCfi=function(){return W(function(e){return e.getStartCfi()})},this.getEndCfi=function(){return W(function(e){return e.getEndCfi()})},this.getNearestCfiFromElement=function(e){return W(function(t){return t.getNearestCfiFromElement(e)})}}}),define("readium_shared_js/views/media_overlay_player",["../globals","jquery","../helpers","./audio_player","./media_overlay_element_highlighter","../models/smil_iterator","readium_cfi_js","./scroll_view"],function(e,t,n,r,i,o,a,s){return function(l,u){function c(e){var t=e.getSmil();if(b&&b.smil==t?b.reset():b=new o(t),b.goToPar(e),!b.currentPar)return void console.error("playPar !_smilIterator.currentPar");d()}function f(){D.resetBlankPage(),L=setTimeout(function(){if(L){if(D.resetBlankPage(),!b||!b.currentPar)return void D.reset();k=0,p(b.currentPar.audio.clipEnd+.1,2)}},2e3),u({isPlaying:!0})}function d(){if(z=!1,!b||!b.currentPar)return void console.error("playCurrentPar !_smilIterator || !_smilIterator.currentPar ???");if(!b.smil.id)return I.reset(),D.resetTTS(),D.resetEmbedded(),void setTimeout(function(){f()},100);if(b.currentPar.audio.src){D.resetTTS(),D.resetEmbedded(),D.resetBlankPage();var e=b.currentPar.audio.clipEnd-b.currentPar.audio.clipBegin;(e<=0||F>e)&&(console.error("### MO XXX PAR OFFSET: "+F+" / "+e),F=0);var r=n.ResolveContentRef(b.currentPar.audio.src,b.smil.href),i=N.resolveRelativeUrlMO(r),o=b.currentPar.audio.clipBegin+F;I.playFile(b.currentPar.audio.src,i,o)}else{F=0,I.reset();var s=b.currentPar.element;if(s){k=0;var l=s.nodeName?s.nodeName.toLowerCase():void 0;"audio"===l||"video"===l?(D.resetTTS(),D.resetBlankPage(),P&&D.resetEmbedded(),P=s,P.pause(),P.currentTime=0,P.play(),t(P).on("ended",D.onEmbeddedEnd),O=!0,setTimeout(function(){u({isPlaying:!0})},80)):(D.resetEmbedded(),D.resetBlankPage(),w=s.textContent,w&&""!=w?G(w):w=void 0)}var c=b.currentPar.cfi;if(c){k=0,D.resetEmbedded(),D.resetBlankPage(),x.reset();var d=c.cfiTextParent.ownerDocument,h="epubcfi("+c.partialStartCfi+")",p=(a.getTextTerminusInfoWithPartialCFI(h,d,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),"epubcfi("+c.partialEndCfi+")");a.getTextTerminusInfoWithPartialCFI(p,d,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);w=void 0,w&&""!=w?G(w):w=void 0}}F=0,E()}function h(e){D.pause();var t=e?N.media_overlay.getNextSmil(b.smil):N.media_overlay.getPreviousSmil(b.smil);if(t){if(b=new o(t),b.currentPar){if(!e)for(;!b.isLast();)b.next();l.openContentUrl(b.currentPar.text.src,b.smil.href,D)}}else console.log("No more SMIL"),D.reset()}function p(e,t,n){if(k=e,j=!1,b&&b.currentPar){var r=b.currentPar,i=b.currentPar.audio;if(!(e>V&&e<=i.clipEnd)){j=!0;var o=I.isPlaying();o&&6===t&&console.debug("from userNav _audioPlayer.isPlaying() ???");var a=e>i.clipEnd,s=!J&&6!==t&&a,l=b&&b.smil&&b.smil.spineItemId?b.smil.spineItemId:M&&M.spineItem&&M.spineItem.idref?M.spineItem.idref:void 0;if(s&&l&&M&&M.paginationInfo&&M.paginationInfo.openPages&&M.paginationInfo.openPages.length>1){l===M.paginationInfo.openPages[0].idref&&(s=!1)}if(a?b.next():b.previous(),!b.currentPar)return void(s?(q=!0,D.reset()):h(a));if(!b.currentPar.audio)return void D.pause();if(R.mediaOverlaysSkipSkippables){for(var u=!1,c=b.currentPar;c;){if(c.isSkippable&&c.isSkippable(R.mediaOverlaysSkippables)){u=!0;break}c=c.parent}if(u){console.log("MO SKIP: "+c.epubtype),D.pause();return void p(a?b.currentPar.audio.clipEnd+.1:V-1,t,!0)}}if(!o&&(b.currentPar.element||b.currentPar.cfi&&b.currentPar.cfi.cfiTextParent)){var f=x.adjustParToSeqSyncGranularity(b.currentPar);if(f&&f!==b.currentPar){var g=x.adjustParToSeqSyncGranularity(r);if(g&&(g===f||!a)){if(g===f){do{a?b.next():b.previous()}while(b.currentPar&&b.currentPar.hasAncestor(g));if(!b.currentPar)return void(s?(q=!0,D.reset()):h(a))}if(!a){var m=x.adjustParToSeqSyncGranularity(b.currentPar);if(m&&m!==b.currentPar){var v=b.currentPar,y=void 0;do{y=b.currentPar,b.previous()}while(b.currentPar&&b.currentPar.hasAncestor(m));b.currentPar?(b.next(),b.currentPar.hasAncestor(m)||console.error("adjustParToSeqSyncGranularity !_smilIterator.currentPar.hasAncestor(landed) ???")):(b.reset(),b.currentPar!==y&&console.error("adjustParToSeqSyncGranularity _smilIterator.currentPar !=== innerPar???")),b.currentPar||(console.error("adjustParToSeqSyncGranularity !_smilIterator.currentPar ?????"),b.goToPar(v))}}}}}if(I.isPlaying()&&b.currentPar.audio.src&&b.currentPar.audio.src==I.currentSmilSrc()&&e>=b.currentPar.audio.clipBegin&&e<=b.currentPar.audio.clipEnd)return void E();d()}}}function g(e){if(!B||B[0].ownerDocument!==e[0].ownerDocument){$head=t("head",e[0].ownerDocument.documentElement),B=t("<style type='text/css'> </style>").appendTo($head),B.append(".tts_on{background-color:red;color:white;} .tts_off{}")}}function m(){v();var e=function(){if(b&&b.currentPar){var e=b.smil;if(e.mo){var t=k-b.currentPar.audio.clipBegin;if(!(t<=0)){for(var n=e.mo.smil_models.indexOf(e),r=new o(e),i=-1;r.currentPar&&(i++,r.currentPar!=b.currentPar);)r.next();u({playPosition:t,smilIndex:n,parIndex:i})}}}};setTimeout(e,500),H=setInterval(e,1500)}function v(){k=0,void 0!==H&&clearInterval(H),H=void 0}function y(){return v(),j?void(j=!1):b&&b.currentPar?void p(b.currentPar.audio.clipEnd+.1,5):void D.reset()}function E(){if(b&&b.currentPar){if(b.currentPar.text.srcFragmentId&&b.currentPar.text.srcFragmentId.length>0){if(b.currentPar.element)return void(x.isElementHighlighted(b.currentPar)||(x.highlightElement(b.currentPar,N.media_overlay.activeClass,N.media_overlay.playbackActiveClass),z||l.insureElementVisibility(b.currentPar.getSmil().spineItemId,b.currentPar.element,D)));if(b.currentPar.cfi)return void(x.isCfiHighlighted(b.currentPar)||(x.highlightCfi(b.currentPar,N.media_overlay.activeClass,N.media_overlay.playbackActiveClass),z||l.insureElementVisibility(b.currentPar.getSmil().spineItemId,b.currentPar.cfi.cfiTextParent,D)))}if(!b.currentPar.element){var e=b.currentPar.text.src,t=b.smil.href;b=void 0,l.openContentUrl(e,t,D)}}}var b=void 0,I=new r(u,p,y,m,v),T=!1,w=void 0,S=void 0!==window.speechSynthesis&&null!=speechSynthesis,_=void 0,C=!1,O=!1,P=void 0;this.isPlaying=function(){return I.isPlaying()||T||O||L};var N=l.package(),R=l.viewerSettings(),D=this,x=new i(l);l.on(e.Events.READER_VIEW_DESTROYED,function(){e.logEvent("READER_VIEW_DESTROYED","ON","media_overlay_player.js"),D.reset()}),this.applyStyles=function(){x.reDo()},this.onSettingsApplied=function(){I.setRate(R.mediaOverlaysRate),I.setVolume(R.mediaOverlaysVolume/100)},D.onSettingsApplied(),l.on(e.Events.SETTINGS_APPLIED,function(){e.logEvent("SETTINGS_APPLIED","ON","media_overlay_player.js"),this.onSettingsApplied()},this);var A=!1;this.onDocLoadStart=function(){D.isPlaying()&&(A=!0,D.pause())};var M=void 0;this.onPageChanged=function(e){M=e;var n=q;q=!1;var r=A;if(A=!1,!e)return void D.reset();var i=void 0;if(e.elementId||e.initiator==D){for(var o=l.getLoadedSpineItems(),a=l.spine().isRightToLeft(),s=a?o.length-1:0;a&&s>=0||!a&&s<o.length;s+=a?-1:1){var u=o[s];if(!e.spineItem||e.spineItem==u){if(e.elementId&&0===e.elementId.indexOf("epubcfi")){x.reset();var f=e.elementId.substr("epubcfi".length+1,e.elementId.length-"epubcfi".length-2);0===f.indexOf("/99!")&&(f=f.substr("/99!".length,f.length-"/99!".length));var h=f.split(",");if(h&&3===h.length)try{var p=h[0]+h[1],g=l.getElementByCfi(u.idref,p,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(i=g&&g.length>0?g[0]:void 0){i.nodeType===Node.TEXT_NODE&&(i=i.parentNode);break}}catch(e){console.error(e)}else try{var g=l.getElementByCfi(u.idref,f,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(i=g&&g.length>0?g[0]:void 0){i.nodeType===Node.TEXT_NODE&&(i=i.parentNode);break}}catch(e){console.error(e)}}if(!i){
if(e.initiator!=D||e.elementId){var g=l.getElementById(u.idref,e.elementId);i=g&&g.length>0?g[0]:void 0}else{var g=l.getElement(u.idref,"body");i=g&&g.length>0?g[0]:void 0}if(i)break}}}i||console.error("paginationData.elementId BUT !element: "+e.elementId)}var m=D.isPlaying()||r;if(!b||!b.currentPar){if(e.initiator!==D)return F=0,D.reset(),void(e.elementId&&i?(m||n)&&(e.elementIdResolved=i,D.toggleMediaOverlayRefresh(e)):(m||n)&&D.toggleMediaOverlay());if(!i)return console.error("!element: "+e.elementId),void(F=0);var v=t(i).data("mediaOverlayData");if(!v)return console.error("!moData: "+e.elementId),void(F=0);var y=v.par?v.par:v.pars[0];if(v.pars)for(var I=0;I<v.pars.length;I++){var T=v.pars[I];if(e.elementId===T.cfi.smilTextSrcCfi){y=T;break}}return void c(y)}var w=!b.currentPar.element&&!b.currentPar.cfi;if(w&&console.error("!! _smilIterator.currentPar.element ??"),e.initiator==D){var S=e.elementId&&e.elementId!==b.currentPar.text.srcFragmentId;if(S&&console.error("!! paginationData.elementId !== _smilIterator.currentPar.text.srcFragmentId"),S||w)return void(F=0);m?E():d()}else{if(!m&&!n)return void D.reset();if(e.elementId,e.elementId&&!i)return;e.elementId&&(e.elementIdResolved=i),D.toggleMediaOverlayRefresh(e)}};var F=0,L=void 0,j=!1,k=0,V=-999;this.touchInit=function(){return I.touchInit()};var U=function(e){var t=["p","div","pagenum","td","table","li","ul","ol"],n=[",",";",".","-","??","??","?","!"],r=function(e,t){if(!(e.word.length<=0)){var n=e.text.length;t.spanMap[n]=e.counter,e.text+=e.word,e.markup+=e.html.substring(0,e.wordStart)+'<span class="tts_off" id="tts_'+e.counter+'">'+e.html.substring(e.wordStart,e.wordEnd)+"</span>"+e.html.substring(e.wordEnd,e.html.length),e.word="",e.html="",e.wordStart=-1,e.wordEnd=-1,e.counter++}},i={element:e,innerHTML_tts:"",spanMap:{},text:"",lastCharIndex:void 0};i.element.innerHTML_original=e.innerHTML;for(var o={inTag:!1,counter:0,wordStart:-1,wordEnd:-1,text:"",markup:"",word:"",html:""},a=i.element.innerHTML_original.length,s=0;s<=a;){if(o.inTag){if(o.html+=i.element.innerHTML_original[s],">"==i.element.innerHTML_original[s]){o.inTag=!1;var l=o.html.match(/<\/(.*?)>$/);l&&t.indexOf(l[1])>-1&&(r(o,i),o.text+=" ")}}else s==a||i.element.innerHTML_original[s].match(/\s/)?(r(o,i),s<a&&(o.text+=i.element.innerHTML_original[s],o.markup+=i.element.innerHTML_original[s])):n.indexOf(i.element.innerHTML_original[s])>-1?(r(o,i),o.wordStart=o.html.length,o.wordEnd=o.html.length+1,o.word+=i.element.innerHTML_original[s],o.html+=i.element.innerHTML_original[s],r(o,i)):"<"==i.element.innerHTML_original[s]?(o.inTag=!0,o.html+=i.element.innerHTML_original[s]):(0==o.word.length&&(o.wordStart=o.html.length),o.wordEnd=o.html.length+1,o.word+=i.element.innerHTML_original[s],o.html+=i.element.innerHTML_original[s]);s++}return i.text=o.text,i.innerHTML_tts=o.markup,i.element.innerHTML=i.innerHTML_tts,i},B=void 0,G=function(n,r){function i(e){e||window.speechSynthesis.pending?(console.debug("TTS cancel before speak"),window.speechSynthesis.cancel(),setTimeout(function(){i(!1)},5)):o()}function o(){_=new SpeechSynthesisUtterance,C&&a&&(_.tokenData=a,_.onboundary=function(e){if(_){console.debug("TTS boundary: "+e.name+" / "+e.charIndex);var t=e.target.tokenData;if(t&&t.spanMap.hasOwnProperty(e.charIndex)){var n;[].forEach.call(t.element.querySelectorAll(".tts_on"),function(e){console.debug("TTS OFF "+e.id),e.className="tts_off"});var n="tts_"+t.spanMap[e.charIndex];console.debug("TTS charIndex ID: "+n);var r=t.element.querySelector("#"+n);r&&(console.debug("TTS ON"),r.className="tts_on"),t.lastCharIndex=e.charIndex}}}),_.onend=function(e){if(_)if(console.debug("TTS ended"),C){var t=e.target.tokenData,n=!e.forceSkipEnd&&_===e.target&&(!t||t.element.innerHTML_original);t&&(t.element.innerHTML_original?t.element.innerHTML=t.element.innerHTML_original:[].forEach.call(t.element.querySelectorAll(".tts_on"),function(e){console.debug("TTS OFF (end)"+e.id),e.className="tts_off"}),t.element.innerHTML_original=void 0),n?D.onTTSEnd():console.debug("TTS end SKIPPED")}else D.onTTSEnd()},_.onerror=function(e){if(_&&(console.error("TTS error"),console.debug(_.text),console.debug(window.speechSynthesis.paused),console.debug(window.speechSynthesis.pending),console.debug(window.speechSynthesis.speaking),C)){var t=e.target.tokenData;t&&(t.element.innerHTML_original?t.element.innerHTML=t.element.innerHTML_original:[].forEach.call(t.element.ownerDocument.querySelectorAll(".tts_on"),function(e){console.debug("TTS OFF (error)"+e.id),e.className="tts_off"}),t.element.innerHTML_original=void 0)}};var e=r||I.getVolume();_.volume=e,_.rate=I.getRate(),_.pitch=1,_.text=f,window.speechSynthesis.speak(_),window.speechSynthesis.paused&&(console.debug("TTS resume"),window.speechSynthesis.resume())}var a=void 0,s=b&&b.currentPar?b.currentPar:void 0,c=s?s.element:void 0;s&&s.cfi;if((!r||r>0)&&(setTimeout(function(){u({isPlaying:!0})},80),T=!0,C&&c)){g(t(c)),c.innerHTML_original&&(c.innerHTML=c.innerHTML_original,c.innerHTML_original=void 0),a=U(c)}if(!S)return e.logEvent("MEDIA_OVERLAY_TTS_SPEAK","EMIT","media_overlay_player.js"),void l.emit(e.Events.MEDIA_OVERLAY_TTS_SPEAK,{tts:n});if(!n&&window.speechSynthesis.paused)return void window.speechSynthesis.resume();var f=n||w;f&&(_&&(C&&(_.onend&&_.onend({forceSkipEnd:!0,target:_}),_.tokenData=void 0,_.onboundary=void 0),_.onend=void 0,_.onerror=void 0,_=void 0),console.debug("paused: "+window.speechSynthesis.paused),console.debug("speaking: "+window.speechSynthesis.speaking),console.debug("pending: "+window.speechSynthesis.pending),i(!0))},W=function(){var t=T;if(t&&u({isPlaying:!1}),T=!1,!S)return void(t&&(e.logEvent("MEDIA_OVERLAY_TTS_STOP","EMIT","media_overlay_player.js"),l.emit(e.Events.MEDIA_OVERLAY_TTS_STOP,void 0)));window.speechSynthesis.pause()},H=void 0;this.onEmbeddedEnd=function(){if(k=0,O=!1,!b||!b.currentPar)return void D.reset();p(b.currentPar.audio.clipEnd+.1,3)},this.onTTSEnd=function(){if(k=0,T=!1,!b||!b.currentPar)return void D.reset();p(b.currentPar.audio.clipEnd+.1,4)},this.escape=function(){if(!b||!b.currentPar)return void this.toggleMediaOverlay();if(!D.isPlaying())return void D.play();if(R.mediaOverlaysEscapeEscapables)for(var e=b.currentPar;e;){if(e.isEscapable&&e.isEscapable(R.mediaOverlaysEscapables)){do{b.next()}while(b.currentPar&&b.currentPar.hasAncestor(e));return b.currentPar?void d():void h(!0)}e=e.parent}this.nextMediaOverlay(!0)},this.playUserPar=function(e){if(D.isPlaying()&&D.pause(),e.element||e.cfi&&e.cfi.cfiTextParent){var t=x.adjustParToSeqSyncGranularity(e);if(t&&t!==e){var n=function(e){if(e.nodeType&&"par"===e.nodeType)return e;if(e.children&&!(e.children.length<=0))for(var t=0;t<e.children.length;t++){var r=e.children[t],i=n(r);if(i)return i}},r=n(t);r&&(e=r)}}c(e)},this.resetTTS=function(){w=void 0,W()},this.resetBlankPage=function(){var e=!1;if(L){e=!0;var t=L;L=void 0,clearTimeout(t)}L=void 0,e&&u({isPlaying:!1})},this.resetEmbedded=function(){var e=O;P&&(t(P).off("ended",D.onEmbeddedEnd),P.pause()),P=void 0,e&&u({isPlaying:!1}),O=!1},this.reset=function(){F=0,I.reset(),D.resetTTS(),D.resetEmbedded(),D.resetBlankPage(),x.reset(),b=void 0,j=!1},this.play=function(){if(b&&b.smil&&!b.smil.id)return void f();if(P)O=!0,P.play(),u({isPlaying:!0});else if(w)G(void 0);else if(!I.play())return console.log("Audio player was dead, reactivating..."),this.reset(),void this.toggleMediaOverlay();E()},this.pause=function(){z=!1,L?this.resetBlankPage():O?(O=!1,P&&P.pause(),u({isPlaying:!1})):T?W():I.pause(),x.reset()},this.isMediaOverlayAvailable=function(){return void 0!==l.getFirstVisibleMediaOverlayElement()},this.nextOrPreviousMediaOverlay=function(e){if(D.isPlaying())D.pause();else if(b&&b.currentPar)return void D.play();if(!b)return void this.toggleMediaOverlay();p(e?V-1:b.currentPar.audio.clipEnd+.1,6)},this.nextMediaOverlay=function(){this.nextOrPreviousMediaOverlay(!1)},this.previousMediaOverlay=function(){this.nextOrPreviousMediaOverlay(!0)},this.mediaOverlaysOpenContentUrl=function(e,t,n){F=n,b=void 0,l.openContentUrl(e,t,D)},this.toggleMediaOverlay=function(){return D.isPlaying()?void D.pause():b?void D.play():void this.toggleMediaOverlayRefresh(void 0)};var z=!1;this.toggleMediaOverlayRefresh=function(e){var n=l.getLoadedSpineItems(),r=l.spine().isRightToLeft(),i=void 0,a=D.isPlaying();if(a&&b){if(e.initiator&&e.initiator instanceof s&&R.mediaOverlaysPreservePlaybackWhenScroll)return void(z=!0);i=b.currentPar,D.pause()}z=!1;var u=e&&e.elementIdResolved?e.elementIdResolved:void 0,c=e&&e.elementId?e.elementId:void 0;if(!u){c&&console.error("[WARN] id did not resolve to element?");for(var f=r?n.length-1:0;r&&f>=0||!r&&f<n.length;f+=r?-1:1){var h=n[f];if(h){if(!e||!e.spineItem||e.spineItem==h){if(c){var p=l.getElementById(h.idref,c);u=p&&p.length>0?p[0]:void 0}else if(h.isFixedLayout()&&e&&e.paginationInfo&&e.paginationInfo.openPages){if(e.paginationInfo.openPages[0]&&e.paginationInfo.openPages[0].idref&&e.paginationInfo.openPages[0].idref===h.idref){var p=l.getElement(h.idref,"body");u=p&&p.length>0?p[0]:void 0}}if(u)break}}else console.error("spineItems[i] is undefined??")}}if(u||(u=l.getFirstVisibleMediaOverlayElement()),!u)return void D.reset();var g=t(u).data("mediaOverlayData");if(!g){for(var m=!1,v=function(e){if(!e)return!1;for(var n=0;n<e.length;n++){if(u===e[n]&&(m=!0),m){var r=t(e[n]).data("mediaOverlayData");if(r)return g=r,!0}if(v(e[n].children))return!0}return!1},y=u;y&&"body"!==y.nodeName.toLowerCase();)y=y.parentNode;if(!y)return void D.reset();v([y])}if(!g)return void D.reset();var E=g.par?g.par:g.pars[0],I=E.getSmil();if(b&&b.smil==I?b.reset():b=new o(I),b.goToPar(E),!b.currentPar&&c&&(b.reset(),b.findTextId(c)),!b.currentPar)return void D.reset();a&&i&&i===b.currentPar?D.play():d()},this.isPlayingCfi=function(){return b&&b.currentPar&&b.currentPar.cfi};var q=!1,J=!0;this.setAutomaticNextSmil=function(e){J=e}}}),define("readium_shared_js/models/spine",["./spine_item","../helpers","URIjs"],function(e,t,n){return function(t,r){function i(e){return!u||"no"!==e.linear}function o(e){return e>=0&&e<l.items.length}function a(e){if(o(e)){var t=l.items[e];return i(t)?t:a(t.index-1)}}function s(e){if(o(e)){var t=l.items[e];return i(t)?t:s(t.index+1)}}var l=this;this.items=[],this.direction="ltr",this.package=t;var u=!1;if(this.handleLinear=function(e){u=e},this.isValidLinearItem=function(e){if(o(e))return i(this.item(e))},this.isRightToLeft=function(){return"rtl"==l.direction},this.isLeftToRight=function(){return!l.isRightToLeft()},this.prevItem=function(e){return a(e.index-1)},this.nextItem=function(e){return s(e.index+1)},this.getItemUrl=function(e){return l.package.resolveRelativeUrl(e.href)},this.first=function(){return s(0)},this.last=function(){return a(this.items.length-1)},this.isFirstItem=function(e){return l.first()===e},this.isLastItem=function(e){return l.last()===e},this.item=function(e){if(o(e))return l.items[e]},this.getItemById=function(e){for(var t=l.items.length,n=0;n<t;n++)if(l.items[n].idref==e)return l.items[n]},this.getItemByHref=function(e){var t=l.package.resolveRelativeUrl(e);t=t.replace("filesystem:chrome-extension://","filesystem-chrome-extension://");for(var r=new n(t).normalizePathname().pathname(),i=l.items.length,o=0;o<i;o++){var a=l.package.resolveRelativeUrl(l.items[o].href);a=a.replace("filesystem:chrome-extension://","filesystem-chrome-extension://");if(r==new n(a).normalizePathname().pathname())return l.items[o]}},r){r.direction&&(this.direction=r.direction);for(var c=r.items.length,f=0;f<c;f++){var d=new e(r.items[f],f,this);this.items.push(d)}!function(){for(var t=l.items.length,n=!1,r=l.isLeftToRight()?e.SPREAD_LEFT:e.SPREAD_RIGHT,i=0;i<t;i++){var o=l.items[i];if(!o.page_spread){var a=o.isRenditionSpreadAllowed()?n?r:e.alternateSpread(r):e.SPREAD_CENTER;o.setSpread(a)}n=!o.isRenditionSpreadAllowed()||o.page_spread!=r}}()}}}),define("readium_shared_js/models/smil_model",["../helpers"],function(e){var t={};t.SmilNode=function(e){this.parent=e,this.id="",this.getSmil=function(){for(var e=this;e.parent;)e=e.parent;return e},this.hasAncestor=function(e){for(var t=this.parent;t;){if(t==e)return!0;t=t.parent}return!1}},t.TimeContainerNode=function(e){this.parent=e,this.children=void 0,this.index=void 0,this.epubtype="",this.isEscapable=function(e){if(""===this.epubtype)return!1;var t=this.getSmil();if(!t.mo)return!1;var n=t.mo.escapables;e.length>0&&(n=e);for(var r=0;r<n.length;r++)if(this.epubtype.indexOf(n[r])>=0)return!0;return!1},this.isSkippable=function(e){if(""===this.epubtype)return!1;var t=this.getSmil();if(!t.mo)return!1;var n=t.mo.skippables;e.length>0&&(n=e);for(var r=0;r<n.length;r++)if(this.epubtype.indexOf(n[r])>=0)return!0;return!1}},t.TimeContainerNode.prototype=new t.SmilNode,t.MediaNode=function(e){this.parent=e,this.src=""},t.MediaNode.prototype=new t.SmilNode,t.SeqNode=function(e){this.parent=e,this.children=[],this.nodeType="seq",this.textref="",this.durationMilliseconds=function(){for(var e=this.getSmil(),t=0,n=0;n<this.children.length;n++){var r=this.children[n];if("par"===r.nodeType){if(!r.audio)continue;if(r.text&&(!r.text.manifestItemId||r.text.manifestItemId!=e.spineItemId))continue;t+=r.audio.clipDurationMilliseconds()}else"seq"===r.nodeType&&(t+=r.durationMilliseconds())}return t},this.clipOffset=function(e,t){for(var n=this.getSmil(),r=0;r<this.children.length;r++){var i=this.children[r];if("par"===i.nodeType){if(i==t)return!0;if(!i.audio)continue;if(i.text&&(!i.text.manifestItemId||i.text.manifestItemId!=n.spineItemId))continue;var o=i.audio.clipDurationMilliseconds();e.offset+=o}else if("seq"===i.nodeType){var a=i.clipOffset(e,t);if(a)return!0}}return!1},this.parallelAt=function(e){for(var t=this.getSmil(),n=0,r=0;r<this.children.length;r++){var i=e-n,o=this.children[r];if("par"===o.nodeType){if(!o.audio)continue;if(o.text&&(!o.text.manifestItemId||o.text.manifestItemId!=t.spineItemId))continue;var a=o.audio.clipDurationMilliseconds();if(a>0&&i<=a)return o;n+=a}else if("seq"===o.nodeType){var s=o.parallelAt(i);if(s)return s;n+=o.durationMilliseconds()}}},this.nthParallel=function(e,t){for(var n=0;n<this.children.length;n++){var r=this.children[n];if("par"===r.nodeType){if(++t.count==e)return r}else if("seq"===r.nodeType){var i=r.nthParallel(e,t);if(i)return i}}}},t.SeqNode.prototype=new t.TimeContainerNode,t.ParNode=function(e){this.parent=e,this.children=[],this.nodeType="par",this.text=void 0,this.audio=void 0,this.element=void 0,this.getFirstSeqAncestorWithEpubType=function(e,t){if(e)for(var n=t?this:this.parent;n;){if(n.epubtype&&n.epubtype.indexOf(e)>=0)return n;n=n.parent}}},t.ParNode.prototype=new t.TimeContainerNode,t.TextNode=function(t){this.parent=t,this.nodeType="text",this.srcFile="",this.srcFragmentId="",this.manifestItemId=void 0,this.updateMediaManifestItemId=function(){var t=this.getSmil();if(t.href&&t.href.length){for(var n=this.srcFile?this.srcFile:this.src,r=e.ResolveContentRef(n,t.href),i=t.mo.package.resolveRelativeUrlMO(r),o=0;o<t.mo.package.spine.items.length;o++){var a=t.mo.package.spine.items[o];if(t.mo.package.resolveRelativeUrl(a.href)===i)return void(this.manifestItemId=a.idref)}console.error("Cannot set the Media ManifestItemId? "+this.src+" && "+t.href)}}},t.TextNode.prototype=new t.MediaNode,t.AudioNode=function(e){this.parent=e,this.nodeType="audio",this.clipBegin=0,this.MAX=1234567890.1,this.clipEnd=this.MAX,this.clipDurationMilliseconds=function(){var e=1e3*this.clipBegin,t=1e3*this.clipEnd;return this.clipEnd>=this.MAX||t<=e?0:t-e}},t.AudioNode.prototype=new t.MediaNode;var n=function(){this.parent=void 0,this.children=[],this.id=void 0,this.href=void 0,this.duration=void 0,this.mo=void 0,this.parallelAt=function(e){return this.children[0].parallelAt(e)},this.nthParallel=function(e){var t={count:-1};return this.children[0].nthParallel(e,t)},this.clipOffset=function(e){var t={offset:0};return this.children[0].clipOffset(t,e)?t.offset:0},this.durationMilliseconds_Calculated=function(){return this.children[0].durationMilliseconds()};var e=[];this.hasSync=function(t){for(var n=0;n<e.length;n++)if(e[n]===t)return!0;return!1},this.addSync=function(t){if(t)for(var n=t.split(" "),r=0;r<n.length;r++){var i=n[r].trim();i.length>0&&!this.hasSync(i)&&e.push(i)}}};return n.fromSmilDTO=function(e,r){r.DEBUG&&console.debug("Media Overlay DTO import...");var i=0,o=function(){for(var e="",t=0;t<i;t++)e+="   ";return e},a=new n;a.id=e.id,a.spineItemId=e.spineItemId,a.href=e.href,a.smilVersion=e.smilVersion,a.duration=e.duration,a.duration&&a.duration.length&&a.duration.length>0&&(console.error("SMIL duration is string, parsing float... ("+a.duration+")"),a.duration=parseFloat(a.duration)),a.mo=r,a.mo.DEBUG&&(console.log("JS MO smilVersion="+a.smilVersion),console.log("JS MO id="+a.id),console.log("JS MO spineItemId="+a.spineItemId),console.log("JS MO href="+a.href),console.log("JS MO duration="+a.duration));var s=function(e,t,n,r){e in t?(e in n||console.debug("property "+e+" not declared in smil node "+n.nodeType),n[e]=t[e],a.mo.DEBUG&&console.log(o()+"JS MO: ["+e+"="+n[e]+"]")):r&&console.log("Required property "+e+" not found in smil node "+t.nodeType)},l=function(e,n){var r;if("seq"==e.nodeType)a.mo.DEBUG&&console.log(o()+"JS MO seq"),r=new t.SeqNode(n),s("textref",e,r,!(!n||!n.parent)),s("id",e,r),s("epubtype",e,r),r.epubtype&&r.getSmil().addSync(r.epubtype),i++,u(e,r),i--;else if("par"==e.nodeType){a.mo.DEBUG&&console.log(o()+"JS MO par"),r=new t.ParNode(n),s("id",e,r),s("epubtype",e,r),r.epubtype&&r.getSmil().addSync(r.epubtype),i++,u(e,r),i--;for(var l=0,c=r.children.length;l<c;l++){var f=r.children[l];"text"==f.nodeType?r.text=f:"audio"==f.nodeType?r.audio=f:console.error("Unexpected smil node type: "+f.nodeType)}if(!r.audio){var d=new t.AudioNode(r);d.clipBegin=0,d.clipEnd=d.MAX,d.src=void 0,r.audio=d}}else if("text"==e.nodeType)a.mo.DEBUG&&console.log(o()+"JS MO text"),r=new t.TextNode(n),s("src",e,r,!0),s("srcFile",e,r,!0),s("srcFragmentId",e,r,!1),s("id",e,r),r.updateMediaManifestItemId();else{if("audio"!=e.nodeType)return void console.error("Unexpected smil node type: "+e.nodeType);a.mo.DEBUG&&console.log(o()+"JS MO audio"),r=new t.AudioNode(n),s("src",e,r,!0),s("id",e,r),s("clipBegin",e,r),r.clipBegin&&r.clipBegin.length&&r.clipBegin.length>0&&(console.error("SMIL clipBegin is string, parsing float... ("+r.clipBegin+")"),r.clipBegin=parseFloat(r.clipBegin)),r.clipBegin<0&&(a.mo.DEBUG&&console.log(o()+"JS MO clipBegin adjusted to ZERO"),r.clipBegin=0),s("clipEnd",e,r),r.clipEnd&&r.clipEnd.length&&r.clipEnd.length>0&&(console.error("SMIL clipEnd is string, parsing float... ("+r.clipEnd+")"),r.clipEnd=parseFloat(r.clipEnd)),r.clipEnd<=r.clipBegin&&(a.mo.DEBUG&&console.log(o()+"JS MO clipEnd adjusted to MAX"),r.clipEnd=r.MAX)}return r},u=function(e,t){for(var n=e.children.length,r=0;r<n;r++){var i=l(e.children[r],t);i.index=r,t.children.push(i)}};return u(e,a),a},n}),define("readium_shared_js/models/media_overlay",["./smil_model"],function(e){var t=function(e){this.package=e,this.parallelAt=function(e){for(var t=0,n=0;n<this.smil_models.length;n++){var r=this.smil_models[n],i=e-t,o=r.parallelAt(i);if(o)return o;t+=r.durationMilliseconds_Calculated()}},this.percentToPosition=function(e,t,n,r){(e<0||e>100)&&(e=0);var i=this.durationMilliseconds_Calculated(),o=i*(e/100);if(n.par=this.parallelAt(o),n.par){var a=n.par.getSmil();if(a){for(var s=0,l=0;l<this.smil_models.length&&(t.smilData=this.smil_models[l],t.smilData!=a);l++)s+=t.smilData.durationMilliseconds_Calculated();r.milliseconds=o-(s+t.smilData.clipOffset(n.par))}}},this.durationMilliseconds_Calculated=function(){for(var e=0,t=0;t<this.smil_models.length;t++){e+=this.smil_models[t].durationMilliseconds_Calculated()}return e},this.smilAt=function(e){if(!(e<0||e>=this.smil_models.length))return this.smil_models[e]},this.positionToPercent=function(e,t,n){if(e>=this.smil_models.length)return-1;for(var r=0,i=0;i<e;i++){r+=this.smil_models[i].durationMilliseconds_Calculated()}var o=this.smil_models[e],a=o.nthParallel(t);return a?(r+o.clipOffset(a)+n)/this.durationMilliseconds_Calculated()*100:-1},this.smil_models=[],this.skippables=[],this.escapables=[],this.duration=void 0,this.narrator=void 0,this.activeClass=void 0,this.playbackActiveClass=void 0,this.DEBUG=!1,this.getSmilBySpineItem=function(e){if(e)for(var t=0,n=this.smil_models.length;t<n;t++){var r=this.smil_models[t];if(r.spineItemId===e.idref)return e.media_overlay_id!==r.id&&console.error("SMIL INCORRECT ID?? "+e.media_overlay_id+" /// "+r.id),r}},this.getNextSmil=function(e){var t=this.smil_models.indexOf(e);if(-1!=t&&t!=this.smil_models.length-1)return this.smil_models[t+1]},this.getPreviousSmil=function(e){var t=this.smil_models.indexOf(e);if(-1!=t&&0!=t)return this.smil_models[t-1]}};return t.fromDTO=function(n,r){var i=new t(r);if(!n)return i;i.duration=n.duration,i.duration&&i.duration.length&&i.duration.length>0&&(console.error("SMIL total duration is string, parsing float... ("+i.duration+")"),i.duration=parseFloat(i.duration)),i.DEBUG&&console.debug("Media Overlay Duration (TOTAL): "+i.duration),i.narrator=n.narrator,i.DEBUG&&console.debug("Media Overlay Narrator: "+i.narrator),i.activeClass=n.activeClass,i.DEBUG&&console.debug("Media Overlay Active-Class: "+i.activeClass),i.playbackActiveClass=n.playbackActiveClass,i.DEBUG&&console.debug("Media Overlay Playback-Active-Class: "+i.playbackActiveClass);var o=n.smil_models.length;i.DEBUG&&console.debug("Media Overlay SMIL count: "+o);for(var a=0;a<o;a++){var s=e.fromSmilDTO(n.smil_models[a],i);i.smil_models.push(s),i.DEBUG&&console.debug("Media Overlay Duration (SPINE ITEM): "+s.duration)}o=n.skippables.length,i.DEBUG&&console.debug("Media Overlay SKIPPABLES count: "+o);for(var a=0;a<o;a++)i.skippables.push(n.skippables[a]);o=n.escapables.length,i.DEBUG&&console.debug("Media Overlay ESCAPABLES count: "+o);for(var a=0;a<o;a++)i.escapables.push(n.escapables[a]);return i},t}),define("readium_shared_js/models/package_data",[],function(){return{rootUrl:"",rootUrlMO:"",rendering_layout:"",spine:{direction:"ltr",items:[{href:"",idref:"",page_spread:"",rendering_layout:""}]}}}),define("readium_shared_js/models/package",["../helpers","./spine_item","./spine","./media_overlay","./package_data","URIjs"],function(e,t,n,r,i,o){return function(i){var a=this;this.spine=void 0,this.rootUrl=void 0,this.rootUrlMO=void 0,this.media_overlay=void 0,this.rendition_viewport=void 0,this.rendition_flow=void 0,this.rendition_layout=void 0,this.rendition_spread=void 0,this.rendition_orientation=void 0,this.resolveRelativeUrlMO=function(t){var n=void 0;try{n=new o(t)}catch(e){console.error(e),console.log(t)}if(n&&n.is("absolute"))return t;if(a.rootUrlMO&&a.rootUrlMO.length>0){var r=a.rootUrlMO;try{r=new o(r).search("").hash("").toString()}catch(e){console.error(e),console.log(r)}return e.EndsWith(r,"/")?r+t:r+"/"+t}return a.resolveRelativeUrl(t)},this.resolveRelativeUrl=function(t){var n=void 0;try{n=new o(t)}catch(e){console.error(e),console.log(t)}if(n&&n.is("absolute"))return t;if(a.rootUrl){var r=a.rootUrl;try{r=new o(r).search("").hash("").toString()}catch(e){console.error(e),console.log(r)}return e.EndsWith(r,"/")?r+t:r+"/"+t}return t},this.isFixedLayout=function(){return a.rendition_layout===t.RENDITION_LAYOUT_PREPAGINATED},this.isReflowable=function(){return!a.isFixedLayout()},i&&(this.rootUrl=i.rootUrl,this.rootUrlMO=i.rootUrlMO,this.rendition_viewport=i.rendition_viewport,this.rendition_layout=i.rendition_layout,this.rendition_flow=i.rendition_flow,this.rendition_orientation=i.rendition_orientation,this.rendition_spread=i.rendition_spread,this.spine=new n(this,i.spine),this.media_overlay=r.fromDTO(i.media_overlay,this))}}),define("readium_shared_js/models/metadata",[],function(){return function(e){this.identifier=void 0,this.title=void 0,this.author=void 0,this.description=void 0,this.publisher=void 0,this.language=void 0,this.rights=void 0,this.modifiedDate=void 0,this.publishedDate=void 0,this.epubVersion=void 0,e&&(this.identifier=e.id,this.title=e.title,this.author=e.author,this.description=e.description,this.language=e.language,this.publisher=e.publisher,this.rights=e.rights,this.modifiedDate=e.modified_date,this.publishedDate=e.pubdate,this.epubVersion=e.epub_version)}}),define("readium_shared_js/views/reflowable_view",["../globals","jquery","underscore","eventEmitter","../models/bookmark_data","./cfi_navigation_logic","../models/current_pages_info","../helpers","../models/page_open_request","../models/viewer_settings","ResizeSensor"],function(e,t,n,r,i,o,a,s,l,u,c){return function(f,d){function h(e){L.css("left",e.left+"px"),L.css("top",e.top+"px"),L.css("right",e.right+"px"),L.css("bottom",e.bottom+"px")}function p(){return{width:V[0].clientWidth,height:V[0].clientHeight}}function g(){return se.rightToLeft&&!se.isVerticalWritingMode?-se.pageOffset:se.pageOffset}function m(){var e=g();return se.isVerticalWritingMode?{top:e,left:0}:{top:0,left:e}}function v(){L&&L.remove();var e=s.loadTemplate("reflowable_book_page_frame",{}),n=t(e);n=k.append(n),L=t("#reflowable-content-frame",n),V=t("#epubContentIframe",n),V.css("left",""),V.css("right",""),V.css("position","relative"),V.css("overflow","hidden"),j=new o({$iframe:V,frameDimensionsGetter:p,paginationInfo:se,paginationOffsetsGetter:m,classBlacklist:te,elementBlacklist:ne,idBlacklist:re})}function y(t){if(M!=t){v(),M&&(e.logEvent("CONTENT_DOCUMENT_UNLOADED","EMIT","reflowable_view.js [ "+M.href+" ]"),z.emit(e.Events.CONTENT_DOCUMENT_UNLOADED,V,M)),z.resetCurrentPosition(),se.pageOffset=0,se.currentSpreadIndex=0,se.currentPageIndex=0,M=t,M.paginationInfo=se,$=!0;var n=J.package.resolveRelativeUrl(t.href);e.logEvent("CONTENT_DOCUMENT_LOAD_START","EMIT","reflowable_view.js [ "+t.href+" -- "+n+" ]"),z.emit(e.Events.CONTENT_DOCUMENT_LOAD_START,V,t),V.css("opacity","0.01"),K.loadIframe(V[0],n,I,z,{spineItem:t})}}function E(){if(U){var e=Q,t=!d.fonts||!d.fonts.length||e<=0||e-1>=d.fonts.length,n=t?{}:d.fonts[e-1];s.UpdateHtmlFontAttributes(U,Z,n,function(){z.applyStyles()})}}function b(){U&&U.css("column-gap",se.columnGap+"px")}function I(n){if($=!1,F&&F.spineItem!=M)return void y(F.spineItem);if(!n)return V.css("opacity","1"),void(F=void 0);e.logEvent("CONTENT_DOCUMENT_LOADED","EMIT","reflowable_view.js [ "+M.href+" ]"),z.emit(e.Events.CONTENT_DOCUMENT_LOADED,V,M);var r=V[0].contentDocument;U=t("html",r),B=t("body",U),G=!1,W=!0,H=void 0;var i=V[0].contentDocument.defaultView||V[0].contentWindow,o=i.getComputedStyle(B[0],null);if(o){W="ltr"===o.direction;var a=void 0;a=o.getPropertyValue?o.getPropertyValue("-webkit-writing-mode")||o.getPropertyValue("-moz-writing-mode")||o.getPropertyValue("-ms-writing-mode")||o.getPropertyValue("-o-writing-mode")||o.getPropertyValue("-epub-writing-mode")||o.getPropertyValue("writing-mode"):o.webkitWritingMode||o.mozWritingMode||o.msWritingMode||o.oWritingMode||o.epubWritingMode||o.writingMode,a&&(H=a.indexOf("-lr")>=0,(a.indexOf("vertical")>=0||a.indexOf("tb-")>=0||a.indexOf("bt-")>=0)&&(G=!0))}W&&("rtl"!==B[0].getAttribute("dir")&&"rtl"!==U[0].getAttribute("dir")||(W=!1)),J.isLeftToRight()||!W||G||(B[0].setAttribute("dir","rtl"),W=!1,H=!1),se.isVerticalWritingMode=G,N(),V.css("opacity","1"),_(),U.css("height",oe.height+"px"),U.css("position","relative"),U.css("margin","0"),U.css("padding","0"),U.css("column-axis",G?"vertical":"horizontal"),z.applyBookStyles(),x(),b(),E()}function T(){if(F){var e=F;F=void 0,z.openPage(e)}}function w(e){if($)return F=e,!1;if(e.spineItem&&e.spineItem!=M)return F=e,y(e.spineItem),!0;var t=void 0;if(void 0!==e.spineItemPageIndex)t=e.spineItemPageIndex;else if(e.elementId)t=se.currentPageIndex+j.getPageIndexDeltaForElementId(e.elementId);else if(e.firstVisibleCfi&&e.lastVisibleCfi){var n,r;try{n=j.getPageIndexDeltaForCfi(e.firstVisibleCfi,te,ne,re)}catch(e){n=0,console.error(e)}try{r=j.getPageIndexDeltaForCfi(e.lastVisibleCfi,te,ne,re)}catch(e){r=0,console.error(e)}t=se.currentPageIndex+Math.round((n+r)/2)}else if(e.elementCfi)try{t=se.currentPageIndex+j.getPageIndexDeltaForCfi(e.elementCfi,te,ne,re)}catch(e){t=0,console.error(e)}else e.firstPage?t=0:e.lastPage?t=se.columnCount-1:(console.debug("No criteria in pageRequest"),t=0);return(t<0||t>se.columnCount)&&(console.log("Illegal pageIndex value: ",t,"column count is ",se.columnCount),t=t<0?0:se.columnCount),se.currentPageIndex=t,se.currentSpreadIndex=Math.floor(t/se.visibleColumnCount),ue(e.initiator,e.spineItem,e.elementId),!0}function S(){var e=-se.pageOffset+"px";if(G)U.css("top",e);else{var t=W||H;U.css("left",t?e:""),U.css("right",t?"":e)}R()}function _(){var e=L.width();e-=e%2;var t=L.height();return(oe.width!==e||oe.height!==t)&&(oe.width=e,oe.height=t,!0)}function C(t,r,i){se.currentPageIndex=se.currentSpreadIndex*se.visibleColumnCount,se.pageOffset=(se.columnWidth+se.columnGap)*se.visibleColumnCount*se.currentSpreadIndex,S(),n.defer(function(){void 0==ee&&z.saveCurrentPosition(),e.logEvent("InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED","EMIT","reflowable_view.js"),z.emit(e.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:z.getPaginationInfo(),initiator:t,spineItem:r,elementId:i})})}function O(){var e=se.columnMaxWidth,t=se.columnMinWidth,n=s.deduceSyntheticSpread(q,M,le),r=!1===n||!0===n;if(0===n&&(n=1),se.visibleColumnCount=n?2:1,G&&(e*=2,n=!1,r=!0,se.visibleColumnCount=1),U){N();var i=parseInt(q.css("border-left-width")),o=se.columnGap/2;o=Math.max(0,o-i);var a=parseInt(q.css("border-right-width")),l=se.columnGap/2;l=Math.max(0,l-a);var u=q.width(),c=u-o-l;n&&(c=.5*(c-se.columnGap));var f=0;if(c>e){var d=c-e;f=Math.floor(d*(n?1:.5))}else!r&&c<t&&n&&(n=!1,se.visibleColumnCount=1,(c=u-o-l)>e&&(f=Math.floor(.5*(c-e))));k.css({left:f+o+"px",right:f+l+"px"}),_();var h=k.width();n&&(h=(h-se.columnGap)/2),h=Math.floor(h),h-1>e&&console.debug("resultingColumnWidth > MAXW ! "+h+" > "+e),V.css("width",oe.width+"px"),V.css("height",oe.height+"px"),U.css("height",oe.height+"px"),U.css("min-height",oe.height+"px"),U.css("max-height",oe.height+"px"),U.css("margin",0),U.css("padding",0),U.css("border",0),B.css("position","relative"),B.css("margin",0),B.css("padding",0),se.rightToLeft=J.isRightToLeft(),se.columnWidth=Math.round(((G?oe.height:oe.width)-se.columnGap*(se.visibleColumnCount-1))/se.visibleColumnCount);se.visibleColumnCount>1?(U.css("width",oe.width+"px"),U.css("column-width","auto"),U.css("column-count",se.visibleColumnCount)):(U.css("width",(G?oe.width:se.columnWidth)+"px"),U.css("column-count","auto"),U.css("column-width",se.columnWidth+"px")),U.css("column-fill","auto"),U.css({left:"0",right:"0",top:"0"}),s.triggerLayout(V);var p=G?U[0].scrollHeight:U[0].scrollWidth;0==p&&console.error("Document dimensions zero?!"),se.columnCount=(p+se.columnGap)/(se.columnWidth+se.columnGap),se.columnCount=Math.round(se.columnCount),0==se.columnCount&&console.error("Column count zero?!");var g=(se.columnCount-1)*se.columnGap,m=(p-g)/se.columnCount;m=Math.round(m),m>se.columnWidth&&(console.debug("ADJUST COLUMN"),console.log(se.columnWidth),console.log(m),se.columnWidth=m),se.spreadCount=Math.ceil(se.columnCount/se.visibleColumnCount),se.currentSpreadIndex>=se.spreadCount&&(se.currentSpreadIndex=se.spreadCount-1),F?T():ee?(se.currentPageIndex=0,z.restoreCurrentPosition()):ue(z,M),P()}}function P(){var e=B[0];e.resizeSensor||(ae.width=t(e).width(),ae.height=t(e).height(),e.resizeSensor=new c(e,function(){var n={width:t(e).width(),height:t(e).height()};console.debug("ReflowableView content resized ...",n.width,n.height,M.idref),n.width!=ae.width||n.height!=ae.height?(ae.width=n.width,ae.height=n.height,console.debug("... updating pagination."),ce()):console.debug("... ignored (identical dimensions).")}))}function N(){-1==ie&&(ie=U[0].style.opacity,U.css("opacity","0"))}function R(){-1!=ie&&U.css("opacity",ie),ie=-1}function D(){for(var e=[],t=se.currentSpreadIndex*se.visibleColumnCount,n=0;n<se.visibleColumnCount&&t+n<se.columnCount;n++)e.push(t+n);return e}function x(){if(U){var e
;t("img, svg",U).each(function(){e=t(this),e.css("max-width","98%"),e.css("max-height","98%"),e.css("height")||e.css("height","auto"),e.css("width")||e.css("width","auto")})}}function A(e){return new i(M.idref,e)}t.extend(this,new r);var M,F,L,j,k,V,U,B,G,W,H,z=this,q=t(f.$viewport),J=f.spine,X=f.userStyles,Y=f.bookStyles,K=f.iframeLoader,$=!1,Z=100,Q=0,ee=void 0,te=["cfi-marker","mo-cfi-highlight","resize-sensor","resize-sensor-expand","resize-sensor-shrink","resize-sensor-inner","js-hypothesis-config","js-hypothesis-embed"],ne=["hypothesis-adder"],re=["MathJax_Message","MathJax_SVG_Hidden"],ie=-1,oe={width:void 0,height:void 0},ae={width:void 0,height:void 0},se={visibleColumnCount:2,columnGap:20,columnMaxWidth:550,columnMinWidth:400,spreadCount:0,currentSpreadIndex:0,currentPageIndex:0,columnWidth:void 0,pageOffset:0,columnCount:0};this.render=function(){var e=s.loadTemplate("reflowable_book_frame",{});k=t(e),q.append(k);var n=d.viewerSettings();return n&&void 0!==n.enableGPUHardwareAccelerationCSS3D||(n=new u({})),n.enableGPUHardwareAccelerationCSS3D&&k.css("transform","translateZ(0)"),v(),z},this.remove=function(){k.remove()},this.isReflowable=function(){return!0},this.onViewportResize=function(){_()&&ce()};var le=void 0;this.setViewSettings=function(e,t){le=e,se.columnGap=e.columnGap,se.columnMaxWidth=e.columnMaxWidth,se.columnMinWidth=e.columnMinWidth,Z=e.fontSize,Q=e.fontSelection,_(),t||(b(),E())},this.applyStyles=function(){s.setStyles(X.getStyles(),k.parent()),h(s.Margins.fromElement(k).padding),_(),ce()},this.applyBookStyles=function(){U&&s.setStyles(Y.getStyles(),V[0].contentDocument)},this.openPage=function(e){w(e),ee=e},this.resetCurrentPosition=function(){ee=void 0},this.saveCurrentPosition=function(){if(!F){var e=z.getFirstVisibleCfi(),t=z.getLastVisibleCfi();ee=new l(M,z),ee.setFirstAndLastVisibleCfi(e.contentCFI,t.contentCFI)}},this.restoreCurrentPosition=function(){ee&&w(ee)};var ue=n.debounce(C,100);this.openPagePrev=function(e){if(M)if(se.currentSpreadIndex>0)this.resetCurrentPosition(),se.currentSpreadIndex--,ue(e,M);else{var t=J.prevItem(M,!0);if(t){var n=new l(t,e);n.setLastPage(),z.openPage(n)}}},this.openPageNext=function(e){if(M)if(se.currentSpreadIndex<se.spreadCount-1)this.resetCurrentPosition(),se.currentSpreadIndex++,ue(e,M);else{var t=J.nextItem(M,!0);if(t){var n=new l(t,e);n.setFirstPage(),z.openPage(n)}}};var ce=n.debounce(O,100);this.getPaginationInfo=function(){var e=new a(J,!1);if(!M)return e;for(var t=D(),n=0,r=t.length;n<r;n++)e.addOpenPage(t[n],se.columnCount,M.idref,M.index);return e},this.bookmarkCurrentPage=function(){if(M)return z.getFirstVisibleCfi()},this.getLoadedSpineItems=function(){return[M]},this.getElementByCfi=function(e,t,n,r,i){return e!=M.idref?void console.warn("spine item is not loaded"):j.getElementByCfi(t,n,r,i)},this.getElementById=function(e,t){return e!=M.idref?void console.error("spine item is not loaded"):j.getElementById(t)},this.getElement=function(e,t){return e!=M.idref?void console.warn("spine item is not loaded"):j.getElement(t)},this.getFirstVisibleMediaOverlayElement=function(){return j.getFirstVisibleMediaOverlayElement()},this.insureElementVisibility=function(e,n,r){var i=t(n);if(!j.isElementVisible(i)){var o=j.getCfiForElement(n);if(o){var a=new l(M,r);a.setElementCfi(o);var s=n.id;s||(s=n.getAttribute("id")),s&&a.setElementId(s),z.openPage(a)}}},this.getVisibleElementsWithFilter=function(e,t){var n=j.getVisibleElementsWithFilter(null,e);return t?[{elements:n,spineItem:M}]:n},this.getVisibleElements=function(e,t){var n=j.getAllVisibleElementsWithSelector(e);return t?[{elements:n,spineItem:M}]:n},this.isElementVisible=function(e){return j.isElementVisible(e)},this.getElements=function(e,t){return e!=M.idref?void console.warn("spine item is not loaded"):j.getElements(t)},this.isNodeFromRangeCfiVisible=function(e,t){if(M.idref===e)return j.isNodeFromRangeCfiVisible(t)},this.isVisibleSpineItemElementCfi=function(e,t){if(j.isRangeCfi(t))return this.isNodeFromRangeCfiVisible(e,t);var n=this.getElementByCfi(e,t);return n&&this.isElementVisible(n)},this.getNodeRangeInfoFromCfi=function(e,t){return e!=M.idref?void console.warn("spine item is not loaded"):j.getNodeRangeInfoFromCfi(t)},this.getFirstVisibleCfi=function(){return A(j.getFirstVisibleCfi())},this.getLastVisibleCfi=function(){return A(j.getLastVisibleCfi())},this.getStartCfi=function(){return A(j.getStartCfi())},this.getEndCfi=function(){return A(j.getEndCfi())},this.getDomRangeFromRangeCfi=function(e,t,n){return t&&e.idref!==t.idref?void console.error("getDomRangeFromRangeCfi: both CFIs must be scoped under the same spineitem idref"):j.getDomRangeFromRangeCfi(e.contentCFI,t?t.contentCFI:null,n)},this.getRangeCfiFromDomRange=function(e){return A(j.getRangeCfiFromDomRange(e))},this.getVisibleCfiFromPoint=function(e,t,n){return A(j.getVisibleCfiFromPoint(e,t,n))},this.getRangeCfiFromPoints=function(e,t,n,r){return A(j.getRangeCfiFromPoints(e,t,n,r))},this.getCfiForElement=function(e){return A(j.getCfiForElement(e))},this.getElementFromPoint=function(e,t){return j.getElementFromPoint(e,t)},this.getNearestCfiFromElement=function(e){return A(j.getNearestCfiFromElement(e))}}}),define("readium_shared_js/models/style",[],function(){return function(e,t){this.selector=e,this.declarations=t,this.setDeclarations=function(e){for(var t in e)e.hasOwnProperty(t)&&(this.declarations[t]=e[t])}}}),define("readium_shared_js/models/style_collection",["./style"],function(e){return function(){var t=[];this.clear=function(){t.length=0},this.findStyle=function(e){for(var n=t.length,r=0;r<n;r++)if(t[r].selector===e)return t[r]},this.addStyle=function(n,r){var i=this.findStyle(n);return i?i.setDeclarations(r):(i=new e(n,r),t.push(i)),i},this.removeStyle=function(e){for(var n=t.length,r=0;r<n;r++)if(t[r].selector===e)return void t.splice(r,1)},this.getStyles=function(){return t},this.resetStyleValues=function(){for(var e=t.length,n=0;n<e;n++){var r=t[n],i=r.declarations;for(var o in i)i.hasOwnProperty(o)&&(i[o]="")}}}}),define("readium_shared_js/models/switches",["jquery","underscore"],function(e,t){var n=function(){};return n.apply=function(n){function r(e){var n=e.attributes["required-namespace"];if(!n)return console.log("Encountered a case statement with no required-namespace"),!1;var r=["http://www.w3.org/1998/Math/MathML"];return t.include(r,n.value)}var i=window.navigator.userAgent.indexOf("Trident")>0||window.navigator.userAgent.indexOf("Edge")>0?function(e){return"epub\\:"+e}:function(e){return e};t.each(n.querySelectorAll(i("switch")),function(n){var o=!1;t.each(n.querySelectorAll(i("case")),function(t){!o&&r(t)?o=!0:e(t).remove()}),o&&t.each(n.querySelectorAll(i("default")),function(t){e(t).remove()})})},n}),define("readium_shared_js/models/trigger",["jquery","../helpers"],function(e,t){var n=function(t){var n=e(t);this.action=n.attr("action"),this.ref=n.attr("ref"),this.event=n.attr("ev:event"),this.observer=n.attr("ev:observer"),this.ref=n.attr("ref")};return n.register=function(t){e("trigger",t).each(function(){new n(this).subscribe(t)})},n.prototype.subscribe=function(t){var n="#"+this.observer,r=this;e(n,t).on(this.event,function(){return r.execute(t)})},n.prototype.execute=function(n){var r=e("#"+t.escapeJQuerySelector(this.ref),n);switch(this.action){case"show":r.css("visibility","visible");break;case"hide":r.css("visibility","hidden");break;case"play":r[0].currentTime=0,r[0].play();break;case"pause":r[0].pause();break;case"resume":r[0].play();break;case"mute":r[0].muted=!0;break;case"unmute":r[0].muted=!1;break;default:return console.log("do not no how to handle trigger "+this.action),null}return!1},n}),define("readium_shared_js/models/node_range_info",[],function(){var e=function(e,t){this.node=e,this.offset=t};return function(t,n,r){var i=this;this.clientRect=t,this.startInfo=n,this.endInfo=r,this.setStartInfo=function(t){return i.startInfo=new e(t),i},this.setEndInfo=function(t){return i.endInfo=new e(t),i}}}),define("readium_shared_js/views/external_agent_support",["../globals","underscore"],function(e,t){return function(n){function r(e,t,n){var r=e.createElement("meta");r.setAttribute("name",t),r.setAttribute("content",n),e.head.appendChild(r)}function i(e,t){var i=n.metadata().identifier,o=t.idref;i&&o&&(r(e,"dc.relation.ispartof",i),r(e,"dc.identifier",o))}function o(e){if(-1!==Object.keys(e).indexOf("document")&&e.location.search.match(/goto=.*cfi/i))return e.location.href.split("#")[0]}function a(e){var t=e.defaultView;if(t&&(t.parent||t.top)){var n=o(t.parent);return o(t.top)||n}}function s(e,t){if(e.defaultView&&e.defaultView.parent){var n=a(e);if(n){var r=e.createElement("link");r.setAttribute("rel","canonical"),r.setAttribute("href",n),e.head.appendChild(r),c[t.idref].canonicalLinkElement=r}}}function l(e){e.addEventListener("scrolltorange",function(e){e.preventDefault();var t=e.detail;d(t)})}function u(e){e.addEventListener("selectionchange",function(){var t=e.getSelection();t&&t.isCollapsed?e.body.style.position="relative":e.body.style.position=""})}var c={},f={};e.on(e.Events.PLUGINS_LOADED,function(){window.define&&window.define.amd&&delete window.define.amd});var d=t.debounce(function(e){var t=n.getRangeCfiFromDomRange(e),r=c[t.idref];r&&r.isUpdated?n.openSpineItemElementCfi(t.idref,t.contentCFI):r.pendingNavRequest={idref:t.idref,contentCFI:t.contentCFI}},100);this.bindToContentDocument=function(e,t){f[t.idref]=e,c[t.idref]={},i(e,t),s(e,t),l(e),t.isReflowable()&&u(e)},this.updateContentDocument=function(e){var t=f[e.idref],r=c[e.idref];if(t&&r){if(r.canonicalLinkElement){var i=a(t);i&&r.canonicalLinkElement.setAttribute("href",i)}r.isUpdated=!0;var o=r.pendingNavRequest;o&&(n.openSpineItemElementCfi(o.idref,o.contentCFI),r.pendingNavRequest=null)}}}}),define("readium_shared_js/views/reader_view",["../globals","jquery","underscore","eventEmitter","./fixed_view","../helpers","./iframe_loader","./internal_links_support","./media_overlay_data_injector","./media_overlay_player","../models/package","../models/metadata","../models/page_open_request","./reflowable_view","./scroll_view","../models/style_collection","../models/switches","../models/trigger","../models/viewer_settings","../models/bookmark_data","../models/node_range_info","./external_agent_support"],function(e,t,n,r,i,o,a,s,l,u,c,f,d,h,p,g,m,v,y,E,b,I){var T=function(w){function S(e){return"scroll-doc"==W.scroll?T.VIEW_TYPE_SCROLLED_DOC:"scroll-continuous"==W.scroll?T.VIEW_TYPE_SCROLLED_CONTINUOUS:e.isFixedLayout()?T.VIEW_TYPE_FIXED:e.isFlowScrolledDoc()?T.VIEW_TYPE_SCROLLED_DOC:e.isFlowScrolledContinuous()?T.VIEW_TYPE_SCROLLED_CONTINUOUS:T.VIEW_TYPE_COLUMNIZED}function _(t,r){var i=S(t);if(V){if(k.getCurrentViewType()==i)return void r(!1);C()}var a={$viewport:j,spine:G,userStyles:H,bookStyles:z,iframeLoader:L};V=k.createViewForType(i,a),e.logEvent("READER_VIEW_CREATED","EMIT","reader_view.js"),k.emit(e.Events.READER_VIEW_CREATED,i),V.on(e.Events.CONTENT_DOCUMENT_LOADED,function(t,n){var r=t[0].contentDocument;e.logEvent("CONTENT_DOCUMENT_LOADED","ON","reader_view.js (current view) [ "+n.href+" ]"),o.isIframeAlive(t[0])&&(F.attachMediaOverlayData(t,n,W),q.processLinkElements(t,n),J.bindToContentDocument(r,n),v.register(r),m.apply(r),e.logEvent("CONTENT_DOCUMENT_LOADED","EMIT","reader_view.js [ "+n.href+" ]"),k.emit(e.Events.CONTENT_DOCUMENT_LOADED,t,n))}),V.on(e.Events.CONTENT_DOCUMENT_LOAD_START,function(t,n){e.logEvent("CONTENT_DOCUMENT_LOAD_START","EMIT","reader_view.js [ "+n.href+" ]"),k.emit(e.Events.CONTENT_DOCUMENT_LOAD_START,t,n)}),V.on(e.Events.CONTENT_DOCUMENT_UNLOADED,function(t,n){e.logEvent("CONTENT_DOCUMENT_UNLOADED","EMIT","reader_view.js [ "+n.href+" ]"),k.emit(e.Events.CONTENT_DOCUMENT_UNLOADED,t,n)}),V.on(e.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,function(t){e.logEvent("InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED","ON","reader_view.js"),M.onPageChanged(t),n.defer(function(){e.logEvent("PAGINATION_CHANGED","EMIT","reader_view.js"),k.emit(e.Events.PAGINATION_CHANGED,t),t.spineItem&&n.defer(function(){J.updateContentDocument(t.spineItem)})})}),V.on(e.Events.FXL_VIEW_RESIZED,function(){e.logEvent("FXL_VIEW_RESIZED","EMIT","reader_view.js"),k.emit(e.Events.FXL_VIEW_RESIZED)}),V.render();V.setViewSettings(W,!0),setTimeout(function(){r(!0)},50)}function C(){V&&(e.logEvent("READER_VIEW_DESTROYED","EMIT","reader_view.js"),k.emit(e.Events.READER_VIEW_DESTROYED),e.logEvent("InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED","OFF","reader_view.js"),V.off(e.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED),V.remove(),V=void 0)}function O(t){e.logEvent("MEDIA_OVERLAY_STATUS_CHANGED","EMIT","reader_view.js (via MediaOverlayPlayer + AudioPlayer)"),k.emit(e.Events.MEDIA_OVERLAY_STATUS_CHANGED,t)}function P(e){if(!e)return void console.log("idref parameter value missing!");var t=G.getItemById(e);return t||void console.log("Spine item with id "+e+" not found!")}function N(e,t){_(e.spineItem,function(n){if(!n){V.setViewSettings(W,!0)}V.openPage(e,t)})}function R(e){o.setStyles(H.getStyles(),j),M&&M.applyStyles(),e||V&&V.applyStyles()}function D(){Y=null,K=!1,V&&(V.isReflowable&&V.isReflowable()&&(K=k.isPlayingMediaOverlay())&&k.pauseMediaOverlay(),Y=V.bookmarkCurrentPage())}function x(){V&&k.handleViewportResize(Y)}function A(){x(),K&&k.playMediaOverlay()}t.extend(this,new r);var M,F,L,j,k=this,V=void 0,U=void 0,B=void 0,G=void 0,W=new y({}),H=new g,z=new g,q=new s(this),J=new I(this),X=o.extendedThrottle(D,x,A,250,1e3,k);t(window).on("resize.ReadiumSDK.readerView",X),this.fonts=w.fonts,w.el instanceof t?(j=w.el,console.log("** EL is a jQuery selector:"+w.el.attr("id"))):(j=t(w.el),console.log("** EL is a string:"+j.attr("id"))),L=w.iframeLoader?w.iframeLoader:new a({mathJaxUrl:w.mathJaxUrl}),_needsFixedLayoutScalerWorkAround=w.needsFixedLayoutScalerWorkAround,this.needsFixedLayoutScalerWorkAround=function(){return _needsFixedLayoutScalerWorkAround},this.createViewForType=function(e,t){var n;switch(j.css("overflow","hidden"),e){case T.VIEW_TYPE_FIXED:j.css("overflow","auto"),n=new i(t,k);break;case T.VIEW_TYPE_SCROLLED_DOC:n=new p(t,!1,k);break;case T.VIEW_TYPE_SCROLLED_CONTINUOUS:n=new p(t,!0,k);break;default:n=new h(t,k)}return n},this.getCurrentViewType=function(){if(V)return V instanceof h?T.VIEW_TYPE_COLUMNIZED:V instanceof i?T.VIEW_TYPE_FIXED:V instanceof p?V.isContinuousScroll()?T.VIEW_TYPE_SCROLLED_CONTINUOUS:T.VIEW_TYPE_SCROLLED_DOC:void console.error("Unrecognized view type")},this.getCurrentView=function(){return V},this.getLoadedSpineItems=function(){return V?V.getLoadedSpineItems():[]},this.viewerSettings=function(){return W},this.package=function(){return U},this.metadata=function(){return B},this.spine=function(){return G},this.userStyles=function(){return H},this.openBook=function(e){var n=e.package?e.package:e;U=new c(n),B=new f(n.metadata),G=U.spine,G.handleLinear(!0),M&&M.reset(),M=new u(k,t.proxy(O,k)),M.setAutomaticNextSmil(!!W.mediaOverlaysAutomaticPageTurn),F=new l(U.media_overlay,M),C(),e.settings&&k.updateSettings(e.settings),e.styles&&k.setStyles(e.styles);var r=void 0;e.openPageRequest&&"function"==typeof e.openPageRequest&&(e.openPageRequest=e.openPageRequest()),e.openPageRequest&&(e.openPageRequest.idref||e.openPageRequest.contentRefUrl&&e.openPageRequest.sourceFileHref?r=e.openPageRequest:console.log("Invalid page request data: idref required!"));var i=!1;if(r){r=e.openPageRequest;try{i=r.idref?r.spineItemPageIndex?!k.openSpineItemPage(r.idref,r.spineItemPageIndex,k):r.elementCfi?!k.openSpineItemElementCfi(r.idref,r.elementCfi,k):!k.openSpineItemPage(r.idref,0,k):!k.openContentUrl(r.contentRefUrl,r.sourceFileHref,k)}catch(e){console.error("openPageRequest fail: fallback to first page!"),console.log(e),i=!0}}else i=!0;if(i){var o=G.first();if(o){var a=new d(o,k);a.setFirstPage(),N(a,0)}}},this.openPageLeft=function(){U.spine.isLeftToRight()?k.openPagePrev():k.openPageNext()},this.openPageRight=function(){U.spine.isLeftToRight()?k.openPageNext():k.openPagePrev()},this.isCurrentViewFixedLayout=function(){return V instanceof i},this.setZoom=function(e){k.isCurrentViewFixedLayout()&&V.setZoom(e)},this.getViewScale=function(){return k.isCurrentViewFixedLayout()?100*V.getViewScale():100},this.updateSettings=function(t){if(W.update(t),M&&M.setAutomaticNextSmil(!!W.mediaOverlaysAutomaticPageTurn),V&&!t.doNotUpdateView){var n=V.bookmarkCurrentPage();if(n&&n.idref){var r=!1;V.isReflowable&&V.isReflowable()&&(r=k.isPlayingMediaOverlay())&&k.pauseMediaOverlay();return void _(G.getItemById(n.idref),function(t){if(!t){V.setViewSettings(W,!1)}k.once(ReadiumSDK.Events.PAGINATION_CHANGED,function(e){var t=new E(n.idref,n.contentCFI);k.debugBookmarkData(t)}),k.openSpineItemElementCfi(n.idref,n.contentCFI,k),r&&k.playMediaOverlay(),e.logEvent("SETTINGS_APPLIED 1 (view update)","EMIT","reader_view.js"),k.emit(e.Events.SETTINGS_APPLIED)})}}e.logEvent("SETTINGS_APPLIED 2 (no view update)","EMIT","reader_view.js"),k.emit(e.Events.SETTINGS_APPLIED)},this.openPageNext=function(){if(k.getCurrentViewType()===T.VIEW_TYPE_SCROLLED_CONTINUOUS)return void V.openPageNext(k);var e=V.getPaginationInfo();if(0!=e.openPages.length){var t=e.openPages[e.openPages.length-1];if(t.spineItemPageIndex<t.spineItemPageCount-1)return void V.openPageNext(k);var n=G.getItemById(t.idref),r=G.nextItem(n);if(r){var i=new d(r,k);i.setFirstPage(),N(i,2)}}},this.openPagePrev=function(){if(k.getCurrentViewType()===T.VIEW_TYPE_SCROLLED_CONTINUOUS)return void V.openPagePrev(k);var e=V.getPaginationInfo();if(0!=e.openPages.length){var t=e.openPages[0];if(t.spineItemPageIndex>0)return void V.openPagePrev(k);var n=G.getItemById(t.idref),r=G.prevItem(n);if(r){var i=new d(r,k);i.setLastPage(),N(i,1)}}},this.openSpineItemElementCfi=function(e,t,n){var r=P(e);if(!r)return!1;var i=new d(r,n);return t&&i.setElementCfi(t),N(i,0),!0},this.openPageIndex=function(e,t){if(!V)return!1;var n;if(U.isFixedLayout()){var r=G.items[e];if(!r)return!1;n=new d(r,t),n.setPageIndex(0)}else{var i=this.getLoadedSpineItems();i.length>0&&(n=new d(i[0],t),n.setPageIndex(e))}return N(n,0),!0},this.openSpineItemPage=function(e,t,n){var r=P(e);if(!r)return!1;var i=new d(r,n);return t&&i.setPageIndex(t),N(i,0),!0},this.setStyles=function(e,t){for(var n=e.length,r=0;r<n;r++)e[r].declarations?H.addStyle(e[r].selector,e[r].declarations):H.removeStyle(e[r].selector);R(t)},this.setBookStyles=function(e){for(var t=e.length,n=0;n<t;n++)e[n].declarations?z.addStyle(e[n].selector,e[n].declarations):z.removeStyle(e[n].selector);V&&V.applyBookStyles()},this.getElement=function(e,t){if(V)return V.getElement(e,t)},this.getElementById=function(e,t){if(V)return V.getElementById(e,t)},this.getElementByCfi=function(e,t,n,r,i){if(V)return V.getElementByCfi(e,t,n,r,i)},this.mediaOverlaysOpenContentUrl=function(e,t,n){M.mediaOverlaysOpenContentUrl(e,t,n)},this.openContentUrl=function(e,t,n){var r,i,a=o.ResolveContentRef(e,t),s=a.indexOf("#");s>=0?(r=a.substr(0,s),i=a.substr(s+1)):(r=a,i=void 0);var l=G.getItemByHref(r);if(!l){console.warn("spineItem "+r+" not found");var u=decodeURIComponent(r);if(!(l=G.getItemByHref(u)))return console.warn("decoded spineItem "+u+" missing as well"),!1}return k.openSpineItemElementId(l.idref,i,n)},this.openSpineItemElementId=function(e,t,n){var r=G.getItemById(e);if(!r)return!1;var i=new d(r,n);return t&&i.setElementId(t),N(i,0),!0},this.debugBookmarkData=function(e){if(ReadiumSDK){var t=this.getPaginationInfo();if(console.log(JSON.stringify(t)),!t.isFixedLayout){try{ReadiumSDK._DEBUG_CfiNavigationLogic.clearDebugOverlays()}catch(e){}try{console.log(e);var n=this.getDomRangeFromRangeCfi(e);console.log(n);var r=ReadiumSDK._DEBUG_CfiNavigationLogic.drawDebugOverlayFromDomRange(n);console.log(r);var i=ReadiumSDK.reader.getFirstVisibleCfi();console.log(i);var o=ReadiumSDK.reader.getLastVisibleCfi();console.log(o)}catch(e){}setTimeout(function(){try{ReadiumSDK._DEBUG_CfiNavigationLogic.clearDebugOverlays()}catch(e){}},2e3)}}},this.bookmarkCurrentPage=function(){var e=V.bookmarkCurrentPage();return e?e.toString():null},this.clearStyles=function(){H.resetStyleValues(),R(),H.clear()},this.clearBookStyles=function(){V&&(z.resetStyleValues(),V.applyBookStyles()),z.clear()},this.isMediaOverlayAvailable=function(){return!!M&&M.isMediaOverlayAvailable()},this.toggleMediaOverlay=function(){M.toggleMediaOverlay()},this.nextMediaOverlay=function(){M.nextMediaOverlay()},this.previousMediaOverlay=function(){M.previousMediaOverlay()},this.escapeMediaOverlay=function(){M.escape()},this.ttsEndedMediaOverlay=function(){M.onTTSEnd()},this.pauseMediaOverlay=function(){M.pause()},this.playMediaOverlay=function(){M.play()},this.isPlayingMediaOverlay=function(){return M.isPlaying()},this.getFirstVisibleMediaOverlayElement=function(){if(V)return V.getFirstVisibleMediaOverlayElement()},this.insureElementVisibility=function(e,t,n){V&&V.insureElementVisibility(e,t,n)};var Y=null,K=!1;this.handleViewportResize=function(e){V&&V.onViewportResize()},this.addIFrameEventListener=function(e,t,n){L.addIFrameEventListener(e,t,n)};var $=function(n){var r={},i=!1,o=void 0;this.setCallback_PlayPause=function(e){o=e};var a=void 0;this.setCallback_IsAvailable=function(e){a=e},this.playPause=function(e){s(e)};var s=function(e){o&&o(e);try{var n=void 0;for(var i in r)if(r.hasOwnProperty(i)){var a=r[i];if(a&&a.active&&(n&&console.error("More than one active iframe?? (pagination)"),n=a.$iframe)){var s=t("audio",n[0].contentDocument);t.each(s,function(){var t=this.getAttribute("epub:type")||this.getAttribute("type");return!t||(t.indexOf("ibooks:soundtrack")<0&&t.indexOf("media:soundtrack")<0&&t.indexOf("media:background")<0||(e&&this.play?this.play():this.pause&&this.pause(),!0))})}}}catch(e){console.error(e)}};this.setPlayState=function(e){i=e},n.on(e.Events.CONTENT_DOCUMENT_LOADED,function(t,n){e.logEvent("CONTENT_DOCUMENT_LOADED","ON","reader_view.js (via BackgroundAudioTrackManager) [ "+n.href+" ]");try{n&&n.idref&&t&&t[0]&&(r[n.idref]={$iframe:t,href:n.href})}catch(e){console.error(e)}}),n.on(e.Events.PAGINATION_CHANGED,function(n){e.logEvent("PAGINATION_CHANGED","ON","reader_view.js (via BackgroundAudioTrackManager)");var o=!1;try{for(var l in r)if(r.hasOwnProperty(l)){var u=n.spineItem&&n.spineItem.idref===l,c=!1;if(n.paginationInfo&&n.paginationInfo.openPages.length){for(var f=!0,d=0;d<n.paginationInfo.openPages.length;d++)n.paginationInfo.openPages[d].idref===l?c=!0:f=!1;!u&&f&&(u=!0)}if(u||c){var h=r[l];if(!h)continue;r[l].active=u;var p=h.$iframe,g=(h.href,t("audio",p[0].contentDocument));t.each(g,function(){var e=this.getAttribute("epub:type")||this.getAttribute("type");return!e||(e.indexOf("ibooks:soundtrack")<0&&e.indexOf("media:soundtrack")<0&&e.indexOf("media:background")<0||(this.setAttribute("loop","loop"),this.removeAttribute("autoplay"),u||this.pause&&this.pause(),o=!0,!0))})}else r[l]&&(r[l].$iframe=void 0),r[l]=void 0}}catch(e){console.error(e)}a&&a(o),s(o?i?!0:!1:!1)}),n.on(e.Events.MEDIA_OVERLAY_STATUS_CHANGED,function(t){if(e.logEvent("MEDIA_OVERLAY_STATUS_CHANGED","ON","reader_view.js (via BackgroundAudioTrackManager)"),t.smilIndex){var o=n.package(),a=o.media_overlay.smilAt(t.smilIndex);if(a&&a.spineItemId){var l=!1;for(var u in r)if(r.hasOwnProperty(u)){var c=r[u];c&&c.active&&u!==a.spineItemId&&(s(!1),c.active=!1,l=!0)}if(l){for(var u in r)if(r.hasOwnProperty(u)){var c=r[u];c&&(c.active||u===a.spineItemId&&(c.active=!0))}i&&s(!0)}}}})};this.backgroundAudioTrackManager=new $(k),this.isVisibleSpineItemElementCfi=function(e,t){if(!P(e))return!1;if(V){if(!t||t&&""===t)for(var n=V.getLoadedSpineItems(),r=0,i=n.length;r<i;r++)if(n[r].idref==e)return!0;return V.isVisibleSpineItemElementCfi(e,t)}return!1},this.getElements=function(e,t){if(V)return V.getElements(e,t)},this.isElementVisible=function(e){return V.isElementVisible(t(e))},this.getNodeRangeInfoFromCfi=function(e,t){if(V&&e&&t){var n=V.getNodeRangeInfoFromCfi(e,t);if(n)return new b(n.clientRect).setStartInfo(n.startInfo).setEndInfo(n.endInfo)}},this.getPaginationInfo=function(){return V.getPaginationInfo()},this.getFirstVisibleCfi=function(){if(V)return V.getFirstVisibleCfi()},this.getLastVisibleCfi=function(){if(V)return V.getLastVisibleCfi()},this.getStartCfi=function(){if(V)return V.getStartCfi()},this.getEndCfi=function(){if(V)return V.getEndCfi()},this.getDomRangesFromRangeCfi=function(e,t,n){if(V)return V.getDomRangesFromRangeCfi?V.getDomRangesFromRangeCfi(e,t,n):[V.getDomRangeFromRangeCfi(e,t,n)]},this.getDomRangesFromRangeCfi=function(e,t,n){if(V)return V.getDomRangesFromRangeCfi?V.getDomRangesFromRangeCfi(e,t,n):[V.getDomRangeFromRangeCfi(e,t,n)]},this.getDomRangeFromRangeCfi=function(e,t,n){if(V)return V.getDomRangeFromRangeCfi(e,t,n)},this.getRangeCfiFromDomRange=function(e){if(V)return V.getRangeCfiFromDomRange(e)},this.getVisibleCfiFromPoint=function(e,t,n,r){if(V)return V.getVisibleCfiFromPoint(e,t,n,r)},this.getRangeCfiFromPoints=function(e,t,n,r,i){if(V)return V.getRangeCfiFromPoints(e,t,n,r,i)},this.getCfiForElement=function(e){if(V)return V.getCfiForElement(e)},this.getNearestCfiFromElement=function(e){if(V)return V.getNearestCfiFromElement(e)}};return T.VIEW_TYPE_COLUMNIZED=1,T.VIEW_TYPE_FIXED=2,T.VIEW_TYPE_SCROLLED_DOC=3,T.VIEW_TYPE_SCROLLED_CONTINUOUS=4,T}),define("readium-shared-js",function(){}),require(["readium_shared_js/globalsSetup"]);
//# sourceMappingURL=readium-shared-js.js.map